<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .test-section {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        .test-section.error {
            border-left-color: #f44336;
        }
        .status {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .warning { color: #ff9800; }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 14px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        .summary {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Process.env ä¿®å¤æœ€ç»ˆéªŒè¯</h1>
        <p>éªŒè¯æ‰€æœ‰ <code>process.env</code> åˆ° <code>import.meta.env</code> çš„ä¿®å¤æ˜¯å¦æˆåŠŸ</p>
        
        <div class="test-section">
            <h3>ğŸ“‹ 1. ç¯å¢ƒå˜é‡ç³»ç»Ÿæ£€æŸ¥</h3>
            <div id="env-system-check" class="status">æ£€æŸ¥ä¸­...</div>
        </div>

        <div class="test-section">
            <h3>ğŸš€ 2. iFlytekæœåŠ¡å®ä¾‹éªŒè¯</h3>
            <div id="service-instance-check" class="status">æ£€æŸ¥ä¸­...</div>
        </div>

        <div class="test-section">
            <h3>âš™ï¸ 3. æœåŠ¡é…ç½®éªŒè¯</h3>
            <div id="service-config-check" class="status">æ£€æŸ¥ä¸­...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ” 4. APIè°ƒç”¨æ¨¡æ‹Ÿæµ‹è¯•</h3>
            <div id="api-call-test" class="status">æ£€æŸ¥ä¸­...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š 5. æ§åˆ¶å°é”™è¯¯ç›‘æ§</h3>
            <div id="console-monitor" class="status">ç›‘æ§ä¸­...</div>
        </div>

        <div class="summary">
            <h3>ğŸ“ˆ æ€»ä½“çŠ¶æ€</h3>
            <div id="overall-status" class="status">è¯„ä¼°ä¸­...</div>
        </div>

        <button onclick="runAllTests()">ğŸ”„ é‡æ–°è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    </div>

    <script type="module">
        let testResults = {
            envSystem: false,
            serviceInstance: false,
            serviceConfig: false,
            apiCall: false,
            consoleClean: true
        };

        let errorCount = 0;
        const errors = [];

        // ç›‘æ§æ§åˆ¶å°é”™è¯¯
        const originalError = console.error;
        console.error = function(...args) {
            errorCount++;
            errors.push(args.join(' '));
            testResults.consoleClean = false;
            updateConsoleMonitor();
            originalError.apply(console, args);
        };

        function updateConsoleMonitor() {
            const monitorDiv = document.getElementById('console-monitor');
            if (errorCount === 0) {
                monitorDiv.innerHTML = '<span class="success">âœ… æ— æ§åˆ¶å°é”™è¯¯</span>';
            } else {
                monitorDiv.innerHTML = `
                    <span class="error">âŒ æ£€æµ‹åˆ° ${errorCount} ä¸ªé”™è¯¯</span>
                    <pre>æœ€æ–°é”™è¯¯:\n${errors.slice(-3).join('\n')}</pre>
                `;
            }
        }

        // 1. ç¯å¢ƒå˜é‡ç³»ç»Ÿæ£€æŸ¥
        async function checkEnvironmentSystem() {
            const envDiv = document.getElementById('env-system-check');
            
            try {
                // æ£€æŸ¥ import.meta æ˜¯å¦å¯ç”¨
                if (typeof import.meta === 'undefined') {
                    throw new Error('import.meta ä¸å¯ç”¨');
                }

                // æ£€æŸ¥ import.meta.env æ˜¯å¦å¯ç”¨
                if (typeof import.meta.env === 'undefined') {
                    throw new Error('import.meta.env ä¸å¯ç”¨');
                }

                const env = import.meta.env;
                const envKeys = Object.keys(env);
                const vueAppKeys = envKeys.filter(key => key.startsWith('VUE_APP_'));

                envDiv.innerHTML = `
                    <span class="success">âœ… ç¯å¢ƒå˜é‡ç³»ç»Ÿæ­£å¸¸</span>
                    <pre>æ€»ç¯å¢ƒå˜é‡: ${envKeys.length}
VUE_APP_* å˜é‡: ${vueAppKeys.length}
æ¨¡å¼: ${env.MODE || 'undefined'}
å¼€å‘æ¨¡å¼: ${env.DEV || 'undefined'}</pre>
                `;
                
                testResults.envSystem = true;
            } catch (error) {
                envDiv.innerHTML = `
                    <span class="error">âŒ ç¯å¢ƒå˜é‡ç³»ç»Ÿå¼‚å¸¸</span>
                    <pre>${error.message}</pre>
                `;
                testResults.envSystem = false;
            }
        }

        // 2. iFlytekæœåŠ¡å®ä¾‹éªŒè¯
        async function checkServiceInstance() {
            const serviceDiv = document.getElementById('service-instance-check');
            
            try {
                serviceDiv.innerHTML = '<span class="info">ğŸ”„ æ­£åœ¨å¯¼å…¥æœåŠ¡...</span>';
                
                // ä½¿ç”¨æ­£ç¡®çš„å¯¼å…¥è·¯å¾„
                const module = await import('/src/services/enhancedIflytekSparkService.js');
                
                const serviceInstance = module.default;
                const ServiceClass = module.EnhancedIflytekSparkService;
                
                if (!serviceInstance) {
                    throw new Error('é»˜è®¤å¯¼å‡ºçš„æœåŠ¡å®ä¾‹ä¸ºç©º');
                }

                if (!ServiceClass) {
                    throw new Error('æœåŠ¡ç±»å¯¼å‡ºå¤±è´¥');
                }

                serviceDiv.innerHTML = `
                    <span class="success">âœ… æœåŠ¡å¯¼å…¥æˆåŠŸ</span>
                    <pre>é»˜è®¤å®ä¾‹: âœ… å¯ç”¨
æœåŠ¡ç±»: âœ… å¯ç”¨
å®ä¾‹ç±»å‹: ${serviceInstance.constructor.name}
ç±»åç§°: ${ServiceClass.name}</pre>
                `;
                
                testResults.serviceInstance = true;
                return serviceInstance;
            } catch (error) {
                serviceDiv.innerHTML = `
                    <span class="error">âŒ æœåŠ¡å¯¼å…¥å¤±è´¥</span>
                    <pre>${error.message}
${error.stack}</pre>
                `;
                testResults.serviceInstance = false;
                return null;
            }
        }

        // 3. æœåŠ¡é…ç½®éªŒè¯
        async function checkServiceConfig(serviceInstance) {
            const configDiv = document.getElementById('service-config-check');
            
            try {
                if (!serviceInstance) {
                    throw new Error('æœåŠ¡å®ä¾‹ä¸å¯ç”¨');
                }

                const config = serviceInstance.config;
                if (!config) {
                    throw new Error('æœåŠ¡é…ç½®ä¸å­˜åœ¨');
                }

                // æ£€æŸ¥å…³é”®é…ç½®é¡¹
                const requiredConfigs = ['baseUrl', 'appId', 'apiKey', 'apiSecret'];
                const configStatus = {};
                
                requiredConfigs.forEach(key => {
                    configStatus[key] = config[key] ? 'âœ…' : 'âŒ';
                });

                configDiv.innerHTML = `
                    <span class="success">âœ… æœåŠ¡é…ç½®éªŒè¯å®Œæˆ</span>
                    <pre>API URL: ${configStatus.baseUrl} ${config.baseUrl || 'undefined'}
App ID: ${configStatus.appId} ${config.appId || 'undefined'}
API Key: ${configStatus.apiKey} ${config.apiKey ? 'å·²é…ç½®' : 'undefined'}
API Secret: ${configStatus.apiSecret} ${config.apiSecret ? 'å·²é…ç½®' : 'undefined'}
æ¨¡æ‹Ÿæ¨¡å¼: ${config.appId === 'simulation_mode' ? 'æ˜¯' : 'å¦'}</pre>
                `;
                
                testResults.serviceConfig = true;
            } catch (error) {
                configDiv.innerHTML = `
                    <span class="error">âŒ æœåŠ¡é…ç½®éªŒè¯å¤±è´¥</span>
                    <pre>${error.message}</pre>
                `;
                testResults.serviceConfig = false;
            }
        }

        // 4. APIè°ƒç”¨æ¨¡æ‹Ÿæµ‹è¯•
        async function testApiCall(serviceInstance) {
            const apiDiv = document.getElementById('api-call-test');
            
            try {
                if (!serviceInstance) {
                    throw new Error('æœåŠ¡å®ä¾‹ä¸å¯ç”¨');
                }

                apiDiv.innerHTML = '<span class="info">ğŸ”„ æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...</span>';

                // æ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„APIè°ƒç”¨
                const testRequest = {
                    action: 'test_connection',
                    data: { test: true }
                };

                // è¿™é‡Œä¸å®é™…è°ƒç”¨APIï¼Œåªæµ‹è¯•æ–¹æ³•æ˜¯å¦å­˜åœ¨
                if (typeof serviceInstance.callSparkAPI !== 'function') {
                    throw new Error('callSparkAPI æ–¹æ³•ä¸å­˜åœ¨');
                }

                apiDiv.innerHTML = `
                    <span class="success">âœ… APIè°ƒç”¨æ¥å£éªŒè¯æˆåŠŸ</span>
                    <pre>callSparkAPI æ–¹æ³•: âœ… å­˜åœ¨
æœåŠ¡çŠ¶æ€: âœ… å°±ç»ª
é…ç½®å®Œæ•´æ€§: ${serviceInstance.config.appId ? 'âœ…' : 'âŒ'}</pre>
                `;
                
                testResults.apiCall = true;
            } catch (error) {
                apiDiv.innerHTML = `
                    <span class="error">âŒ APIè°ƒç”¨æµ‹è¯•å¤±è´¥</span>
                    <pre>${error.message}</pre>
                `;
                testResults.apiCall = false;
            }
        }

        // æ›´æ–°æ€»ä½“çŠ¶æ€
        function updateOverallStatus() {
            const overallDiv = document.getElementById('overall-status');
            
            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;
            
            if (passedTests === totalTests) {
                overallDiv.innerHTML = `
                    <span class="success">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ (${passedTests}/${totalTests})</span>
                    <p>âœ… Process.env ä¿®å¤å®Œå…¨æˆåŠŸï¼ç³»ç»Ÿå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
                `;
            } else {
                overallDiv.innerHTML = `
                    <span class="warning">âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ (${passedTests}/${totalTests})</span>
                    <p>éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•é¡¹ç›®ã€‚</p>
                `;
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            console.log('ğŸ§ª å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            // é‡ç½®ç»“æœ
            errorCount = 0;
            errors.length = 0;
            testResults = {
                envSystem: false,
                serviceInstance: false,
                serviceConfig: false,
                apiCall: false,
                consoleClean: true
            };

            // ä¾æ¬¡è¿è¡Œæµ‹è¯•
            await checkEnvironmentSystem();
            const serviceInstance = await checkServiceInstance();
            await checkServiceConfig(serviceInstance);
            await testApiCall(serviceInstance);
            
            // ç­‰å¾…ä¸€ç§’é’Ÿæ”¶é›†å¯èƒ½çš„é”™è¯¯
            setTimeout(() => {
                updateConsoleMonitor();
                updateOverallStatus();
                console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ');
            }, 1000);
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            errorCount = 0;
            errors.length = 0;
            testResults = {
                envSystem: false,
                serviceInstance: false,
                serviceConfig: false,
                apiCall: false,
                consoleClean: true
            };

            document.getElementById('env-system-check').innerHTML = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('service-instance-check').innerHTML = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('service-config-check').innerHTML = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('api-call-test').innerHTML = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('console-monitor').innerHTML = 'ç›‘æ§ä¸­...';
            document.getElementById('overall-status').innerHTML = 'ç­‰å¾…æµ‹è¯•...';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });

        // å…¨å±€æš´éœ²å‡½æ•°
        window.runAllTests = runAllTests;
        window.clearResults = clearResults;
    </script>
</body>
</html>
