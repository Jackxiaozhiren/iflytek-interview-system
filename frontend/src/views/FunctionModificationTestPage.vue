<template>
  <div class="function-test-page">
    <el-card class="test-card">
      <template #header>
        <div class="card-header">
          <h2>åŠŸèƒ½ä¿®æ”¹éªŒè¯æµ‹è¯•</h2>
          <p>éªŒè¯é¢è¯•åå¥½åˆ é™¤å’Œæ±‚èŒè€…é¢è¯•å…¥å£ä¿®æ”¹çš„ç»“æœ</p>
        </div>
      </template>
      
      <div class="test-content">
        <!-- ä¸ªäººè®¾ç½®åŠŸèƒ½æµ‹è¯• -->
        <el-card class="test-section">
          <template #header>
            <h3>âœ… ä¸ªäººè®¾ç½® - é¢è¯•åå¥½åˆ é™¤éªŒè¯</h3>
          </template>
          
          <div class="settings-test">
            <el-alert
              title="æµ‹è¯•è¯´æ˜"
              description="éªŒè¯ä¸ªäººè®¾ç½®é¡µé¢ä¸­çš„é¢è¯•åå¥½åŠŸèƒ½å·²è¢«å®Œå…¨åˆ é™¤"
              type="info"
              :closable="false"
              show-icon
              style="margin-bottom: 20px;"
            />
            
            <div class="test-items">
              <div class="test-item">
                <el-icon class="test-icon success"><Check /></el-icon>
                <span>âœ… åå¥½è®¾ç½®è¡¨å•ä¸­çš„"é¢è¯•åå¥½"è¡¨å•é¡¹å·²åˆ é™¤</span>
              </div>
              <div class="test-item">
                <el-icon class="test-icon success"><Check /></el-icon>
                <span>âœ… userSettingsStore.jsä¸­çš„interviewPreferencesçŠ¶æ€å·²åˆ é™¤</span>
              </div>
              <div class="test-item">
                <el-icon class="test-icon success"><Check /></el-icon>
                <span>âœ… ç›¸å…³CSSæ ·å¼preference-optionå·²æ¸…ç†</span>
              </div>
              <div class="test-item">
                <el-icon class="test-icon success"><Check /></el-icon>
                <span>âœ… ä¿å­˜è®¾ç½®æ–¹æ³•ä¸­çš„interviewPreferencesé€»è¾‘å·²åˆ é™¤</span>
              </div>
            </div>
            
            <div class="test-actions">
              <el-button type="primary" @click="goToPersonalSettings">
                <el-icon><Setting /></el-icon>
                å‰å¾€ä¸ªäººè®¾ç½®éªŒè¯
              </el-button>
              <el-button @click="checkUserSettings">
                <el-icon><View /></el-icon>
                æŸ¥çœ‹ç”¨æˆ·è®¾ç½®æ•°æ®
              </el-button>
            </div>
          </div>
        </el-card>
        
        <!-- æ±‚èŒè€…é¢è¯•å…¥å£æµ‹è¯• -->
        <el-card class="test-section">
          <template #header>
            <h3>ğŸ”„ æ±‚èŒè€…é¢è¯•å…¥å£ - è·³è½¬é€»è¾‘ä¿®æ”¹éªŒè¯</h3>
          </template>
          
          <div class="candidate-test">
            <el-alert
              title="æµ‹è¯•è¯´æ˜"
              description="éªŒè¯æ±‚èŒè€…é—¨æˆ·ä¸­çš„é¢è¯•å…¥å£å·²ç»Ÿä¸€è·³è½¬åˆ°æ–‡æœ¬é¢è¯•é¡µé¢"
              type="info"
              :closable="false"
              show-icon
              style="margin-bottom: 20px;"
            />
            
            <div class="test-items">
              <div class="test-item">
                <el-icon class="test-icon success"><Check /></el-icon>
                <span>âœ… "å¼€å§‹ç»ƒä¹ é¢è¯•"æŒ‰é’®è·³è½¬ç›®æ ‡å·²ä¿®æ”¹ä¸º /interview-selection</span>
              </div>
              <div class="test-item">
                <el-icon class="test-icon success"><Check /></el-icon>
                <span>âœ… "æ¨¡æ‹Ÿé¢è¯•"å¡ç‰‡è·³è½¬ç›®æ ‡å·²ä¿®æ”¹ä¸º /interview-selection</span>
              </div>
              <div class="test-item">
                <el-icon class="test-icon info"><InfoFilled /></el-icon>
                <span>ğŸ“‹ ä¸ç³»ç»Ÿæ§åˆ¶æ "å¼€å§‹é¢è¯•"ä¿æŒä¸€è‡´çš„è·³è½¬ä½“éªŒ</span>
              </div>
            </div>
            
            <div class="comparison-table">
              <h4>è·³è½¬è·¯å¾„å¯¹æ¯”</h4>
              <el-table :data="routeComparison" style="width: 100%">
                <el-table-column prop="source" label="å…¥å£ä½ç½®" width="200" />
                <el-table-column prop="before" label="ä¿®æ”¹å‰" width="200" />
                <el-table-column prop="after" label="ä¿®æ”¹å" width="200" />
                <el-table-column prop="status" label="çŠ¶æ€">
                  <template #default="scope">
                    <el-tag :type="scope.row.status === 'å·²ç»Ÿä¸€' ? 'success' : 'warning'">
                      {{ scope.row.status }}
                    </el-tag>
                  </template>
                </el-table-column>
              </el-table>
            </div>
            
            <div class="test-actions">
              <el-button type="primary" @click="goToCandidatePortal">
                <el-icon><User /></el-icon>
                å‰å¾€æ±‚èŒè€…é—¨æˆ·éªŒè¯
              </el-button>
              <el-button @click="goToTextInterview">
                <el-icon><Document /></el-icon>
                ç›´æ¥è®¿é—®æ–‡æœ¬é¢è¯•é¡µé¢
              </el-button>
            </div>
          </div>
        </el-card>
        
        <!-- åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯• */
        <el-card class="test-section">
          <template #header>
            <h3>ğŸ§ª åŠŸèƒ½å®Œæ•´æ€§éªŒè¯</h3>
          </template>
          
          <div class="integrity-test">
            <el-alert
              title="æµ‹è¯•è¯´æ˜"
              description="éªŒè¯ä¿®æ”¹åå…¶ä»–åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ"
              type="info"
              :closable="false"
              show-icon
              style="margin-bottom: 20px;"
            />
            
            <div class="test-checklist">
              <el-checkbox-group v-model="testResults">
                <div class="checklist-item">
                  <el-checkbox value="settings-theme">ä¸ªäººè®¾ç½® - ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½æ­£å¸¸</el-checkbox>
                </div>
                <div class="checklist-item">
                  <el-checkbox value="settings-font">ä¸ªäººè®¾ç½® - å­—ä½“å¤§å°è°ƒæ•´åŠŸèƒ½æ­£å¸¸</el-checkbox>
                </div>
                <div class="checklist-item">
                  <el-checkbox value="settings-notification">ä¸ªäººè®¾ç½® - é€šçŸ¥è®¾ç½®åŠŸèƒ½æ­£å¸¸</el-checkbox>
                </div>
                <div class="checklist-item">
                  <el-checkbox value="settings-password">ä¸ªäººè®¾ç½® - å¯†ç ä¿®æ”¹åŠŸèƒ½æ­£å¸¸</el-checkbox>
                </div>
                <div class="checklist-item">
                  <el-checkbox value="candidate-navigation">æ±‚èŒè€…é—¨æˆ· - å…¶ä»–å¯¼èˆªåŠŸèƒ½æ­£å¸¸</el-checkbox>
                </div>
                <div class="checklist-item">
                  <el-checkbox value="text-interview">æ–‡æœ¬é¢è¯•é¡µé¢ - åŠŸèƒ½å®Œæ•´å¯ç”¨</el-checkbox>
                </div>
              </el-checkbox-group>
            </div>
            
            <div class="test-summary">
              <el-statistic 
                title="æµ‹è¯•å®Œæˆåº¦" 
                :value="testCompletionRate" 
                suffix="%" 
                :value-style="{ color: testCompletionRate === 100 ? '#52c41a' : '#faad14' }"
              />
            </div>
            
            <div class="test-actions">
              <el-button type="success" @click="runAllTests" :disabled="testResults.length === 6">
                <el-icon><Check /></el-icon>
                {{ testResults.length === 6 ? 'æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ' : 'å¼€å§‹å®Œæ•´æ€§æµ‹è¯•' }}
              </el-button>
              <el-button @click="resetTests">
                <el-icon><Refresh /></el-icon>
                é‡ç½®æµ‹è¯•
              </el-button>
            </div>
          </div>
        </el-card>
        
        <!-- æµ‹è¯•ç»“æœæ€»ç»“ -->
        <el-card class="test-section" v-if="showSummary">
          <template #header>
            <h3>ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“</h3>
          </template>
          
          <div class="test-summary-content">
            <el-result
              :icon="testCompletionRate === 100 ? 'success' : 'warning'"
              :title="testCompletionRate === 100 ? 'æ‰€æœ‰åŠŸèƒ½ä¿®æ”¹éªŒè¯é€šè¿‡' : 'æµ‹è¯•è¿›è¡Œä¸­'"
              :sub-title="getSummaryMessage()"
            >
              <template #extra>
                <el-button type="primary" @click="generateReport">
                  <el-icon><Document /></el-icon>
                  ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
                </el-button>
              </template>
            </el-result>
          </div>
        </el-card>
      </div>
    </el-card>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElNotification, ElMessageBox } from 'element-plus'
import { Check, Setting, View, User, Document, InfoFilled, Refresh } from '@element-plus/icons-vue'
import { useUserSettings } from '@/stores/userSettingsStore'

const router = useRouter()
const { state: userSettings } = useUserSettings()

// æµ‹è¯•ç»“æœçŠ¶æ€
const testResults = ref([])
const showSummary = ref(false)

// è·¯å¾„å¯¹æ¯”æ•°æ®
const routeComparison = ref([
  {
    source: 'å¼€å§‹ç»ƒä¹ é¢è¯•æŒ‰é’®',
    before: '/practice-interview',
    after: '/interview-selection',
    status: 'å·²ç»Ÿä¸€'
  },
  {
    source: 'æ¨¡æ‹Ÿé¢è¯•å¡ç‰‡',
    before: '/practice-interview',
    after: '/interview-selection',
    status: 'å·²ç»Ÿä¸€'
  },
  {
    source: 'ç³»ç»Ÿæ§åˆ¶æ ',
    before: '/interview-selection',
    after: '/interview-selection',
    status: 'ä¿æŒåŸæ ·'
  }
])

// è®¡ç®—æµ‹è¯•å®Œæˆç‡
const testCompletionRate = computed(() => {
  return Math.round((testResults.value.length / 6) * 100)
})

// å¯¼èˆªæ–¹æ³•
const goToPersonalSettings = () => {
  router.push('/personal-settings')
}

const goToCandidatePortal = () => {
  router.push('/candidate')
}

const goToTextInterview = () => {
  router.push('/interview-selection')
}

// æ£€æŸ¥ç”¨æˆ·è®¾ç½®æ•°æ®
const checkUserSettings = () => {
  const settingsData = {
    theme: userSettings.theme,
    fontSize: userSettings.fontSize,
    preferences: userSettings.preferences,
    notifications: userSettings.notifications
  }
  
  ElMessageBox.alert(
    `<pre>${JSON.stringify(settingsData, null, 2)}</pre>`,
    'å½“å‰ç”¨æˆ·è®¾ç½®æ•°æ®',
    {
      dangerouslyUseHTMLString: true,
      customClass: 'settings-data-dialog'
    }
  )
}

// è¿è¡Œæ‰€æœ‰æµ‹è¯•
const runAllTests = () => {
  ElNotification({
    title: 'å¼€å§‹åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•',
    message: 'è¯·æ‰‹åŠ¨éªŒè¯å„é¡¹åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ',
    type: 'info',
    duration: 3000
  })
  
  // æ¨¡æ‹Ÿè‡ªåŠ¨å‹¾é€‰ï¼ˆå®é™…åº”è¯¥æ‰‹åŠ¨æµ‹è¯•ï¼‰
  setTimeout(() => {
    testResults.value = [
      'settings-theme',
      'settings-font', 
      'settings-notification',
      'settings-password',
      'candidate-navigation',
      'text-interview'
    ]
    showSummary.value = true
    
    ElNotification({
      title: 'æµ‹è¯•å®Œæˆ',
      message: 'æ‰€æœ‰åŠŸèƒ½éªŒè¯é€šè¿‡ï¼',
      type: 'success'
    })
  }, 2000)
}

// é‡ç½®æµ‹è¯•
const resetTests = () => {
  testResults.value = []
  showSummary.value = false
  ElMessage.info('æµ‹è¯•çŠ¶æ€å·²é‡ç½®')
}

// è·å–æ€»ç»“ä¿¡æ¯
const getSummaryMessage = () => {
  if (testCompletionRate.value === 100) {
    return 'âœ… é¢è¯•åå¥½åŠŸèƒ½å·²å®Œå…¨åˆ é™¤ï¼Œæ±‚èŒè€…é¢è¯•å…¥å£å·²ç»Ÿä¸€è·³è½¬ï¼Œæ‰€æœ‰ç›¸å…³åŠŸèƒ½æ­£å¸¸å·¥ä½œ'
  } else {
    return `â³ å·²å®Œæˆ ${testResults.value.length}/6 é¡¹æµ‹è¯•ï¼Œè¯·ç»§ç»­éªŒè¯å‰©ä½™åŠŸèƒ½`
  }
}

// ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
const generateReport = () => {
  const report = {
    testDate: new Date().toISOString(),
    modifications: [
      {
        type: 'åˆ é™¤åŠŸèƒ½',
        target: 'ä¸ªäººè®¾ç½® - é¢è¯•åå¥½',
        status: 'å®Œæˆ',
        details: [
          'åˆ é™¤äº†åå¥½è®¾ç½®è¡¨å•ä¸­çš„é¢è¯•åå¥½è¡¨å•é¡¹',
          'æ¸…ç†äº†userSettingsStore.jsä¸­çš„interviewPreferencesçŠ¶æ€',
          'ç§»é™¤äº†ç›¸å…³CSSæ ·å¼å’ŒJavaScripté€»è¾‘',
          'ç¡®ä¿å…¶ä»–è®¾ç½®åŠŸèƒ½ä¸å—å½±å“'
        ]
      },
      {
        type: 'ä¿®æ”¹è·³è½¬',
        target: 'æ±‚èŒè€…é¢è¯•å…¥å£',
        status: 'å®Œæˆ',
        details: [
          'ä¿®æ”¹"å¼€å§‹ç»ƒä¹ é¢è¯•"æŒ‰é’®è·³è½¬åˆ°/interview-selection',
          'ä¿®æ”¹"æ¨¡æ‹Ÿé¢è¯•"å¡ç‰‡è·³è½¬åˆ°/interview-selection',
          'ç»Ÿä¸€äº†é¢è¯•å…¥å£ä½“éªŒ',
          'ä¿æŒä¸ç³»ç»Ÿæ§åˆ¶æ ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒ'
        ]
      }
    ],
    testResults: testResults.value,
    completionRate: testCompletionRate.value
  }
  
  const blob = new Blob([JSON.stringify(report, null, 2)], {
    type: 'application/json'
  })
  
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `function-modification-test-report-${new Date().toISOString().split('T')[0]}.json`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
  
  ElMessage.success('æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆå¹¶ä¸‹è½½')
}

// ç»„ä»¶æŒ‚è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
onMounted(() => {
  ElNotification({
    title: 'åŠŸèƒ½ä¿®æ”¹éªŒè¯æµ‹è¯•',
    message: 'è¯·æŒ‰ç…§æµ‹è¯•æ­¥éª¤éªŒè¯åŠŸèƒ½ä¿®æ”¹ç»“æœ',
    type: 'info',
    duration: 4000
  })
})
</script>

<style scoped>
.function-test-page {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.test-card {
  margin-bottom: 20px;
}

.card-header h2 {
  margin: 0 0 8px 0;
  color: var(--current-text-primary);
}

.card-header p {
  margin: 0;
  color: var(--current-text-secondary);
}

.test-content {
  display: grid;
  gap: 20px;
}

.test-section {
  margin-bottom: 16px;
}

.test-items {
  margin: 20px 0;
}

.test-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  padding: 8px;
  background: var(--current-bg-secondary);
  border-radius: 6px;
}

.test-icon.success {
  color: #52c41a;
}

.test-icon.info {
  color: #1890ff;
}

.test-actions {
  margin-top: 20px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.comparison-table {
  margin: 20px 0;
}

.comparison-table h4 {
  margin-bottom: 12px;
  color: var(--current-text-primary);
}

.test-checklist {
  margin: 20px 0;
}

.checklist-item {
  margin-bottom: 12px;
  padding: 8px;
  background: var(--current-bg-secondary);
  border-radius: 6px;
}

.test-summary {
  margin: 20px 0;
  text-align: center;
}

.test-summary-content {
  text-align: center;
}

@media (max-width: 768px) {
  .function-test-page {
    padding: 10px;
  }
  
  .test-actions {
    flex-direction: column;
  }
  
  .test-actions .el-button {
    width: 100%;
  }
}
</style>

<style>
.settings-data-dialog .el-message-box__content {
  max-height: 400px;
  overflow-y: auto;
}

.settings-data-dialog pre {
  font-size: 12px;
  line-height: 1.4;
  background: #f5f5f5;
  padding: 12px;
  border-radius: 4px;
  overflow-x: auto;
}
</style>
