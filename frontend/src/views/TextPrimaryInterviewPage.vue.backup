<template>
  <div class="text-primary-interview-page">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="interview-header">
      <div class="header-content">
        <div class="header-left">
          <el-icon class="logo-icon"><Star /></el-icon>
          <h1>iFlytekæ˜Ÿç«æ™ºèƒ½é¢è¯•</h1>
          <span class="interview-mode">æ–‡æœ¬ä¼˜å…ˆæ¨¡å¼</span>
        </div>
        <div class="header-right">
          <div class="interview-progress">
            <span>é—®é¢˜è¿›åº¦: {{ currentQuestion }}/{{ totalQuestions }}</span>
            <el-progress :percentage="(currentQuestion / totalQuestions) * 100" :show-text="false" />
          </div>
          <div class="interview-timer">
            <el-icon><Timer /></el-icon>
            <span>{{ formatTime(elapsedTime) }}</span>
          </div>
        </div>
      </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="interview-main">
      <div class="interview-layout">
        <!-- å·¦ä¾§: æ–‡æœ¬å¯¹è¯åŒºåŸŸ -->
        <section class="conversation-section">
          <div class="conversation-container">
            <!-- å¯¹è¯å†å² -->
            <div class="conversation-history">
              <div class="conversation-header">
                <div class="header-info">
                  <el-icon><Document /></el-icon>
                  <h3>é¢è¯•å¯¹è¯</h3>
                  <span class="mode-indicator">æ–‡æœ¬ä¼˜å…ˆ</span>
                </div>

              </div>

              <!-- æ¶ˆæ¯åˆ—è¡¨ -->
              <div class="messages-container"
                   ref="messagesContainer"
                   @scroll="handleUserScroll"
                   @keydown="handleKeyboardScroll"
                   tabindex="0"
                   role="log"
                   aria-label="é¢è¯•å¯¹è¯è®°å½•"
                   aria-live="polite">
                <div v-for="(message, index) in conversationHistory" :key="index"
                     class="message-item"
                     :class="[
                       message.type,
                       { 'message-animating': message.isAnimating },
                       { 'message-thinking': message.isThinking },
                       { 'message-enhanced': message.hasThinkingProcess },
                       { 'message-transition': message.isTransition }
                     ]"
                     :data-transition="message.isTransition">
                  <div class="message-avatar">
                    <el-icon v-if="message.type === 'ai'">
                      <User v-if="!message.isThinking" />
                      <Loading v-else class="thinking-icon" />
                    </el-icon>
                    <el-icon v-else><Star /></el-icon>
                  </div>
                  <div class="message-content">
                    <div class="message-header">
                      <span class="message-sender">{{ message.sender }}</span>
                      <span class="message-time">{{ message.timestamp }}</span>
                    </div>

                    <!-- æ€è€ƒè¿‡ç¨‹çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                    <div v-if="message.isThinking" class="thinking-indicator">
                      <el-icon class="thinking-icon"><Loading /></el-icon>
                      <span>{{ message.content }}</span>
                    </div>

                    <!-- å¢å¼ºçš„å¯æŠ˜å æ€è€ƒè¿‡ç¨‹ -->
                    <div v-if="message.hasThinkingProcess && message.thinkingProcess"
                         class="thinking-process-container enhanced-thinking"
                         role="region"
                         aria-label="AIæ€è€ƒè¿‡ç¨‹åˆ†æ">
                      <el-collapse v-model="message.thinkingExpanded" class="thinking-collapse">
                        <el-collapse-item name="thinking">
                          <template #title>
                            <div class="thinking-summary"
                                 role="button"
                                 :aria-expanded="message.thinkingExpanded?.includes('thinking')"
                                 aria-controls="thinking-content"
                                 tabindex="0">
                              <div class="thinking-icon-wrapper" aria-hidden="true">
                                <el-icon class="thinking-main-icon"><Cpu /></el-icon>
                              </div>
                              <div class="thinking-title-content">
                                <span class="thinking-title">ğŸ§  AIæ€è€ƒè¿‡ç¨‹åˆ†æ</span>
                                <span v-if="message.thinkingExpanded?.includes('thinking')"
                                      class="thinking-subtitle">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†çš„åˆ†ææ­¥éª¤å’Œè¯„ä¼°è¦ç‚¹</span>
                              </div>
                              <div class="thinking-status">
                                <el-tag size="small" :type="message.thinkingExpanded?.includes('thinking') ? 'success' : 'info'">
                                  {{ message.thinkingExpanded?.includes('thinking') ? 'å·²å±•å¼€' : 'ç‚¹å‡»å±•å¼€' }}
                                </el-tag>
                              </div>
                            </div>
                          </template>
                          <div class="thinking-content enhanced-content"
                               id="thinking-content"
                               role="tabpanel"
                               :aria-hidden="!message.thinkingExpanded?.includes('thinking')">
                            <div class="thinking-steps" role="list" aria-label="æ€è€ƒæ­¥éª¤åˆ—è¡¨">
                              <div v-for="(step, index) in parseThinkingSteps(message.thinkingProcess)"
                                   :key="index"
                                   class="thinking-step"
                                   role="listitem"
                                   :aria-label="`ç¬¬${index + 1}æ­¥: ${step.title}`">
                                <div class="step-header">
                                  <span class="step-number" aria-hidden="true">{{ index + 1 }}</span>
                                  <span class="step-title">{{ step.title }}</span>
                                </div>
                                <div class="step-content">{{ step.content }}</div>
                              </div>
                            </div>
                          </div>
                        </el-collapse-item>
                      </el-collapse>
                    </div>

                    <!-- ä¸»è¦å›å¤å†…å®¹ -->
                    <div v-if="!message.isThinking" class="message-text">
                      <div v-if="message.isTyping" class="typing-text">
                        {{ message.displayedContent }}
                        <span class="typing-cursor">|</span>
                      </div>
                      <div v-else-if="message.hasThinkingProcess && message.finalResponse" class="final-response">
                        {{ message.finalResponse }}
                      </div>
                      <div v-else-if="message.displayedContent" class="displayed-content">
                        {{ message.displayedContent }}
                      </div>
                      <div v-else class="default-content">
                        {{ message.content }}
                      </div>
                    </div>

                    <!-- åˆ†ææ ‡ç­¾ -->
                    <div v-if="message.analysis && !message.isThinking"
                         class="message-analysis">
                      <div class="analysis-tags">
                        <span class="score-tag">è¯„åˆ†: {{ message.analysis.score }}</span>
                        <span class="keywords-tag">å…³é”®è¯: {{ (message.analysis.keywords || []).join(', ') || 'æ— ' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- å›åˆ°æœ€æ–°æ¶ˆæ¯æŒ‰é’® -->
              <div v-if="scrollState.showScrollToBottomHint"
                   class="scroll-to-bottom-hint"
                   @click="forceScrollToBottom">
                <el-button type="primary" size="small" round>
                  <el-icon><ArrowRight /></el-icon>
                  å›åˆ°æœ€æ–°æ¶ˆæ¯
                </el-button>
              </div>
            </div>



            <!-- å›ç­”è¾“å…¥åŒºåŸŸ -->
            <div class="answer-input-panel">
              <div class="input-header">
                <div class="input-header-left">
                  <span class="input-label">æ‚¨çš„å›ç­”</span>
                  <el-tag v-if="currentTextInput.length > 0" type="info" size="small">
                    {{ currentTextInput.length }}/1000 å­—ç¬¦
                  </el-tag>
                </div>
                <div class="input-tools">
                  <el-button-group>
                    <el-button size="small" @click="insertTemplate('é¡¹ç›®ç»éªŒ')" title="æ’å…¥é¡¹ç›®ç»éªŒæ¨¡æ¿">
                      <el-icon><Document /></el-icon>
                      é¡¹ç›®ç»éªŒ
                    </el-button>
                    <el-button size="small" @click="insertTemplate('æŠ€æœ¯æ ˆ')" title="æ’å…¥æŠ€æœ¯æ ˆæ¨¡æ¿">
                      <el-icon><Setting /></el-icon>
                      æŠ€æœ¯æ ˆ
                    </el-button>
                    <el-button size="small" @click="insertTemplate('è§£å†³æ–¹æ¡ˆ')" title="æ’å…¥è§£å†³æ–¹æ¡ˆæ¨¡æ¿">
                      <el-icon><Tools /></el-icon>
                      è§£å†³æ–¹æ¡ˆ
                    </el-button>
                  </el-button-group>
                </div>
              </div>

              <div class="input-container">
                <div class="textarea-wrapper">
                  <el-input
                    v-model="currentTextInput"
                    type="textarea"
                    :rows="6"
                    placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„å›ç­”...&#10;&#10;ğŸ’¡ æç¤ºï¼š&#10;â€¢ ä½¿ç”¨ Ctrl + Enter å¿«é€Ÿæäº¤&#10;â€¢ ç‚¹å‡»ä¸Šæ–¹æ¨¡æ¿æŒ‰é’®å¿«é€Ÿæ’å…¥å¸¸ç”¨å†…å®¹&#10;â€¢ è¯¦ç»†æè¿°æ‚¨çš„ç»éªŒå’Œæ€è·¯"
                    class="answer-textarea"
                    @keydown.ctrl.enter="submitAnswer"
                    @input="handleInputChange"
                    maxlength="1000"
                    show-word-limit
                    resize="vertical"
                  />
                  <!-- å³ä¸‹è§’æäº¤æŒ‰é’® -->
                  <el-button
                    type="primary"
                    size="small"
                    :loading="isProcessingMultimodal"
                    @click="submitAnswer"
                    :disabled="!currentTextInput.trim()"
                    class="corner-submit-btn"
                    title="æäº¤å›ç­” (Ctrl + Enter)"
                  >
                    <el-icon><Promotion /></el-icon>
                  </el-button>
                </div>

                <!-- æ™ºèƒ½å»ºè®®æµ®å±‚ -->
                <div v-if="showSmartSuggestions && smartSuggestions.length > 0" class="smart-suggestions">
                  <div class="suggestions-header">
                    <el-icon><Star /></el-icon>
                    <span>æ™ºèƒ½å»ºè®®</span>
                  </div>
                  <div class="suggestions-list">
                    <div
                      v-for="(suggestion, index) in smartSuggestions"
                      :key="index"
                      class="suggestion-item"
                      @click="applySuggestion(suggestion)"
                    >
                      <el-icon><Plus /></el-icon>
                      <span>{{ suggestion }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="input-footer">
                <div class="input-footer-left">
                  <span class="input-hint">
                    <el-icon><InfoFilled /></el-icon>
                    Ctrl + Enter å¿«é€Ÿæäº¤
                  </span>
                  <el-button
                    v-if="currentTextInput.length > 0"
                    size="small"
                    type="info"
                    text
                    @click="toggleSmartSuggestions"
                  >
                    <el-icon><Star /></el-icon>
                    {{ showSmartSuggestions ? 'éšè—å»ºè®®' : 'æ™ºèƒ½å»ºè®®' }}
                  </el-button>
                </div>
                <div class="input-actions">
                  <el-button size="small" @click="saveAsDraft" v-if="currentTextInput.length > 0">
                    <el-icon><Document /></el-icon>
                    ä¿å­˜è‰ç¨¿
                  </el-button>
                  <el-button size="small" @click="clearInput" v-if="currentTextInput.length > 0">
                    <el-icon><Delete /></el-icon>
                    æ¸…ç©º
                  </el-button>
                  <el-button size="small" @click="nextQuestion" v-if="currentQuestion < totalQuestions">
                    <el-icon><Right /></el-icon>
                    è·³è¿‡é—®é¢˜
                  </el-button>
                  <el-button
                    type="primary"
                    size="small"
                    :loading="isProcessingMultimodal"
                    @click="submitAnswer"
                    :disabled="!currentTextInput.trim()"
                  >
                    <el-icon><Promotion /></el-icon>
                    æäº¤å›ç­”
                  </el-button>
                </div>
              </div>
            </div>


          </div>
        </section>

        <!-- å³ä¾§: å½“å‰é—®é¢˜å’Œå¿«æ·æ“ä½œé¢æ¿ -->
        <section class="question-control-section">
          <!-- é¢è¯•é—®é¢˜é¢æ¿ -->
          <div class="current-question-panel">
            <div class="question-header">
              <div class="header-left">
                <el-icon class="question-icon"><InfoFilled /></el-icon>
                <span class="question-title">é¢è¯•é—®é¢˜</span>
                <el-tag type="info" size="small">{{ currentQuestion }}/{{ totalQuestions }}</el-tag>
              </div>
              <div class="question-actions">
                <el-button size="small" @click="getAiHint" :disabled="aiAssistanceCount <= 0">
                  <el-icon><Star /></el-icon>
                  AIæç¤º ({{ aiAssistanceCount }})
                </el-button>
              </div>
            </div>
            <div class="question-content">
              <div class="question-text-container">
                <p class="question-text">{{ currentQuestionData.text }}</p>
              </div>
              <div class="question-meta">
                <el-tag type="primary" size="small">
                  <el-icon><Document /></el-icon>
                  {{ currentQuestionData.type }}
                </el-tag>
                <el-tag type="warning" size="small">
                  éš¾åº¦: {{ currentQuestionData.difficulty }}
                </el-tag>
                <el-tag type="success" size="small">
                  {{ currentQuestionData.domainName }}
                </el-tag>
              </div>
            </div>
          </div>

          <!-- å¿«æ·æ“ä½œé¢æ¿ -->
          <div class="quick-actions-panel">
            <div class="actions-header">
              <el-icon><Operation /></el-icon>
              <h4>å¿«æ·æ“ä½œ</h4>
            </div>
            <div class="actions-content">
              <!-- é—®é¢˜å¯¼èˆª -->
              <div class="question-navigation">
                <div class="nav-title">
                  <el-icon><QuestionFilled /></el-icon>
                  é—®é¢˜å¯¼èˆª
                </div>
                <div class="question-buttons">
                  <el-button
                    v-for="n in totalQuestions"
                    :key="n"
                    :type="n === currentQuestion ? 'primary' : (n < currentQuestion ? 'success' : 'default')"
                    :disabled="n > currentQuestion + 1"
                    size="small"
                    @click="jumpToQuestion(n)"
                    class="question-nav-btn"
                  >
                    {{ n }}
                  </el-button>
                </div>
              </div>

              <!-- é¢è¯•æ§åˆ¶ -->
              <div class="interview-controls">
                <div class="controls-title">
                  <el-icon><Setting /></el-icon>
                  é¢è¯•æ§åˆ¶
                </div>
                <div class="control-buttons">
                  <el-button
                    size="small"
                    @click="pauseInterview"
                    :disabled="interviewState.isPaused"
                  >
                    <el-icon><VideoPause /></el-icon>
                    æš‚åœé¢è¯•
                  </el-button>
                  <el-button
                    size="small"
                    @click="resumeInterview"
                    :disabled="!interviewState.isPaused"
                  >
                    <el-icon><VideoPlay /></el-icon>
                    ç»§ç»­é¢è¯•
                  </el-button>
                  <el-button
                    size="small"
                    type="danger"
                    @click="endInterview"
                  >
                    <el-icon><SwitchButton /></el-icon>
                    ç»“æŸé¢è¯•
                  </el-button>
                </div>
              </div>
            </div>
          </div>

          <!-- å€™é€‰äººä¿¡æ¯é¢æ¿ -->
          <div class="candidate-info-panel">
            <div class="panel-header">
              <el-icon><User /></el-icon>
              <h4>å€™é€‰äººä¿¡æ¯</h4>
              <el-tag type="info" size="small">{{ candidateInfo.position }}</el-tag>
            </div>
            <div class="panel-content">
              <div class="candidate-info">
                <div class="candidate-basic">
                  <div class="candidate-name">{{ candidateInfo.name }}</div>
                  <div class="candidate-stats">
                    <span>å›ç­”é—®é¢˜: {{ conversationHistory.filter(msg => msg.type === 'user').length }}</span>
                    <span>å¯¹è¯åˆ†æ•°: {{ conversationScoring.currentQuestionScore }}</span>
                  </div>
                </div>
                <div class="candidate-skills">
                  <div class="skills-tags">
                    <el-tag v-for="skill in candidateInfo.skills.slice(0, 4)" :key="skill" size="small">
                      {{ skill }}
                    </el-tag>
                    <el-tag v-if="candidateInfo.skills.length > 4" size="small" type="info">
                      +{{ candidateInfo.skills.length - 4 }}
                    </el-tag>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>


      </div>
    </main>

    <!-- å¯¹è¯æ¡†ä¸‹æ–¹çš„åˆ†æé¢æ¿å®¹å™¨ - å¹¶æ’æ˜¾ç¤º -->
    <div class="analysis-panels-container">
      <!-- å®æ—¶åˆ†æçŠ¶æ€é¢æ¿ -->
      <div class="analysis-panel status-panel">
        <div class="panel-header">
          <el-icon class="spark-icon"><Star /></el-icon>
          <h4>å®æ—¶åˆ†æçŠ¶æ€</h4>
          <div class="status-indicator" :class="{ active: isSparkInitialized }">
            <div class="status-dot"></div>
            <span>{{ sparkStatus }}</span>
          </div>
        </div>
        <div class="panel-content">
          <div class="processing-stats">
            <div class="stat-item">
              <span class="stat-label">å·²å¤„ç†æ¶ˆæ¯</span>
              <span class="stat-value">{{ conversationHistory.length }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">åˆ†æè€—æ—¶</span>
              <span class="stat-value">{{ lastAnalysisTime }}ms</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">æ¨¡å‹ç‰ˆæœ¬</span>
              <span class="stat-value">Spark 3.5</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">å“åº”æ—¶é—´</span>
              <span class="stat-value">{{ sparkMetrics.responseTime }}ms</span>
            </div>
          </div>
        </div>
      </div>

      <!-- æ–‡æœ¬åˆ†æç»“æœé¢æ¿ -->
      <div class="analysis-panel results-panel">
        <div class="panel-header">
          <div class="header-left">
            <el-icon><Document /></el-icon>
            <h4>æ–‡æœ¬åˆ†æç»“æœ</h4>
            <el-tag :type="getScoreType(conversationScoring.currentQuestionScore)" size="small">
              å¯¹è¯{{ conversationScoring.currentQuestionScore || 0 }}åˆ†
            </el-tag>
          </div>
          <div class="header-right">
            <el-tag type="info" size="small">
              å¯¹è¯è½®æ¬¡: {{ interviewState.conversationRounds }}
            </el-tag>
            <el-tag type="success" size="small">
              æµç•…åº¦: {{ Math.round(conversationScoring.fluencyMetrics?.interactionQuality || 0) }}åˆ†
            </el-tag>
          </div>
        </div>
        <div class="panel-content">
          <div class="score-breakdown enhanced-layout">
            <div class="score-column">
              <div class="score-item">
                <span class="score-name">æŠ€æœ¯èƒ½åŠ›</span>
                <div class="score-bar">
                  <div class="score-fill" :style="{ width: (realTimeAnalysis.technicalCompetency || 0) + '%' }"></div>
                </div>
                <span class="score-value">{{ realTimeAnalysis.technicalCompetency || 0 }}</span>
              </div>
              <div class="score-item">
                <span class="score-name">æ²Ÿé€šæŠ€å·§</span>
                <div class="score-bar">
                  <div class="score-fill" :style="{ width: (realTimeAnalysis.communicationSkills || 0) + '%' }"></div>
                </div>
                <span class="score-value">{{ realTimeAnalysis.communicationSkills || 0 }}</span>
              </div>
              <div class="score-item">
                <span class="score-name">å†…å®¹è´¨é‡</span>
                <div class="score-bar">
                  <div class="score-fill" :style="{ width: (realTimeAnalysis.contentQuality || 0) + '%' }"></div>
                </div>
                <span class="score-value">{{ realTimeAnalysis.contentQuality || 0 }}</span>
              </div>
            </div>
            <div class="score-column">
              <div class="score-item">
                <span class="score-name">é€»è¾‘æ€ç»´</span>
                <div class="score-bar">
                  <div class="score-fill" :style="{ width: (realTimeAnalysis.logicalThinking || 0) + '%' }"></div>
                </div>
                <span class="score-value">{{ realTimeAnalysis.logicalThinking || 0 }}</span>
              </div>
              <div class="score-item">
                <span class="score-name">è¡¨è¾¾èƒ½åŠ›</span>
                <div class="score-bar">
                  <div class="score-fill" :style="{ width: (realTimeAnalysis.expressionAbility || 0) + '%' }"></div>
                </div>
                <span class="score-value">{{ realTimeAnalysis.expressionAbility || 0 }}</span>
              </div>
              <div class="score-item">
                <span class="score-name">å­¦ä¹ èƒ½åŠ›</span>
                <div class="score-bar">
                  <div class="score-fill" :style="{ width: (realTimeAnalysis.learningAbility || 0) + '%' }"></div>
                </div>
                <span class="score-value">{{ realTimeAnalysis.learningAbility || 0 }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AIæ™ºèƒ½æç¤ºæµ®å±‚é¢æ¿ -->
    <div class="ai-hints-overlay" v-if="showAiHints" @click.self="showAiHints = false">
      <div class="ai-hints-floating-panel">
        <div class="hints-header">
          <div class="hints-title">
            <el-icon><Star /></el-icon>
            <span>AIæ™ºèƒ½æç¤º</span>
          </div>
          <el-button size="small" text @click="showAiHints = false" class="close-btn">
            <el-icon><Close /></el-icon>
          </el-button>
        </div>
        <div class="hints-content">
          <div class="hint-text-container">
            <p class="hint-text">{{ currentAiHint }}</p>
          </div>
          <div class="hint-actions">
            <el-button
              size="small"
              @click="getAiHint"
              :disabled="aiAssistanceCount <= 0"
              type="primary"
            >
              <el-icon><Star /></el-icon>
              è·å–æ–°æç¤º ({{ aiAssistanceCount }})
            </el-button>
            <el-button size="small" @click="showAiHints = false">
              å…³é—­
            </el-button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted, onUnmounted, nextTick } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElNotification, ElMessageBox } from 'element-plus'
import {
  User, Timer, Star, Loading,
  Document, ArrowRight, Setting, Close,
  InfoFilled, Tools, Promotion,
  Plus, Delete, Right, QuestionFilled,
  Operation, VideoPause,
  VideoPlay, SwitchButton
} from '@element-plus/icons-vue'
import enhancedIflytekSparkService from '@/services/enhancedIflytekSparkService'

const router = useRouter()

// DOMå¼•ç”¨
const messagesContainer = ref(null)

// è®¯é£æ˜Ÿç«æœåŠ¡ç›¸å…³
const sparkSession = ref(null)
const isSparkInitialized = ref(false)
const sparkStatus = ref('åˆå§‹åŒ–ä¸­...')

// åŸºç¡€é¢è¯•æ•°æ®
const currentQuestion = ref(1)
const totalQuestions = ref(10)

// ç›‘å¬é¢˜ç›®å˜åŒ–ï¼ˆè°ƒè¯•ç”¨ï¼‰
watch(currentQuestion, (newVal, oldVal) => {
  console.log('ğŸ”¢ é¢˜ç›®å˜åŒ–:', oldVal, '->', newVal)
  console.trace('é¢˜ç›®å˜åŒ–è°ƒç”¨æ ˆ')
}, { immediate: true })
const elapsedTime = ref(0)
const aiAssistanceCount = ref(3)

// æ–‡æœ¬ä¼˜å…ˆäº¤äº’
const currentTextInput = ref('')
const isProcessingMultimodal = ref(false)

// æ™ºèƒ½å»ºè®®åŠŸèƒ½
const showSmartSuggestions = ref(false)
const smartSuggestions = ref([])
const draftAnswers = ref(new Map())

// iFlytek SparkæŠ€æœ¯æŒ‡æ ‡
const sparkMetrics = ref({
  responseTime: 156,
  accuracy: 96.8,
  processedTokens: '2.3K'
})

const lastAnalysisTime = ref(156)

// AIèƒ½åŠ›å±•ç¤º
const aiCapabilities = ref([
  {
    id: 1,
    name: 'è¯­ä¹‰ç†è§£',
    level: 95,
    color: '#1890ff',
    icon: 'ChatDotRound',
    description: 'æ·±åº¦ç†è§£å›ç­”å†…å®¹çš„è¯­ä¹‰å’Œé€»è¾‘ç»“æ„'
  },
  {
    id: 2,
    name: 'æŠ€èƒ½è¯„ä¼°',
    level: 92,
    color: '#52c41a',
    icon: 'TrendCharts',
    description: 'ç²¾å‡†è¯„ä¼°å€™é€‰äººçš„æŠ€æœ¯èƒ½åŠ›å’Œç»éªŒæ°´å¹³'
  },
  {
    id: 3,
    name: 'å®æ—¶åˆ†æ',
    level: 98,
    color: '#fa8c16',
    icon: 'Monitor',
    description: 'æ¯«ç§’çº§å®æ—¶åˆ†æï¼Œæä¾›å³æ—¶åé¦ˆ'
  },
  {
    id: 4,
    name: 'æ™ºèƒ½æ¨è',
    level: 89,
    color: '#722ed1',
    icon: 'Star',
    description: 'åŸºäºåˆ†æç»“æœæä¾›ä¸ªæ€§åŒ–æ”¹è¿›å»ºè®®'
  }
])

// å¯¹è¯å†å²
const conversationHistory = ref([
  {
    type: 'ai',
    sender: 'AIé¢è¯•å®˜',
    content: 'æ‚¨å¥½ï¼æ¬¢è¿å‚åŠ iFlytekæ˜Ÿç«æ™ºèƒ½é¢è¯•ã€‚æˆ‘å°†é€šè¿‡æ–‡æœ¬å¯¹è¯çš„æ–¹å¼ä¸æ‚¨è¿›è¡Œé¢è¯•ã€‚é¢è¯•é—®é¢˜å°†æ˜¾ç¤ºåœ¨ä¸Šæ–¹çš„é—®é¢˜é¢æ¿ä¸­ï¼Œè¯·ä»”ç»†é˜…è¯»åè¿›è¡Œå›ç­”ã€‚ç¥æ‚¨é¢è¯•é¡ºåˆ©ï¼',
    timestamp: new Date().toLocaleTimeString(),
    analysis: null
  }
])

// AIæç¤ºç›¸å…³
const showAiHints = ref(false)
const currentAiHint = ref('å»ºè®®ä»é¡¹ç›®èƒŒæ™¯å¼€å§‹ä»‹ç»ï¼Œç„¶åè¯¦è¿°æŠ€æœ¯éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆ')

// é¢„è®¾é—®é¢˜åº“
const questionBank = ref([
  {
    text: 'è¯·ç®€å•ä»‹ç»ä¸€ä¸‹æ‚¨åœ¨äººå·¥æ™ºèƒ½é¢†åŸŸçš„é¡¹ç›®ç»éªŒï¼Œç‰¹åˆ«æ˜¯åœ¨æœºå™¨å­¦ä¹ æ¨¡å‹å¼€å‘æ–¹é¢çš„å®è·µã€‚',
    type: 'æŠ€æœ¯æ·±åº¦',
    difficulty: 'medium',
    domain: 'ai',
    domainName: 'AIç®—æ³•'
  },
  {
    text: 'è¯·è¯¦ç»†æè¿°æ‚¨åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹ä¼˜åŒ–æ–¹é¢çš„å®è·µç»éªŒï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„æŠ€æœ¯æ‰‹æ®µã€é‡åˆ°çš„æŒ‘æˆ˜ä»¥åŠæœ€ç»ˆçš„æ•ˆæœã€‚',
    type: 'å®è·µç»éªŒ',
    difficulty: 'medium',
    domain: 'ai',
    domainName: 'AIç®—æ³•'
  },
  {
    text: 'åœ¨å¤§æ•°æ®å¤„ç†é¡¹ç›®ä¸­ï¼Œæ‚¨æ˜¯å¦‚ä½•è®¾è®¡å’Œå®ç°æ•°æ®å¤„ç†æµæ°´çº¿çš„ï¼Ÿè¯·åˆ†äº«å…·ä½“çš„æŠ€æœ¯æ¶æ„å’Œä¼˜åŒ–ç­–ç•¥ã€‚',
    type: 'ç³»ç»Ÿè®¾è®¡',
    difficulty: 'hard',
    domain: 'bigdata',
    domainName: 'å¤§æ•°æ®'
  },
  {
    text: 'è¯·æè¿°ä¸€ä¸ªæ‚¨å‚ä¸çš„è‡ªç„¶è¯­è¨€å¤„ç†é¡¹ç›®ï¼ŒåŒ…æ‹¬æŠ€æœ¯é€‰å‹ã€æ¨¡å‹è®­ç»ƒå’Œæ•ˆæœè¯„ä¼°çš„å®Œæ•´è¿‡ç¨‹ã€‚',
    type: 'é¡¹ç›®ç»éªŒ',
    difficulty: 'medium',
    domain: 'ai',
    domainName: 'AIç®—æ³•'
  },
  {
    text: 'åœ¨ç‰©è”ç½‘ç³»ç»Ÿå¼€å‘ä¸­ï¼Œæ‚¨æ˜¯å¦‚ä½•å¤„ç†è®¾å¤‡è¿æ¥ã€æ•°æ®é‡‡é›†å’Œå®æ—¶ç›‘æ§çš„æŠ€æœ¯æŒ‘æˆ˜çš„ï¼Ÿ',
    type: 'æŠ€æœ¯å®ç°',
    difficulty: 'hard',
    domain: 'iot',
    domainName: 'ç‰©è”ç½‘'
  },
  {
    text: 'è¯·åˆ†äº«æ‚¨åœ¨è®¡ç®—æœºè§†è§‰é¡¹ç›®ä¸­çš„ç»éªŒï¼ŒåŒ…æ‹¬å›¾åƒå¤„ç†ã€ç‰¹å¾æå–å’Œæ¨¡å‹éƒ¨ç½²çš„æŠ€æœ¯ç»†èŠ‚ã€‚',
    type: 'ä¸“ä¸šæŠ€èƒ½',
    difficulty: 'medium',
    domain: 'ai',
    domainName: 'AIç®—æ³•'
  },
  {
    text: 'åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­ï¼Œæ‚¨æ˜¯å¦‚ä½•ä¿è¯ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§å’Œæ•°æ®ä¸€è‡´æ€§çš„ï¼Ÿè¯·ç»“åˆå…·ä½“æ¡ˆä¾‹è¯´æ˜ã€‚',
    type: 'æ¶æ„è®¾è®¡',
    difficulty: 'hard',
    domain: 'system',
    domainName: 'ç³»ç»Ÿæ¶æ„'
  },
  {
    text: 'è¯·æè¿°æ‚¨åœ¨æ¨èç³»ç»Ÿå¼€å‘ä¸­çš„ç»éªŒï¼ŒåŒ…æ‹¬ç®—æ³•é€‰æ‹©ã€ç‰¹å¾å·¥ç¨‹å’Œæ•ˆæœä¼˜åŒ–çš„å®Œæ•´æµç¨‹ã€‚',
    type: 'ç®—æ³•åº”ç”¨',
    difficulty: 'medium',
    domain: 'ai',
    domainName: 'AIç®—æ³•'
  },
  {
    text: 'åœ¨äº‘è®¡ç®—å¹³å°ä¸Šéƒ¨ç½²æœºå™¨å­¦ä¹ æ¨¡å‹æ—¶ï¼Œæ‚¨æ˜¯å¦‚ä½•å¤„ç†æ€§èƒ½ä¼˜åŒ–å’Œæˆæœ¬æ§åˆ¶çš„ï¼Ÿ',
    type: 'å·¥ç¨‹å®è·µ',
    difficulty: 'hard',
    domain: 'cloud',
    domainName: 'äº‘è®¡ç®—'
  },
  {
    text: 'è¯·æ€»ç»“æ‚¨åœ¨æŠ€æœ¯å›¢é˜Ÿä¸­çš„åä½œç»éªŒï¼Œä»¥åŠåœ¨æŠ€æœ¯å†³ç­–å’Œé¡¹ç›®ç®¡ç†æ–¹é¢çš„å¿ƒå¾—ä½“ä¼šã€‚',
    type: 'ç»¼åˆèƒ½åŠ›',
    difficulty: 'medium',
    domain: 'management',
    domainName: 'å›¢é˜Ÿåä½œ'
  }
])

// å½“å‰é—®é¢˜æ•°æ®
const currentQuestionData = ref({
  text: 'è¯·ç®€å•ä»‹ç»ä¸€ä¸‹æ‚¨åœ¨äººå·¥æ™ºèƒ½é¢†åŸŸçš„é¡¹ç›®ç»éªŒï¼Œç‰¹åˆ«æ˜¯åœ¨æœºå™¨å­¦ä¹ æ¨¡å‹å¼€å‘æ–¹é¢çš„å®è·µã€‚',
  type: 'æŠ€æœ¯æ·±åº¦',
  difficulty: 'medium',
  domain: 'ai',
  domainName: 'AIç®—æ³•'
})

// å®æ—¶åˆ†æç»“æœ
const realTimeAnalysis = ref({
  overallScore: 0,
  technicalCompetency: 0,
  communicationSkills: 0,
  contentQuality: 0,
  lastUpdated: null
})



// å€™é€‰äººä¿¡æ¯
const candidateInfo = ref({
  name: 'å¼ ä¸‰',
  position: 'AIç®—æ³•å·¥ç¨‹å¸ˆ',
  skills: ['Python', 'TensorFlow', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'NLP']
})

// æ–¹æ³•
const formatTime = (seconds) => {
  const mins = Math.floor(seconds / 60)
  const secs = seconds % 60
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
}

// åˆå§‹åŒ–è®¯é£æ˜Ÿç«æœåŠ¡
const initializeSparkService = async () => {
  try {
    sparkStatus.value = 'æ­£åœ¨è¿æ¥è®¯é£æ˜Ÿç«å¤§æ¨¡å‹...'

    const candidateProfile = {
      name: candidateInfo.value.name,
      position: candidateInfo.value.position,
      skills: candidateInfo.value.skills,
      domain: 'ai'
    }

    sparkSession.value = await enhancedIflytekSparkService.initializeInterviewSession(
      candidateProfile,
      'comprehensive'
    )

    isSparkInitialized.value = true
    sparkStatus.value = 'è®¯é£æ˜Ÿç«å¤§æ¨¡å‹å·²å°±ç»ª'

    ElNotification.success({
      title: 'ç³»ç»Ÿå°±ç»ª',
      message: 'iFlytekæ˜Ÿç«å¤§æ¨¡å‹å·²æˆåŠŸåˆå§‹åŒ–ï¼Œé¢è¯•å¯ä»¥å¼€å§‹äº†ï¼',
      duration: 3000
    })

    // ç”Ÿæˆç¬¬ä¸€ä¸ªé—®é¢˜
    await generateNextQuestion()

  } catch (error) {
    console.error('è®¯é£æ˜Ÿç«æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error)
    sparkStatus.value = 'è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼'
    ElMessage.warning('è®¯é£æ˜Ÿç«æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼ç»§ç»­é¢è¯•')
  }
}

// ç”Ÿæˆä¸‹ä¸€ä¸ªé—®é¢˜
const generateNextQuestion = async () => {
  try {
    console.log('ğŸ¯ å¼€å§‹ç”Ÿæˆé—®é¢˜ï¼Œå½“å‰é¢˜ç›®ç¼–å·:', currentQuestion.value)

    // é¦–å…ˆå°è¯•ä»é—®é¢˜åº“ä¸­è·å–
    const questionIndex = currentQuestion.value - 1
    if (questionIndex < questionBank.value.length) {
      currentQuestionData.value = { ...questionBank.value[questionIndex] }
      console.log('ğŸ“ ä»é—®é¢˜åº“è·å–é—®é¢˜:', currentQuestionData.value.text)
      return
    }

    // å¦‚æœé—®é¢˜åº“ä¸­æ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨AIç”Ÿæˆ
    console.log('ğŸ“ é—®é¢˜åº“ä¸­æ²¡æœ‰æ›´å¤šé—®é¢˜ï¼Œä½¿ç”¨AIç”Ÿæˆ')
    const context = {
      previousAnswers: conversationHistory.value.filter(msg => msg.type === 'user'),
      difficulty: 'medium',
      domain: 'ai',
      candidateProfile: candidateInfo.value,
      questionNumber: currentQuestion.value
    }

    const questionData = await enhancedIflytekSparkService.generateInterviewQuestion(
      sparkSession.value?.sessionId || 'fallback',
      context
    )

    currentQuestionData.value = {
      text: questionData.question,
      type: questionData.type,
      difficulty: questionData.difficulty,
      domain: 'ai',
      domainName: 'AIç®—æ³•'
    }

    // ä¸å†å°†é—®é¢˜æ·»åŠ åˆ°å¯¹è¯å†å²ä¸­ï¼Œé¿å…é‡å¤æ˜¾ç¤º
    // é—®é¢˜å°†åªåœ¨ç‹¬ç«‹çš„"å½“å‰é—®é¢˜é¢æ¿"ä¸­æ˜¾ç¤º
    console.log('âœ… æ–°é—®é¢˜å·²ç”Ÿæˆï¼Œæ˜¾ç¤ºåœ¨é—®é¢˜é¢æ¿ä¸­')

    // å¯åŠ¨å›ç­”æ—¶é—´è®¡æ—¶å™¨
    interviewState.value.responseTimeStart = Date.now()
    interviewState.value.timeoutWarningShown = false

    scrollToBottom()

  } catch (error) {
    console.error('é—®é¢˜ç”Ÿæˆå¤±è´¥:', error)
    ElMessage.error('é—®é¢˜ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
  }
}

// æäº¤å›ç­”
const submitAnswer = async () => {
  console.log('ğŸš€ å¼€å§‹æäº¤å›ç­”æµç¨‹...')

  if (!currentTextInput.value.trim()) {
    ElMessage.warning('è¯·è¾“å…¥æ‚¨çš„å›ç­”')
    return
  }

  console.log('ğŸ“ ç”¨æˆ·è¾“å…¥:', currentTextInput.value)
  isProcessingMultimodal.value = true

  // é‡ç½®æ»šåŠ¨çŠ¶æ€ï¼Œç¡®ä¿èƒ½å¤Ÿè·Ÿéšæ–°æ¶ˆæ¯
  resetScrollStateForNewMessage()

  try {
    // è®°å½•å›ç­”æ—¶é—´ï¼ˆç”¨äºæ—¶é—´æ£€æµ‹ï¼‰
    const responseTime = interviewState.value.responseTimeStart ?
      Date.now() - interviewState.value.responseTimeStart : 0

    // æ·»åŠ ç”¨æˆ·å›ç­”åˆ°å¯¹è¯å†å²
    const userMessage = {
      type: 'user',
      sender: 'å€™é€‰äºº',
      content: currentTextInput.value,
      timestamp: new Date().toLocaleTimeString(),
      responseTime: responseTime,
      analysis: null
    }

    conversationHistory.value.push(userMessage)
    console.log('âœ… ç”¨æˆ·æ¶ˆæ¯å·²æ·»åŠ åˆ°å¯¹è¯å†å²')

    // ç«‹å³æ»šåŠ¨åˆ°ç”¨æˆ·æ¶ˆæ¯åº•éƒ¨
    await nextTick()
    scrollToBottom(true, true) // å¼ºåˆ¶æ»šåŠ¨ï¼Œä½¿ç”¨å¹³æ»‘åŠ¨ç”»
    console.log('ğŸ“œ å·²æ»šåŠ¨åˆ°ç”¨æˆ·æ¶ˆæ¯åº•éƒ¨')

    // é‡ç½®å›ç­”æ—¶é—´è®¡æ—¶å™¨
    interviewState.value.responseTimeStart = null

    // åˆ†æå›ç­”ï¼ˆæ–‡æœ¬ä¼˜å…ˆï¼‰
    console.log('ğŸ” å¼€å§‹åˆ†æç”¨æˆ·å›ç­”...')
    const analysisData = {
      text: currentTextInput.value,
      audio: null, // è¯­éŸ³åŠŸèƒ½å·²ç¦ç”¨
      video: null, // è§†é¢‘åˆ†æå·²ç¦ç”¨
      domain: 'ai',
      questionContext: currentQuestionData.value?.text || 'å½“å‰é—®é¢˜'
    }

    console.log('ğŸ“Š åˆ†ææ•°æ®:', analysisData)
    const analysis = await enhancedIflytekSparkService.analyzeTextPrimaryInput(
      sparkSession.value?.sessionId || 'fallback',
      analysisData
    )
    console.log('âœ… åˆ†æå®Œæˆ:', analysis)

    // æ›´æ–°å®æ—¶åˆ†æç»“æœ
    updateRealTimeAnalysis(analysis)

    // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯çš„åˆ†æç»“æœ
    userMessage.analysis = {
      score: analysis.overallScore,
      keywords: analysis.textAnalysis?.keywords || []
    }

    // ä¸å†æ·»åŠ åˆ†ç¦»çš„åˆ†æåé¦ˆæ¶ˆæ¯ï¼Œæ”¹ä¸ºåœ¨åˆå¹¶çš„AIå›å¤ä¸­å¤„ç†
    // ç”ŸæˆAIé¢è¯•å®˜çš„åˆå¹¶å›å¤ï¼ˆåŒ…å«åˆ†æå’Œå¯¹è¯å¼å›å¤ï¼‰
    console.log('ğŸ¤– å¼€å§‹ç”ŸæˆAIé¢è¯•å®˜åˆå¹¶å›å¤...')
    await generateAIInterviewerResponse(analysis, userMessage.content)
    console.log('âœ… AIé¢è¯•å®˜åˆå¹¶å›å¤ç”Ÿæˆå®Œæˆ')

    // æ¸…ç©ºè¾“å…¥ï¼ˆä½¿ç”¨å¢å¼ºçš„æ¸…ç©ºå‡½æ•°ï¼‰
    await clearInput()

    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom()

    ElMessage.success('å›ç­”å·²æäº¤å¹¶åˆ†æå®Œæˆ')

    // ä¸å†åœ¨è¿™é‡Œè‡ªåŠ¨é€’å¢é¢˜ç›®ï¼Œè®©æ™ºèƒ½è¿‡æ¸¡é€»è¾‘æ¥å¤„ç†
    // è¿™æ ·å¯ä»¥é¿å…é¢˜ç›®è·³è·ƒçš„é—®é¢˜

  } catch (error) {
    console.error('âŒ å›ç­”åˆ†æå¤±è´¥:', error)
    console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.message)
    console.error('âŒ é”™è¯¯å †æ ˆ:', error.stack)

    // æ·»åŠ é”™è¯¯æç¤ºåˆ°å¯¹è¯å†å²
    conversationHistory.value.push({
      type: 'ai',
      sender: 'AIé¢è¯•å®˜',
      content: 'æŠ±æ­‰ï¼Œåˆ†æè¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜ï¼Œä½†æˆ‘ä»ç„¶å¯ä»¥ä¸ºæ‚¨æä¾›ä¸€äº›åé¦ˆã€‚è®©æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚',
      timestamp: new Date().toLocaleTimeString(),
      analysis: { type: 'error' }
    })

    // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå³ä½¿å‡ºé”™ä¹Ÿè¦æ¸…ç©ºï¼‰
    await clearInput()

    // å°è¯•æ»šåŠ¨åˆ°åº•éƒ¨
    try {
      scrollToBottom()
    } catch (scrollError) {
      console.warn('âš ï¸ æ»šåŠ¨å¤±è´¥:', scrollError.message)
    }

    // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    ElMessage.warning('ç³»ç»Ÿæ­£åœ¨ä½¿ç”¨å¤‡ç”¨æ¨¡å¼ï¼ŒåŠŸèƒ½æ­£å¸¸')

  } finally {
    isProcessingMultimodal.value = false
    // ç¡®ä¿è¾“å…¥æ¡†è¢«æ¸…ç©ºï¼ˆåŒé‡ä¿éšœï¼‰
    if (currentTextInput.value.trim()) {
      try {
        await clearInput()
      } catch (clearError) {
        // å¦‚æœæ¸…ç©ºå‡½æ•°å¤±è´¥ï¼Œç›´æ¥è®¾ç½®ä¸ºç©º
        currentTextInput.value = ''
        console.log('ğŸ§¹ Finallyå—ä¸­å¼ºåˆ¶æ¸…ç©ºè¾“å…¥æ¡†')
      }
    }
    console.log('ğŸ”„ æäº¤å›ç­”æµç¨‹ç»“æŸ')
  }
}



// è§£ææ€è€ƒè¿‡ç¨‹ä¸ºç»“æ„åŒ–æ­¥éª¤
const parseThinkingSteps = (thinkingText) => {
  if (!thinkingText) return []

  const steps = []
  const lines = thinkingText.split('\n').filter(line => line.trim())

  let currentStep = null

  lines.forEach(line => {
    line = line.trim()

    // æ£€æµ‹æ­¥éª¤æ ‡é¢˜ï¼ˆåŒ…å«å…³é”®è¯çš„è¡Œï¼‰
    if (line.includes('åˆ†æ') || line.includes('è¯„ä¼°') || line.includes('æ£€æµ‹') ||
        line.includes('æ€è€ƒ') || line.includes('åˆ¤æ–­') || line.includes('ç”Ÿæˆ')) {

      if (currentStep) {
        steps.push(currentStep)
      }

      // æå–æ­¥éª¤æ ‡é¢˜
      let title = 'åˆ†ææ­¥éª¤'
      if (line.includes('åˆ†æ')) title = 'ğŸ“Š å†…å®¹åˆ†æ'
      else if (line.includes('è¯„ä¼°')) title = 'âš–ï¸ è´¨é‡è¯„ä¼°'
      else if (line.includes('æ£€æµ‹')) title = 'ğŸ” å…³é”®è¯æ£€æµ‹'
      else if (line.includes('æ€è€ƒ')) title = 'ğŸ¤” é€»è¾‘æ€è€ƒ'
      else if (line.includes('åˆ¤æ–­')) title = 'ğŸ¯ ç»“æœåˆ¤æ–­'
      else if (line.includes('ç”Ÿæˆ')) title = 'ğŸ’¡ å›å¤ç”Ÿæˆ'

      currentStep = {
        title: title,
        content: line
      }
    } else if (currentStep) {
      // æ·»åŠ åˆ°å½“å‰æ­¥éª¤çš„å†…å®¹
      currentStep.content += '\n' + line
    } else {
      // å¦‚æœæ²¡æœ‰å½“å‰æ­¥éª¤ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤æ­¥éª¤
      currentStep = {
        title: 'ğŸ§  AIæ€è€ƒ',
        content: line
      }
    }
  })

  // æ·»åŠ æœ€åä¸€ä¸ªæ­¥éª¤
  if (currentStep) {
    steps.push(currentStep)
  }

  // å¦‚æœæ²¡æœ‰è§£æå‡ºæ­¥éª¤ï¼Œè¿”å›åŸå§‹å†…å®¹ä½œä¸ºå•ä¸ªæ­¥éª¤
  if (steps.length === 0) {
    steps.push({
      title: 'ğŸ§  AIæ€è€ƒè¿‡ç¨‹',
      content: thinkingText
    })
  }

  return steps
}

// ç”ŸæˆAIåˆ†æåé¦ˆå†…å®¹
const generateAiAnalysisFeedback = (analysis) => {
  const score = analysis.overallScore || 0
  const recommendations = analysis.recommendations || []
  const strengthAreas = analysis.strengthAreas || []
  const improvementAreas = analysis.improvementAreas || []

  let feedback = `ğŸ“Š åˆ†æå®Œæˆ (ç»¼åˆè¯„åˆ†: ${score}åˆ†)\n\n`

  // æ·»åŠ æ€è€ƒè¿‡ç¨‹
  feedback += `ğŸ¤” AIåˆ†ææ€è€ƒè¿‡ç¨‹:\n`
  feedback += `æ­£åœ¨åˆ†ææ‚¨çš„å›ç­”å†…å®¹... æ£€æµ‹åˆ°å…³é”®è¯: ${analysis.textAnalysis?.keywords?.slice(0, 3).join(', ') || 'æ— '}\n`
  feedback += `è¯„ä¼°æŠ€æœ¯æ·±åº¦å’Œè¡¨è¾¾é€»è¾‘... åˆ†æä¸“ä¸šæœ¯è¯­ä½¿ç”¨æƒ…å†µ...\n\n`

  // è¯„ä¼°ç»“æœ
  if (score >= 85) {
    feedback += `âœ… è¯„ä¼°ç»“æœ: å›ç­”è´¨é‡ä¼˜ç§€ï¼`
  } else if (score >= 70) {
    feedback += `ğŸ‘ è¯„ä¼°ç»“æœ: å›ç­”è´¨é‡è‰¯å¥½ï¼Œæœ‰æå‡ç©ºé—´ã€‚`
  } else {
    feedback += `ğŸ’ª è¯„ä¼°ç»“æœ: å›ç­”éœ€è¦æ”¹è¿›ï¼Œå»ºè®®åŠ å¼ºç»ƒä¹ ã€‚`
  }

  // ä¼˜åŠ¿é¢†åŸŸ
  if (strengthAreas.length > 0) {
    feedback += `\n\nğŸŒŸ ä¼˜åŠ¿é¢†åŸŸ: ${strengthAreas.join(', ')}`
  }

  // æ”¹è¿›å»ºè®®
  if (recommendations.length > 0) {
    feedback += `\n\nğŸ’¡ æ”¹è¿›å»ºè®®:\n`
    recommendations.slice(0, 3).forEach((rec, index) => {
      feedback += `${index + 1}. ${rec}\n`
    })
  }

  // éœ€è¦æ”¹è¿›çš„é¢†åŸŸ
  if (improvementAreas.length > 0) {
    feedback += `\nğŸ“ˆ éœ€è¦åŠ å¼º: ${improvementAreas.join(', ')}`
  }

  return feedback
}

// ç”Ÿæˆæ™ºèƒ½é€‚åº”æ€§æ€è€ƒè¿‡ç¨‹
const generateHumanizedThinkingProcess = (analysis, userAnswer) => {
  const score = analysis.overallScore || 0
  const keywords = analysis.textAnalysis?.keywords || []
  const answerLength = userAnswer.length
  const rounds = interviewState.value.conversationRounds
  const isUnknownAnswer = userAnswer.includes('ä¸çŸ¥é“') || userAnswer.includes('ä¸æ¸…æ¥š') || userAnswer.trim().length < 10
  const isTimeoutResponse = checkResponseTime()

  // åˆ†æç”¨æˆ·å›ç­”çš„å…·ä½“å†…å®¹ç‰¹å¾
  const hasProjectExperience = userAnswer.includes('é¡¹ç›®') || userAnswer.includes('å®é™…') || userAnswer.includes('ç»éªŒ')
  const hasTechnicalDetails = userAnswer.includes('ç®—æ³•') || userAnswer.includes('æ¨¡å‹') || userAnswer.includes('æŠ€æœ¯')
  const hasSpecificExamples = userAnswer.includes('æ¯”å¦‚') || userAnswer.includes('ä¾‹å¦‚') || userAnswer.includes('ä¸¾ä¾‹')
  const isDetailedAnswer = userAnswer.length > 200

  let thinking = ''

  // æ ¹æ®å¯¹è¯è½®æ¬¡å’Œå›ç­”æ¨¡å¼ç”Ÿæˆé€‚åº”æ€§æ€è€ƒ
  if (interviewState.value.consecutiveUnknownAnswers >= 2) {
    thinking = `å€™é€‰äººå·²ç»è¿ç»­å‡ æ¬¡è¡¨ç¤ºä¸äº†è§£äº†...è¿™ç§æƒ…å†µä¸‹æˆ‘éœ€è¦è°ƒæ•´ç­–ç•¥ã€‚\n\n`
    thinking += `ä¸å…¶ç»§ç»­é—®æŠ€æœ¯ç»†èŠ‚ï¼Œä¸å¦‚äº†è§£ä¸€ä¸‹å€™é€‰äººçš„å­¦ä¹ èƒŒæ™¯å’ŒåŠ¨æœºã€‚æ¯ä¸ªäººçš„èµ·ç‚¹ä¸åŒï¼Œå…³é”®æ˜¯è¦çœ‹å­¦ä¹ èƒ½åŠ›å’Œæ€åº¦ã€‚\n\n`
    thinking += `æˆ‘åº”è¯¥æä¾›ä¸€äº›å…·ä½“çš„æŒ‡å¯¼ï¼Œå¸®åŠ©å€™é€‰äººå»ºç«‹ä¿¡å¿ƒï¼Œç„¶åä»æ›´åŸºç¡€çš„è§’åº¦é‡æ–°å¼€å§‹ã€‚`
  } else if (isTimeoutResponse && !interviewState.value.timeoutWarningShown) {
    thinking = `å€™é€‰äººæ€è€ƒäº†å¾ˆé•¿æ—¶é—´...è¿™å¯èƒ½è¯´æ˜é—®é¢˜å¯¹ä»–ä»¬æ¥è¯´æœ‰ä¸€å®šéš¾åº¦ã€‚\n\n`
    thinking += `é•¿æ—¶é—´çš„æ²‰é»˜åœ¨é¢è¯•ä¸­å…¶å®ä¸å¤ªå¥½ï¼Œæˆ‘åº”è¯¥æé†’å€™é€‰äººå¯ä»¥å…ˆè¯´å‡ºéƒ¨åˆ†æƒ³æ³•ï¼Œç„¶åå†é€æ­¥å®Œå–„ã€‚\n\n`
    thinking += `è®©æˆ‘ç»™å‡ºä¸€äº›æ—¶é—´ç®¡ç†çš„å»ºè®®ï¼Œå¸®åŠ©å€™é€‰äººæ›´å¥½åœ°åº”å¯¹é¢è¯•ã€‚`
  } else if (interviewState.value.consecutiveSimilarResponses >= 2 && rounds >= 4) {
    thinking = `æˆ‘æ³¨æ„åˆ°æœ€è¿‘å‡ è½®å¯¹è¯çš„æ¨¡å¼æ¯”è¾ƒç›¸ä¼¼...å¯èƒ½éœ€è¦æ¢ä¸ªè§’åº¦äº†ã€‚\n\n`
    thinking += `ç»§ç»­ç”¨åŒæ ·çš„æ–¹å¼å¯èƒ½ä¸ä¼šæœ‰æ–°çš„çªç ´ï¼Œæˆ‘åº”è¯¥å°è¯•ä¸åŒçš„æé—®ç­–ç•¥ï¼Œæˆ–è€…äº†è§£å€™é€‰äººçš„å…¶ä»–æ–¹é¢ã€‚\n\n`
    thinking += `è®©æˆ‘æƒ³æƒ³å¦‚ä½•ä»æ–°çš„è§’åº¦æ¥è¯„ä¼°å€™é€‰äººçš„èƒ½åŠ›...`
  } else {
    // æ­£å¸¸çš„æ€è€ƒè¿‡ç¨‹ - åŸºäºå…·ä½“å›ç­”å†…å®¹
    // ç¬¬ä¸€å°è±¡æ€è€ƒ
    if (isDetailedAnswer) {
      thinking += `å“‡ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆè¯¦ç»†çš„å›ç­”ï¼å€™é€‰äººæä¾›äº†${answerLength}å­—ç¬¦çš„å†…å®¹ï¼Œè®©æˆ‘ä»”ç»†åˆ†æä¸€ä¸‹ã€‚\n\n`
    } else if (answerLength < 20) {
      thinking += `å›ç­”æ¯”è¾ƒç®€çŸ­ï¼Œåªæœ‰${answerLength}å­—ç¬¦...è®©æˆ‘çœ‹çœ‹æ˜¯å¦èƒ½ä»ä¸­è·å¾—æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚\n\n`
    } else {
      thinking += `å›ç­”é•¿åº¦é€‚ä¸­ï¼ˆ${answerLength}å­—ç¬¦ï¼‰ï¼Œè®©æˆ‘åˆ†æä¸€ä¸‹å†…å®¹çš„è´¨é‡ã€‚\n\n`
    }

    // å†…å®¹ç‰¹å¾åˆ†æ
    if (isUnknownAnswer) {
      thinking += `å€™é€‰äººè¯šå®åœ°è¡¨è¾¾äº†ä¸äº†è§£ï¼Œè¿™ç§æ€åº¦å¾ˆå¥½ã€‚è¯šå®æ¯”èƒ¡ç¼–ä¹±é€ è¦å¼ºå¾—å¤šã€‚`
    } else {
      // åˆ†æå…·ä½“æŠ€æœ¯å†…å®¹
      if (userAnswer.includes('çŸ¥è¯†è’¸é¦') || userAnswer.includes('Knowledge Distillation')) {
        thinking += `å€™é€‰äººæåˆ°äº†çŸ¥è¯†è’¸é¦æŠ€æœ¯ï¼Œè¿™æ˜¯æ¨¡å‹å‹ç¼©çš„é‡è¦æ–¹æ³•ã€‚è®©æˆ‘çœ‹çœ‹ç†è§£æ·±åº¦å¦‚ä½•ã€‚`
      } else if (userAnswer.includes('YOLOv4') || userAnswer.includes('ç›®æ ‡æ£€æµ‹')) {
        thinking += `å€™é€‰äººè°ˆåˆ°äº†ç›®æ ‡æ£€æµ‹å’ŒYOLOv4ï¼Œè¿™æ˜¯è®¡ç®—æœºè§†è§‰çš„çƒ­é—¨é¢†åŸŸã€‚`
      } else if (hasProjectExperience) {
        thinking += `å¾ˆå¥½ï¼å€™é€‰äººæåˆ°äº†é¡¹ç›®ç»éªŒï¼Œè¿™æ¯”çº¯ç†è®ºå›ç­”æ›´æœ‰ä»·å€¼ã€‚`
      } else if (hasTechnicalDetails) {
        thinking += `å€™é€‰äººå±•ç°äº†ä¸€å®šçš„æŠ€æœ¯ç†è§£ï¼Œæåˆ°äº†ç›¸å…³çš„æŠ€æœ¯æ¦‚å¿µã€‚`
      } else if (keywords.length > 0) {
        thinking += `ä»å›ç­”ä¸­è¯†åˆ«åˆ°å…³é”®è¯ï¼š${keywords.slice(0, 2).join('ã€')}ã€‚`
      } else {
        thinking += `å›ç­”æ¯”è¾ƒé€šç”¨ï¼Œç¼ºä¹å…·ä½“çš„æŠ€æœ¯ç»†èŠ‚ã€‚`
      }
    }

    thinking += `\n\n`

    // æ·±åº¦åˆ†æ
    if (hasSpecificExamples) {
      thinking += `å€™é€‰äººç»™å‡ºäº†å…·ä½“ä¾‹å­ï¼Œè¿™è¯´æ˜æœ‰å®é™…çš„ç†è§£å’Œç»éªŒã€‚`
    }
    if (hasTechnicalDetails && hasProjectExperience) {
      thinking += `æ—¢æœ‰æŠ€æœ¯ç†è®ºåˆæœ‰é¡¹ç›®å®è·µï¼Œè¿™æ˜¯å¾ˆå¥½çš„ç»„åˆã€‚`
    }

    thinking += `\n\n`

    // åŸºäºå¯¹è¯æµç¨‹çš„æ™ºèƒ½æ€è€ƒè¿‡ç¨‹
    const flow = conversationScoring.value.conversationFlow
    const currentScore = conversationScoring.value.currentQuestionScore
    const conversationRounds = interviewState.value.conversationRounds

    thinking += `å¯¹è¯æµç¨‹åˆ†æï¼šå•æ¬¡å›ç­”${score}åˆ†ï¼Œå¯¹è¯æµç¨‹ç´¯ç§¯${currentScore}åˆ†ï¼Œæ€»è½®æ¬¡${flow.totalTurns}ï¼Œæœ‰æ„ä¹‰è½®æ¬¡${flow.meaningfulTurns}ï¼Œæ¦‚å¿µè¦†ç›–${flow.conceptsCovered.size}ä¸ªï¼Œæ·±åº¦å±‚çº§${flow.topicDepth}ã€‚`

    if (currentScore >= 85) {
      thinking += `å¯¹è¯æµç¨‹è¯„åˆ†${currentScore}åˆ†ï¼Œè¿™æ˜¯ä¸€ä¸ªå“è¶Šçš„å¯¹è¯è¡¨ç°ï¼å€™é€‰äººä¸ä»…åœ¨æŠ€æœ¯å†…å®¹ä¸Šè¡¨ç°å‡ºè‰²ï¼Œæ•´ä¸ªå¯¹è¯è¿‡ç¨‹å±•ç°äº†æ·±åº¦æ€è€ƒã€æ¦‚å¿µæ•´åˆå’Œå®è·µç»éªŒã€‚åŸºäºå¯¹è¯æµç¨‹çš„å®Œæ•´æ€§å’Œè´¨é‡ï¼Œè¿™ä¸ªé—®é¢˜å·²ç»å¾—åˆ°äº†å……åˆ†çš„æ¢è®¨ã€‚`
      interviewState.value.shouldTransitionToNext = true
    } else if (currentScore >= 75) {
      thinking += `å¯¹è¯æµç¨‹è¯„åˆ†${currentScore}åˆ†ï¼Œæ•´ä½“å¯¹è¯è´¨é‡å¾ˆå¥½ï¼å€™é€‰äººåœ¨æŠ€æœ¯ç†è§£ã€æ¦‚å¿µè¿ç”¨å’Œè¡¨è¾¾é€»è¾‘æ–¹é¢éƒ½è¡¨ç°ä¸é”™ï¼Œå¯¹è¯å‘ˆç°è‰¯å¥½çš„é€’è¿›æ€§ã€‚è¿™ä¸ªé—®é¢˜åŸºæœ¬å·²ç»å¾—åˆ°äº†å……åˆ†çš„å›ç­”ã€‚`
      interviewState.value.shouldTransitionToNext = true
    } else if (currentScore >= 60) {
      thinking += `å¯¹è¯æµç¨‹è¯„åˆ†${currentScore}åˆ†ï¼Œå¯¹è¯è´¨é‡è‰¯å¥½ï¼Œæ˜¾ç¤ºäº†ä¸€å®šçš„æŠ€æœ¯åŸºç¡€ã€‚æˆ‘å¯ä»¥é€šè¿‡è¿½é—®æ¥è¿›ä¸€æ­¥äº†è§£å€™é€‰äººçš„æ·±åº¦ç†è§£ï¼Œæˆ–è€…æ ¹æ®å¯¹è¯å®Œæ•´æ€§è€ƒè™‘ä¸‹ä¸€æ­¥ã€‚`
      interviewState.value.shouldTransitionToNext = false
    } else if (currentScore >= 40) {
      thinking += `å¯¹è¯æµç¨‹è¯„åˆ†${currentScore}åˆ†ï¼Œå¯¹è¯æ˜¾ç¤ºå‡ºåŸºç¡€ç†è§£ï¼Œä½†åœ¨æ·±åº¦ã€å®ä¾‹å’Œæ¦‚å¿µæ•´åˆæ–¹é¢è¿˜æœ‰æå‡ç©ºé—´ã€‚æˆ‘éœ€è¦é€šè¿‡å¼•å¯¼æ¥å¸®åŠ©å€™é€‰äººæ›´å¥½åœ°å±•ç¤ºèƒ½åŠ›ã€‚`
      interviewState.value.shouldTransitionToNext = false
    } else {
      thinking += `å¯¹è¯æµç¨‹è¯„åˆ†${currentScore}åˆ†ï¼Œå¯¹è¯è´¨é‡éœ€è¦æ”¹å–„ã€‚æˆ‘åº”è¯¥æä¾›æ›´å¤šå…·ä½“çš„æŒ‡å¯¼å’Œé¼“åŠ±ï¼Œå¸®åŠ©å€™é€‰äººå»ºç«‹ä¿¡å¿ƒå¹¶æ”¹å–„è¡¨è¾¾æ–¹å¼ã€‚`
      interviewState.value.shouldTransitionToNext = false
    }

    thinking += `\n\n`

    // ä¸ªæ€§åŒ–çš„ä¸‹ä¸€æ­¥ç­–ç•¥
    if (score >= 85) {
      thinking += `æ—¢ç„¶æŠ€æœ¯åŸºç¡€æ‰å®ï¼Œæˆ‘æƒ³äº†è§£æ›´å¤šå®é™…åº”ç”¨ç»éªŒå’Œé‡åˆ°çš„æŒ‘æˆ˜ã€‚`
    } else if (score >= 70) {
      thinking += `æˆ‘å¯ä»¥é€šè¿‡å…·ä½“ä¾‹å­æ¥å¸®åŠ©å€™é€‰äººæ›´å¥½åœ°å±•ç¤ºè‡ªå·±çš„ç†è§£ã€‚`
    } else {
      thinking += `æˆ‘éœ€è¦æä¾›æ›´å¤šæ”¯æŒå’Œå¼•å¯¼ï¼Œå¸®åŠ©å€™é€‰äººå»ºç«‹ä¿¡å¿ƒã€‚`
    }
  }

  return thinking
}

// æ™ºèƒ½é¢è¯•å®˜çŠ¶æ€ç®¡ç†
const interviewState = ref({
  responseTimeStart: null,
  conversationRounds: 0,
  lastResponseType: null,
  consecutiveUnknownAnswers: 0,
  consecutiveSimilarResponses: 0,
  hasProvidedAnswer: false,
  timeoutWarningShown: false,
  shouldTransitionToNext: false,
  currentQuestionSatisfied: false,
  isPaused: false
})

// å¯¹è¯æµç¨‹ç»¼åˆè¯„åˆ†ç³»ç»Ÿ - çœŸæ­£åŸºäºæ•´ä¸ªå¯¹è¯è¿‡ç¨‹çš„è¯„åˆ†
const conversationScoring = ref({
  // å½“å‰é—®é¢˜çš„å¯¹è¯æµç¨‹åˆ†æ•°ï¼ˆä»0å¼€å§‹ï¼Œé€æ­¥ç´¯ç§¯ï¼‰
  currentQuestionScore: 0,

  // æµç•…åº¦æŒ‡æ ‡
  fluencyMetrics: {
    responseTime: [],        // å“åº”æ—¶é—´è®°å½•
    topicContinuity: 0,     // è¯é¢˜è¿ç»­æ€§åˆ†æ•°
    interactionQuality: 0,   // äº’åŠ¨è´¨é‡åˆ†æ•°
    averageResponseTime: 0   // å¹³å‡å“åº”æ—¶é—´
  },

  // ç´¯ç§¯è¯„åˆ†å†å²
  answerHistory: [],

  // å¯¹è¯æµç¨‹çŠ¶æ€è·Ÿè¸ª
  conversationFlow: {
    totalTurns: 0,           // æ€»å¯¹è¯è½®æ¬¡
    meaningfulTurns: 0,      // æœ‰æ„ä¹‰çš„å¯¹è¯è½®æ¬¡
    topicDepth: 0,          // è¯é¢˜æ·±å…¥ç¨‹åº¦
    conceptsCovered: new Set(), // å·²è¦†ç›–çš„æ¦‚å¿µ
    examplesProvided: 0,     // æä¾›çš„å®ä¾‹æ•°é‡
    clarificationsAsked: 0,  // ä¸»åŠ¨æ¾„æ¸…æ¬¡æ•°
    buildOnPrevious: 0       // åŸºäºå‰ä¸€è½®å¯¹è¯çš„å›ç­”æ¬¡æ•°
  },

  // åˆ†æ•°ç´¯ç§¯è§„åˆ™
  scoringRules: {
    // åŸºç¡€åˆ†æ•°å¢é‡ï¼ˆæ¯è½®å¯¹è¯çš„åŸºç¡€åˆ†ï¼‰
    baseIncrement: 8,

    // è´¨é‡åŠ æˆç³»æ•°
    qualityMultipliers: {
      excellent: 1.5,        // ä¼˜ç§€å›ç­”ï¼šåŸºç¡€åˆ† Ã— 1.5
      good: 1.2,            // è‰¯å¥½å›ç­”ï¼šåŸºç¡€åˆ† Ã— 1.2
      average: 1.0,         // ä¸€èˆ¬å›ç­”ï¼šåŸºç¡€åˆ† Ã— 1.0
      poor: 0.5,            // è¾ƒå·®å›ç­”ï¼šåŸºç¡€åˆ† Ã— 0.5
      veryPoor: 0.2         // å¾ˆå·®å›ç­”ï¼šåŸºç¡€åˆ† Ã— 0.2
    },

    // å¯¹è¯æµç¨‹åŠ æˆ
    flowBonuses: {
      topicContinuity: 5,    // è¯é¢˜è¿ç»­æ€§åŠ æˆ
      depthProgression: 8,   // æ·±åº¦é€’è¿›åŠ æˆ
      exampleProvision: 6,   // æä¾›å®ä¾‹åŠ æˆ
      activeEngagement: 4,   // ä¸»åŠ¨å‚ä¸åŠ æˆ
      conceptIntegration: 7  // æ¦‚å¿µæ•´åˆåŠ æˆ
    },

    // ç´¯ç§¯é˜ˆå€¼è®¾ç½®
    thresholds: {
      basic: 40,            // åŸºç¡€ç†è§£é˜ˆå€¼
      competent: 65,        // èƒœä»»èƒ½åŠ›é˜ˆå€¼
      proficient: 80,       // ç†Ÿç»ƒæŒæ¡é˜ˆå€¼
      expert: 95            // ä¸“å®¶æ°´å¹³é˜ˆå€¼
    }
  },

  // è‡ªåŠ¨è·³é¢˜æ¡ä»¶
  transitionConditions: {
    scoreThreshold: 75,      // åˆ†æ•°é˜ˆå€¼
    minTurns: 2,            // æœ€å°‘å¯¹è¯è½®æ¬¡
    maxTurns: 6,            // æœ€å¤šå¯¹è¯è½®æ¬¡
    conceptCoverage: 3,      // æœ€å°‘æ¦‚å¿µè¦†ç›–æ•°
    depthRequirement: 2      // æœ€ä½æ·±åº¦è¦æ±‚
  }
})

// æ£€æµ‹å›ç­”æ—¶é—´è¿‡é•¿
const checkResponseTime = () => {
  if (!interviewState.value.responseTimeStart) return false

  const elapsed = Date.now() - interviewState.value.responseTimeStart
  const timeoutThreshold = 45000 // 45ç§’è¶…æ—¶é˜ˆå€¼

  return elapsed > timeoutThreshold
}

// æ£€æµ‹é‡å¤æ€§å›å¤æ¨¡å¼
const detectRepetitivePattern = (currentResponseType) => {
  if (currentResponseType === interviewState.value.lastResponseType) {
    interviewState.value.consecutiveSimilarResponses++
  } else {
    interviewState.value.consecutiveSimilarResponses = 0
  }

  if (currentResponseType === 'unknown') {
    interviewState.value.consecutiveUnknownAnswers++
  } else {
    interviewState.value.consecutiveUnknownAnswers = 0
  }

  interviewState.value.lastResponseType = currentResponseType
  return {
    isRepetitive: interviewState.value.consecutiveSimilarResponses >= 2,
    tooManyUnknown: interviewState.value.consecutiveUnknownAnswers >= 2
  }
}

// æ™ºèƒ½è¯­ä¹‰åˆ†æ - åŒºåˆ†ç”¨æˆ·çš„çœŸå®æ„å›¾
const analyzeUserIntent = (userAnswer) => {
  const answer = userAnswer.toLowerCase().trim()

  // ç›´æ¥è¦ç­”æ¡ˆçš„è¡¨è¾¾æ¨¡å¼
  const directAnswerPatterns = [
    /æˆ‘ä¸çŸ¥é“.*è¯·å‘Šè¯‰æˆ‘.*ç­”æ¡ˆ/,
    /ä¸çŸ¥é“.*æ­£ç¡®ç­”æ¡ˆæ˜¯ä»€ä¹ˆ/,
    /è¯·ç›´æ¥å‘Šè¯‰æˆ‘.*ç­”æ¡ˆ/,
    /èƒ½å¦ç»™å‡º.*æ ‡å‡†ç­”æ¡ˆ/,
    /è¯·æä¾›.*æ­£ç¡®ç­”æ¡ˆ/,
    /å‘Šè¯‰æˆ‘.*ç­”æ¡ˆ.*å§/,
    /æˆ‘å®Œå…¨ä¸çŸ¥é“.*è¯·ç»™å‡ºç­”æ¡ˆ/,
    /ä¸ä¼š.*è¯·å‘Šè¯‰æˆ‘æ€ä¹ˆåš/,
    /è¯·ç»™å‡º.*å…·ä½“ç­”æ¡ˆ/
  ]

  // è¦æ€è·¯å¼•å¯¼çš„è¡¨è¾¾æ¨¡å¼
  const guidancePatterns = [
    /è¯·ç»™æˆ‘.*æ€è·¯/,
    /èƒ½å¦æä¾›.*æ€è·¯/,
    /ç»™æˆ‘ä¸€äº›.*æ–¹å‘/,
    /è¯·æŒ‡å¯¼.*æ–¹å‘/,
    /èƒ½å¦å¼•å¯¼.*æ€è€ƒ/,
    /ç»™æˆ‘ä¸€äº›.*æç¤º/,
    /è¯·æä¾›.*æ€è€ƒæ–¹å‘/,
    /èƒ½å¦ç»™ä¸€äº›.*å»ºè®®/,
    /å¸Œæœ›å¾—åˆ°.*æŒ‡å¯¼/,
    /è¯·å¸®æˆ‘.*åˆ†æ/
  ]

  // è¡¨è¾¾ä¸çŸ¥é“çš„æ¨¡å¼
  const unknownPatterns = [
    /ä¸çŸ¥é“/,
    /ä¸æ¸…æ¥š/,
    /æ²¡æœ‰ç»éªŒ/,
    /ä¸äº†è§£/,
    /ä¸ä¼š/,
    /æ²¡åšè¿‡/,
    /ä¸å¤ªæ‡‚/,
    /ä¸ç¡®å®š/,
    /å®Œå…¨ä¸æ‡‚/,
    /ä¸€ç‚¹éƒ½ä¸çŸ¥é“/,
    /ä»æ¥æ²¡æ¥è§¦è¿‡/
  ]

  // æ£€æµ‹æ„å›¾
  const isRequestingAnswer = directAnswerPatterns.some(pattern => pattern.test(answer))
  const isRequestingGuidance = guidancePatterns.some(pattern => pattern.test(answer))
  const isUnknown = unknownPatterns.some(pattern => pattern.test(answer)) &&
                   !isRequestingAnswer && !isRequestingGuidance

  // ç‰¹æ®Šæƒ…å†µï¼šå¦‚æœå›ç­”å¾ˆçŸ­ä¸”åŒ…å«"ä¸çŸ¥é“"ï¼Œä½†æ²¡æœ‰æ˜ç¡®è¦æ±‚ï¼Œé»˜è®¤ä¸ºéœ€è¦å¼•å¯¼
  if (answer.length < 20 && unknownPatterns.some(pattern => pattern.test(answer))) {
    return {
      isUnknown: true,
      isRequestingAnswer: false,
      isRequestingGuidance: false,
      intent: 'unknown'
    }
  }

  // ç¡®å®šä¸»è¦æ„å›¾
  let intent = 'normal'
  if (isRequestingAnswer) intent = 'request_answer'
  else if (isRequestingGuidance) intent = 'request_guidance'
  else if (isUnknown) intent = 'unknown'

  return {
    isUnknown,
    isRequestingAnswer,
    isRequestingGuidance,
    intent,
    confidence: isRequestingAnswer || isRequestingGuidance ? 0.9 : 0.7
  }
}

// ç”ŸæˆæŠ€æœ¯æ ‡å‡†ç­”æ¡ˆ
const generateTechnicalAnswer = (questionNumber) => {
  const technicalAnswers = {
    1: `å…³äºæœºå™¨å­¦ä¹ æ¨¡å‹ä¼˜åŒ–ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®æ–¹é¢ï¼š

**1. ç®—æ³•å±‚é¢ä¼˜åŒ–**
- é€‰æ‹©åˆé€‚çš„ç®—æ³•ï¼šæ ¹æ®æ•°æ®ç‰¹ç‚¹é€‰æ‹©çº¿æ€§æ¨¡å‹ã€æ ‘æ¨¡å‹æˆ–ç¥ç»ç½‘ç»œ
- è¶…å‚æ•°è°ƒä¼˜ï¼šä½¿ç”¨ç½‘æ ¼æœç´¢ã€éšæœºæœç´¢æˆ–è´å¶æ–¯ä¼˜åŒ–
- é›†æˆå­¦ä¹ ï¼šé€šè¿‡Baggingã€Boostingç­‰æ–¹æ³•æå‡æ€§èƒ½

**2. æ•°æ®å±‚é¢ä¼˜åŒ–**
- ç‰¹å¾å·¥ç¨‹ï¼šç‰¹å¾é€‰æ‹©ã€ç‰¹å¾æ„é€ ã€ç‰¹å¾å˜æ¢
- æ•°æ®é¢„å¤„ç†ï¼šæ ‡å‡†åŒ–ã€å½’ä¸€åŒ–ã€ç¼ºå¤±å€¼å¤„ç†
- æ•°æ®å¢å¼ºï¼šé€šè¿‡åˆæˆæ•°æ®æ‰©å……è®­ç»ƒé›†

**3. ç³»ç»Ÿå±‚é¢ä¼˜åŒ–**
- æ¨¡å‹å‹ç¼©ï¼šé‡åŒ–ã€å‰ªæã€è’¸é¦
- ç¡¬ä»¶åŠ é€Ÿï¼šGPUå¹¶è¡Œã€åˆ†å¸ƒå¼è®­ç»ƒ
- æ¨ç†ä¼˜åŒ–ï¼šæ¨¡å‹è½¬æ¢ã€æ‰¹å¤„ç†ã€ç¼“å­˜ç­–ç•¥`,

    2: `å…³äºå¤§æ•°æ®å¤„ç†æ¶æ„è®¾è®¡ï¼Œæ ‡å‡†çš„è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š

**1. æ•°æ®é‡‡é›†å±‚**
- å®æ—¶é‡‡é›†ï¼šKafkaã€Flumeã€Logstash
- æ‰¹é‡é‡‡é›†ï¼šSqoopã€DataX
- APIæ¥å£ï¼šRESTful APIã€GraphQL

**2. æ•°æ®å­˜å‚¨å±‚**
- åˆ†å¸ƒå¼å­˜å‚¨ï¼šHDFSã€å¯¹è±¡å­˜å‚¨
- NoSQLæ•°æ®åº“ï¼šHBaseã€Cassandraã€MongoDB
- æ•°æ®ä»“åº“ï¼šHiveã€ClickHouseã€Snowflake

**3. æ•°æ®å¤„ç†å±‚**
- æ‰¹å¤„ç†ï¼šSparkã€MapReduceã€Flink
- æµå¤„ç†ï¼šStormã€Kafka Streams
- æ··åˆå¤„ç†ï¼šLambdaæ¶æ„ã€Kappaæ¶æ„

**4. æ•°æ®æœåŠ¡å±‚**
- æŸ¥è¯¢å¼•æ“ï¼šPrestoã€Impala
- å¯è§†åŒ–ï¼šTableauã€Grafana
- APIæœåŠ¡ï¼šå¾®æœåŠ¡æ¶æ„`,

    3: `å…³äºIoTç³»ç»Ÿæ¶æ„ï¼Œå®Œæ•´çš„è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š

**1. è®¾å¤‡å±‚**
- ä¼ æ„Ÿå™¨ç½‘ç»œï¼šæ¸©åº¦ã€æ¹¿åº¦ã€å‹åŠ›ç­‰ä¼ æ„Ÿå™¨
- é€šä¿¡åè®®ï¼šMQTTã€CoAPã€LoRaWAN
- è¾¹ç¼˜è®¡ç®—ï¼šè¾¹ç¼˜ç½‘å…³ã€æœ¬åœ°å¤„ç†

**2. è¿æ¥å±‚**
- ç½‘ç»œåè®®ï¼šWiFiã€è“ç‰™ã€5Gã€NB-IoT
- æ•°æ®ä¼ è¾“ï¼šåŠ å¯†ã€å‹ç¼©ã€ç¼“å­˜
- è®¾å¤‡ç®¡ç†ï¼šæ³¨å†Œã€è®¤è¯ã€ç›‘æ§

**3. å¹³å°å±‚**
- æ•°æ®æ¥å…¥ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€åè®®è½¬æ¢
- æ•°æ®å­˜å‚¨ï¼šæ—¶åºæ•°æ®åº“ã€å…³ç³»æ•°æ®åº“
- ä¸šåŠ¡é€»è¾‘ï¼šè§„åˆ™å¼•æ“ã€å·¥ä½œæµ

**4. åº”ç”¨å±‚**
- æ•°æ®åˆ†æï¼šå®æ—¶åˆ†æã€å†å²åˆ†æ
- å¯è§†åŒ–ï¼šä»ªè¡¨æ¿ã€æŠ¥è¡¨
- æ§åˆ¶æŒ‡ä»¤ï¼šè¿œç¨‹æ§åˆ¶ã€è‡ªåŠ¨åŒ–`
  }

  return technicalAnswers[questionNumber] || `è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æŠ€æœ¯é—®é¢˜ã€‚æ ‡å‡†çš„è§£å†³æ–¹æ¡ˆé€šå¸¸åŒ…æ‹¬ï¼š
- ç†è®ºåŸºç¡€çš„æŒæ¡
- å®è·µç»éªŒçš„ç§¯ç´¯
- å·¥å…·å’ŒæŠ€æœ¯çš„ç†Ÿç»ƒè¿ç”¨
- é—®é¢˜åˆ†æå’Œè§£å†³èƒ½åŠ›çš„åŸ¹å…»`
}

// ç”Ÿæˆæ€è·¯å¼•å¯¼
const generateGuidanceThoughts = (questionNumber) => {
  const guidanceThoughts = {
    1: `å…³äºæœºå™¨å­¦ä¹ æ¨¡å‹ä¼˜åŒ–ï¼Œæ‚¨å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥æ€è€ƒï¼š

**ğŸ’¡ æ€è€ƒè§’åº¦1ï¼šæ€§èƒ½ä¼˜åŒ–**
- æ‚¨è§‰å¾—ä»€ä¹ˆæŒ‡æ ‡æœ€èƒ½åæ˜ æ¨¡å‹çš„å¥½åï¼Ÿ
- åœ¨æ‚¨çš„ç†è§£ä¸­ï¼Œè¿‡æ‹Ÿåˆå’Œæ¬ æ‹Ÿåˆæ˜¯ä»€ä¹ˆæ¦‚å¿µï¼Ÿ

**ğŸ’¡ æ€è€ƒè§’åº¦2ï¼šå®é™…åº”ç”¨**
- æ‚¨æœ‰æ²¡æœ‰æ¥è§¦è¿‡ä»»ä½•æœºå™¨å­¦ä¹ çš„åº”ç”¨åœºæ™¯ï¼Ÿ
- æ¯”å¦‚æ¨èç³»ç»Ÿã€å›¾åƒè¯†åˆ«ç­‰ï¼Œæ‚¨è§‰å¾—å®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

**ğŸ’¡ æ€è€ƒè§’åº¦3ï¼šå­¦ä¹ ç»éªŒ**
- æ‚¨æ˜¯é€šè¿‡ä»€ä¹ˆé€”å¾„äº†è§£æœºå™¨å­¦ä¹ çš„ï¼Ÿ
- åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œæ‚¨è§‰å¾—æœ€æœ‰æŒ‘æˆ˜æ€§çš„éƒ¨åˆ†æ˜¯ä»€ä¹ˆï¼Ÿ`,

    2: `å…³äºå¤§æ•°æ®å¤„ç†ï¼Œæ‚¨å¯ä»¥ä»è¿™äº›æ–¹é¢æ¥è€ƒè™‘ï¼š

**ğŸ’¡ æ€è€ƒè§’åº¦1ï¼šæ•°æ®è§„æ¨¡**
- æ‚¨ç†è§£çš„"å¤§æ•°æ®"æ˜¯ä»€ä¹ˆæ¦‚å¿µï¼Ÿ
- æ‚¨è§‰å¾—ä¼ ç»Ÿæ•°æ®åº“å’Œå¤§æ•°æ®å¤„ç†æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**ğŸ’¡ æ€è€ƒè§’åº¦2ï¼šå¤„ç†æµç¨‹**
- æ‚¨è§‰å¾—å¤„ç†å¤§é‡æ•°æ®æ—¶ï¼Œä¸»è¦çš„æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ
- æ•°æ®ä»äº§ç”Ÿåˆ°æœ€ç»ˆä½¿ç”¨ï¼Œæ‚¨è§‰å¾—éœ€è¦ç»è¿‡å“ªäº›æ­¥éª¤ï¼Ÿ

**ğŸ’¡ æ€è€ƒè§’åº¦3ï¼šæŠ€æœ¯å·¥å…·**
- æ‚¨å¬è¯´è¿‡å“ªäº›å¤§æ•°æ®ç›¸å…³çš„æŠ€æœ¯æˆ–å·¥å…·ï¼Ÿ
- å³ä½¿ä¸æ·±å…¥äº†è§£ï¼Œæ‚¨è§‰å¾—å®ƒä»¬å¯èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ`,

    3: `å…³äºIoTç‰©è”ç½‘ç³»ç»Ÿï¼Œæ‚¨å¯ä»¥è¿™æ ·æ€è€ƒï¼š

**ğŸ’¡ æ€è€ƒè§’åº¦1ï¼šç”Ÿæ´»åº”ç”¨**
- æ‚¨åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­æ¥è§¦è¿‡å“ªäº›æ™ºèƒ½è®¾å¤‡ï¼Ÿ
- æ‚¨è§‰å¾—è¿™äº›è®¾å¤‡æ˜¯å¦‚ä½•"è”ç½‘"å’Œ"æ™ºèƒ½"çš„ï¼Ÿ

**ğŸ’¡ æ€è€ƒè§’åº¦2ï¼šç³»ç»Ÿæ¶æ„**
- ä»è®¾å¤‡åˆ°æ‰‹æœºAPPï¼Œæ‚¨è§‰å¾—æ•°æ®æ˜¯æ€ä¹ˆä¼ è¾“çš„ï¼Ÿ
- æ‚¨è§‰å¾—éœ€è¦å“ªäº›æŠ€æœ¯ç¯èŠ‚æ¥æ”¯æ’‘è¿™ä¸ªè¿‡ç¨‹ï¼Ÿ

**ğŸ’¡ æ€è€ƒè§’åº¦3ï¼šæŠ€æœ¯æŒ‘æˆ˜**
- æ‚¨è§‰å¾—ç‰©è”ç½‘ç³»ç»Ÿå¯èƒ½é¢ä¸´å“ªäº›æŠ€æœ¯éš¾é¢˜ï¼Ÿ
- æ¯”å¦‚å®‰å…¨æ€§ã€ç¨³å®šæ€§ç­‰æ–¹é¢ï¼Œæ‚¨æœ‰ä»€ä¹ˆæƒ³æ³•ï¼Ÿ`
  }

  return guidanceThoughts[questionNumber] || `æ‚¨å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥æ€è€ƒè¿™ä¸ªé—®é¢˜ï¼š
- åŸºç¡€æ¦‚å¿µçš„ç†è§£
- å®é™…åº”ç”¨çš„åœºæ™¯
- å¯èƒ½é‡åˆ°çš„æŒ‘æˆ˜
- è§£å†³é—®é¢˜çš„æ€è·¯`
}

// ç”Ÿæˆæ™ºèƒ½é€‚åº”æ€§é¢è¯•å®˜å›å¤
const generateHumanizedInterviewerResponse = (analysis, userAnswer, score, keywords, recommendations) => {
  // æ›´æ–°å¯¹è¯è½®æ¬¡
  interviewState.value.conversationRounds++

  // æ™ºèƒ½è¯­ä¹‰ç†è§£ - åŒºåˆ†ä¸åŒçš„æ±‚åŠ©æ–¹å¼
  const semanticAnalysis = analyzeUserIntent(userAnswer)

  const isUnknownAnswer = semanticAnalysis.isUnknown
  const isRequestingAnswer = semanticAnalysis.isRequestingAnswer
  const isRequestingGuidance = semanticAnalysis.isRequestingGuidance

  const isShortAnswer = userAnswer.length < 20
  const hasKeywords = keywords.length > 0
  const isTimeoutResponse = checkResponseTime()

  // ç¡®å®šå½“å‰å›ç­”ç±»å‹ - åŸºäºæ™ºèƒ½è¯„åˆ†åˆ†æ
  let currentResponseType = 'normal'
  if (isRequestingAnswer) currentResponseType = 'request_answer'
  else if (isRequestingGuidance) currentResponseType = 'request_guidance'
  else if (isUnknownAnswer) currentResponseType = 'unknown'
  else if (score >= 85) currentResponseType = 'exceptional'  // å“è¶Šå›ç­”
  else if (score >= 75) currentResponseType = 'excellent'   // ä¼˜ç§€å›ç­”
  else if (score >= 65) currentResponseType = 'good'        // è‰¯å¥½å›ç­”
  else if (score >= 50) currentResponseType = 'basic'       // åŸºç¡€å›ç­”
  else currentResponseType = 'needs_improvement'            // éœ€è¦æ”¹è¿›

  // æ£€æµ‹é‡å¤æ¨¡å¼
  const patterns = detectRepetitivePattern(currentResponseType)

  let response = ''

  // è®°å½•å½“å‰å›ç­”çš„è¯¦ç»†ä¿¡æ¯ç”¨äºä¸ªæ€§åŒ–å›å¤
  console.log('ğŸ¯ ç”Ÿæˆæ™ºèƒ½ä¸ªæ€§åŒ–å›å¤ - ç”¨æˆ·å›ç­”:', userAnswer.substring(0, 100))
  console.log('ğŸ“Š è¯„åˆ†:', score, 'ç±»å‹:', currentResponseType)
  console.log('ğŸ” å…³é”®è¯:', keywords)
  console.log('ğŸ§  æ™ºèƒ½åˆ¤æ–­:', interviewState.value.shouldTransitionToNext ? 'å‡†å¤‡è·³é¢˜' : 'ç»§ç»­æ·±å…¥')

  // æ ¹æ®å¯¹è¯è½®æ¬¡å’Œæ¨¡å¼è°ƒæ•´ç­–ç•¥
  if (patterns.tooManyUnknown && interviewState.value.conversationRounds >= 3) {
    // è¿ç»­å¤šæ¬¡ä¸çŸ¥é“ - æä¾›å…·ä½“ç­”æ¡ˆå’ŒæŒ‡å¯¼
    response = `æˆ‘æ³¨æ„åˆ°æ‚¨å¯¹è¿™å‡ ä¸ªé—®é¢˜éƒ½ä¸å¤ªç†Ÿæ‚‰ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚è®©æˆ‘æ¥åˆ†äº«ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œå¸®åŠ©æ‚¨å»ºç«‹ç†è§£ï¼š\n\n`

    if (currentQuestion.value <= 2) {
      response += `å…³äºè¿™ä¸ªé—®é¢˜ï¼Œç®€å•æ¥è¯´ï¼šæœºå™¨å­¦ä¹ æ˜¯è®©è®¡ç®—æœºé€šè¿‡æ•°æ®å­¦ä¹ è§„å¾‹çš„æŠ€æœ¯ã€‚æ¯”å¦‚æ¨èç³»ç»Ÿä¼šæ ¹æ®æ‚¨çš„æµè§ˆå†å²æ¨èå•†å“ï¼Œè¿™å°±æ˜¯æœºå™¨å­¦ä¹ çš„åº”ç”¨ã€‚\n\n`
      response += `ç°åœ¨æ‚¨å¯ä»¥å°è¯•ç”¨è‡ªå·±çš„è¯è¯´è¯´ï¼Œæ‚¨è§‰å¾—æœºå™¨å­¦ä¹ åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­è¿˜æœ‰å“ªäº›åº”ç”¨ï¼Ÿ`
    } else {
      response += `è®©æˆ‘ä»¬æ¢ä¸ªæ›´è´´è¿‘å®é™…çš„è§’åº¦ã€‚æ‚¨å¹³æ—¶ä½¿ç”¨æ‰‹æœºAPPæ—¶ï¼Œæœ‰æ²¡æœ‰æ³¨æ„åˆ°å®ƒä»¬ä¼š"å­¦ä¹ "æ‚¨çš„ä½¿ç”¨ä¹ æƒ¯ï¼Ÿæ¯”å¦‚è¾“å…¥æ³•ä¼šè®°ä½æ‚¨å¸¸ç”¨çš„è¯æ±‡ï¼Œè¿™å…¶å®å°±æ¶‰åŠåˆ°äº†æˆ‘ä»¬è®¨è®ºçš„æŠ€æœ¯æ¦‚å¿µã€‚\n\n`
      response += `åŸºäºè¿™ä¸ªä¾‹å­ï¼Œæ‚¨èƒ½è°ˆè°ˆå¯¹è¿™ç±»"æ™ºèƒ½åŒ–"åŠŸèƒ½çš„ç†è§£å—ï¼Ÿ`
    }

    interviewState.value.hasProvidedAnswer = true

  } else if (isTimeoutResponse && !interviewState.value.timeoutWarningShown) {
    // å›ç­”æ—¶é—´è¿‡é•¿ - æ—¶é—´ç®¡ç†æé†’
    response = `æˆ‘æ³¨æ„åˆ°æ‚¨æ€è€ƒäº†æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè¿™è¯´æ˜æ‚¨åœ¨è®¤çœŸè€ƒè™‘é—®é¢˜ï¼Œè¿™å¾ˆå¥½ï¼\n\n`
    response += `åœ¨é¢è¯•ä¸­ï¼Œå¦‚æœé‡åˆ°ä¸å¤ªç¡®å®šçš„é—®é¢˜ï¼Œå¯ä»¥å…ˆè¯´å‡ºæ‚¨çŸ¥é“çš„éƒ¨åˆ†ï¼Œç„¶åè¯šå®åœ°è¡¨è¾¾å“ªäº›æ–¹é¢éœ€è¦è¿›ä¸€æ­¥å­¦ä¹ ã€‚è¿™æ ·çš„å›ç­”å¾€å¾€æ¯”é•¿æ—¶é—´æ²‰é»˜æ›´æœ‰æ•ˆã€‚\n\n`
    response += `ç°åœ¨è¯·æ‚¨ç®€å•åˆ†äº«ä¸€ä¸‹åˆšæ‰çš„æ€è€ƒè¿‡ç¨‹ï¼Œæˆ–è€…è¯´è¯´æ‚¨å¯¹è¿™ä¸ªé—®é¢˜çš„åˆæ­¥ç†è§£ã€‚`

    interviewState.value.timeoutWarningShown = true

  } else if (patterns.isRepetitive && interviewState.value.conversationRounds >= 4) {
    // é‡å¤æ€§å›å¤ - æ”¹å˜ç­–ç•¥
    response = `æˆ‘ä»¬å·²ç»èŠäº†å‡ è½®äº†ï¼Œæˆ‘æƒ³æ¢ä¸ªæ–¹å¼æ¥äº†è§£æ‚¨ã€‚\n\n`

    if (currentResponseType === 'unknown') {
      response += `æ—¢ç„¶æŠ€æœ¯ç»†èŠ‚æš‚æ—¶ä¸å¤ªç†Ÿæ‚‰ï¼Œé‚£æˆ‘ä»¬èŠèŠæ‚¨çš„å­¦ä¹ ç»å†å§ã€‚æ‚¨æ˜¯é€šè¿‡ä»€ä¹ˆé€”å¾„å¼€å§‹æ¥è§¦è¿™ä¸ªé¢†åŸŸçš„ï¼Ÿæ˜¯è¯¾ç¨‹å­¦ä¹ ã€é¡¹ç›®å®è·µï¼Œè¿˜æ˜¯ä¸ªäººå…´è¶£ï¼Ÿ\n\n`
      response += `æ‚¨çš„å­¦ä¹ åŠ¨æœºå’Œæ–¹æ³•å¾€å¾€æ¯”å…·ä½“çš„æŠ€æœ¯çŸ¥è¯†æ›´èƒ½ä½“ç°æ‚¨çš„æ½œåŠ›ã€‚`
    } else {
      response += `æ‚¨çš„æŠ€æœ¯åŸºç¡€ä¸é”™ï¼Œç°åœ¨æˆ‘æƒ³äº†è§£æ‚¨çš„å®é™…åº”ç”¨èƒ½åŠ›ã€‚èƒ½å¦æè¿°ä¸€ä¸ªæ‚¨è®¤ä¸ºæœ€æœ‰æŒ‘æˆ˜æ€§çš„æŠ€æœ¯é—®é¢˜ï¼Ÿä¸ä¸€å®šè¦å¾ˆå¤æ‚ï¼Œå…³é”®æ˜¯æ‚¨å¦‚ä½•åˆ†æå’Œè§£å†³çš„ã€‚\n\n`
      response += `è¿™èƒ½å¸®æˆ‘æ›´å¥½åœ°è¯„ä¼°æ‚¨çš„é—®é¢˜è§£å†³èƒ½åŠ›ã€‚`
    }

  } else {
    // æ™ºèƒ½é€‚åº”æ€§å›å¤ - å¢å¼ºç‰ˆ
    const openingPhrases = {
      unknown: [
        'æˆ‘å¾ˆæ¬£èµæ‚¨çš„è¯šå®æ€åº¦ï¼',
        'è¯šå®åœ°è¡¨è¾¾ä¸äº†è§£ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å“è´¨ã€‚',
        'æ²¡å…³ç³»ï¼Œæ¯ä¸ªäººéƒ½æœ‰ä¸ç†Ÿæ‚‰çš„é¢†åŸŸã€‚'
      ],
      exceptional: [
        'å¤ªæ£’äº†ï¼è¿™æ˜¯ä¸€ä¸ªéå¸¸å‡ºè‰²çš„å›ç­”ï¼',
        'æ‚¨çš„å›ç­”å±•ç°äº†æ·±åšçš„æŠ€æœ¯åŠŸåº•å’Œä¸°å¯Œçš„å®è·µç»éªŒã€‚',
        'è¿™ä¸ªå›ç­”è®©æˆ‘çœ‹åˆ°äº†æ‚¨çš„ä¸“ä¸šæ°´å‡†ï¼Œéå¸¸impressiveï¼'
      ],
      excellent: [
        'å¾ˆæ£’çš„å›ç­”ï¼æ‚¨å¯¹è¿™ä¸ªé¢†åŸŸç¡®å®å¾ˆæœ‰è§è§£ã€‚',
        'å¬èµ·æ¥æ‚¨æœ‰ä¸°å¯Œçš„å®è·µç»éªŒï¼Œå›ç­”è´¨é‡å¾ˆé«˜ã€‚',
        'æ‚¨çš„å›ç­”è®©æˆ‘å°è±¡æ·±åˆ»ï¼ŒæŠ€æœ¯ç†è§£å¾ˆåˆ°ä½ã€‚'
      ],
      good: [
        'ä¸é”™çš„å›ç­”ï¼æˆ‘èƒ½æ„Ÿå—åˆ°æ‚¨å¯¹è¿™ä¸ªè¯é¢˜çš„ç†è§£ã€‚',
        'æ‚¨çš„æ€è·¯å¾ˆæ¸…æ™°ï¼ŒåŸºç¡€å¾ˆæ‰å®ã€‚',
        'å›ç­”å¾—å¾ˆå¥½ï¼Œæ˜¾ç¤ºäº†è‰¯å¥½çš„æŠ€æœ¯åŸºç¡€ã€‚'
      ],
      basic: [
        'è°¢è°¢æ‚¨çš„åˆ†äº«ï¼Œæˆ‘å¬å‡ºäº†æ‚¨çš„ä¸€äº›æƒ³æ³•ã€‚',
        'è¿™æ˜¯ä¸€ä¸ªä¸é”™çš„å¼€å§‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ¢è®¨ã€‚',
        'æ‚¨æåˆ°äº†ä¸€äº›å…³é”®ç‚¹ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹ã€‚'
      ],
      needs_improvement: [
        'æ„Ÿè°¢æ‚¨çš„å›ç­”ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ¢³ç†ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚',
        'è®©æˆ‘å¸®æ‚¨ç†æ¸…ä¸€ä¸‹æ€è·¯ï¼Œè¿™ä¸ªè¯é¢˜ç¡®å®æœ‰ä¸€å®šéš¾åº¦ã€‚',
        'æ²¡å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥ä»åŸºç¡€å¼€å§‹ï¼Œä¸€æ­¥æ­¥å»ºç«‹ç†è§£ã€‚'
      ]
    }

    if (isRequestingAnswer) {
      // å€™é€‰äººæ˜ç¡®è¦æ±‚æ ‡å‡†ç­”æ¡ˆ - ç›´æ¥æä¾›æŠ€æœ¯è§£ç­”
      response = `æˆ‘ç†è§£æ‚¨å¸Œæœ›äº†è§£è¿™ä¸ªé—®é¢˜çš„æ ‡å‡†ç­”æ¡ˆï¼Œè¿™ç§ä¸»åŠ¨å­¦ä¹ çš„æ€åº¦å¾ˆå¥½ï¼è®©æˆ‘ä¸ºæ‚¨è¯¦ç»†è§£æï¼š\n\n`

      // æ ¹æ®å½“å‰é—®é¢˜æä¾›å…·ä½“çš„æŠ€æœ¯ç­”æ¡ˆ
      response += generateTechnicalAnswer(currentQuestion.value)

      response += `\n\nç°åœ¨æ‚¨äº†è§£äº†æ ‡å‡†ç­”æ¡ˆï¼Œèƒ½å¦ç»“åˆæ‚¨çš„ç†è§£ï¼Œè°ˆè°ˆæ‚¨è§‰å¾—åœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½ä¼šé‡åˆ°å“ªäº›æŒ‘æˆ˜ï¼Ÿ`

    } else if (isRequestingGuidance) {
      // å€™é€‰äººè¦æ±‚æ€è·¯å¼•å¯¼ - æä¾›æ€è€ƒæ–¹å‘
      response = `å¾ˆå¥½çš„é—®é¢˜ï¼æˆ‘æ¥ä¸ºæ‚¨æä¾›ä¸€äº›æ€è€ƒçš„æ–¹å‘å’Œæ€è·¯ï¼š\n\n`

      response += generateGuidanceThoughts(currentQuestion.value)

      response += `\n\nåŸºäºè¿™äº›æ€è·¯ï¼Œæ‚¨ç°åœ¨å¯ä»¥å°è¯•ä»å…¶ä¸­ä¸€ä¸ªè§’åº¦æ¥å›ç­”ï¼Œä¸éœ€è¦é¢é¢ä¿±åˆ°ï¼Œé€‰æ‹©æ‚¨æœ€æœ‰æ„Ÿè§¦çš„æ–¹é¢å³å¯ã€‚`

    } else if (isUnknownAnswer) {
      const opening = openingPhrases.unknown[Math.floor(Math.random() * openingPhrases.unknown.length)]
      response = `${opening}åœ¨é¢è¯•ä¸­ï¼Œè¯šå®æ¯”èƒ¡ç¼–ä¹±é€ è¦å¥½å¾—å¤šã€‚\n\n`

      response += `è®©æˆ‘æ¢ä¸ªè§’åº¦æ¥å¼•å¯¼ä¸€ä¸‹ï¼šè¿™ä¸ªé—®é¢˜å…¶å®æ˜¯æƒ³äº†è§£æ‚¨åœ¨æŠ€æœ¯å­¦ä¹ å’Œå®è·µæ–¹é¢çš„ç»éªŒã€‚`
      response += `å³ä½¿æ‚¨å¯¹å…·ä½“çš„æŠ€æœ¯ç»†èŠ‚ä¸å¤ªç†Ÿæ‚‰ï¼Œä¹Ÿå¯ä»¥ä»ä»¥ä¸‹æ–¹é¢æ¥æ€è€ƒï¼š\n\n`
      response += `æ¯”å¦‚è¯´ï¼Œæ‚¨åœ¨å­¦ä¹ æ–°æŠ€æœ¯æ—¶é€šå¸¸æ˜¯æ€ä¹ˆå…¥æ‰‹çš„ï¼Ÿæˆ–è€…æ‚¨è§‰å¾—å­¦å¥½ä¸€é—¨æŠ€æœ¯æœ€é‡è¦çš„æ˜¯ä»€ä¹ˆï¼Ÿ`
      response += `è¿™äº›éƒ½èƒ½ä½“ç°æ‚¨çš„å­¦ä¹ èƒ½åŠ›å’Œæ€ç»´æ–¹å¼ã€‚`

    } else if (score >= 85) {
      // 85åˆ†ä»¥ä¸Šï¼šå“è¶Šå›ç­”ï¼Œç«‹å³è¿‡æ¸¡åˆ°ä¸‹ä¸€é¢˜
      const opening = openingPhrases.exceptional[Math.floor(Math.random() * openingPhrases.exceptional.length)]
      response = `${opening}æ‚¨çš„å›ç­”ä¸ä»…æŠ€æœ¯æ·±åº¦åˆ°ä½ï¼Œè¿˜ä½“ç°äº†ä¸°å¯Œçš„å®è·µç»éªŒå’Œç‹¬åˆ°çš„è§è§£ã€‚`

      // åˆ†æç”¨æˆ·å›ç­”ä¸­çš„å…·ä½“æŠ€æœ¯ç‚¹
      if (userAnswer.includes('çŸ¥è¯†è’¸é¦') || userAnswer.includes('Knowledge Distillation')) {
        response += `ç‰¹åˆ«æ˜¯æ‚¨å¯¹çŸ¥è¯†è’¸é¦æŠ€æœ¯çš„æ·±åº¦ç†è§£ï¼Œä»ç†è®ºåŸºç¡€åˆ°å®é™…åº”ç”¨ï¼Œå†åˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œå±•ç°äº†ä¸“å®¶çº§çš„æŠ€æœ¯æ°´å‡†ã€‚`
      } else if (userAnswer.includes('YOLOv4') || userAnswer.includes('ç›®æ ‡æ£€æµ‹')) {
        response += `æ‚¨å¯¹ç›®æ ‡æ£€æµ‹ç®—æ³•çš„å…¨é¢æŒæ¡ï¼ŒåŒ…æ‹¬æ¨¡å‹æ¶æ„ã€è®­ç»ƒç­–ç•¥å’Œéƒ¨ç½²ä¼˜åŒ–ï¼Œæ˜¾ç¤ºäº†æ·±åšçš„è®¡ç®—æœºè§†è§‰åŠŸåº•ã€‚`
      } else if (hasKeywords) {
        response += `æ‚¨å¯¹${keywords.slice(0, 3).join('ã€')}ç­‰æ ¸å¿ƒæŠ€æœ¯çš„æ·±å…¥ç†è§£ä»¤äººå°è±¡æ·±åˆ»ã€‚`
      }

      response += `\n\nè¿™ä¸ªé—®é¢˜æ‚¨å·²ç»å›ç­”å¾—éå¸¸å®Œç¾äº†ï¼è®©æˆ‘ä»¬è¿›å…¥ä¸‹ä¸€ä¸ªæ›´å…·æŒ‘æˆ˜æ€§çš„æŠ€æœ¯è¯é¢˜ã€‚`

      // ç«‹å³æ ‡è®°è¿‡æ¸¡åˆ°ä¸‹ä¸€é¢˜
      console.log('ğŸ† å“è¶Šå›ç­”ï¼Œç«‹å³è¿‡æ¸¡åˆ°ä¸‹ä¸€é¢˜ï¼Œåˆ†æ•°:', score)
      interviewState.value.shouldTransitionToNext = true

    } else if (score >= 75) {
      // 75-84åˆ†ï¼šä¼˜ç§€å›ç­”ï¼Œå‡†å¤‡è¿‡æ¸¡åˆ°ä¸‹ä¸€é¢˜
      const opening = openingPhrases.excellent[Math.floor(Math.random() * openingPhrases.excellent.length)]
      response = `${opening}æ‚¨çš„å›ç­”è´¨é‡å¾ˆé«˜ï¼ŒæŠ€æœ¯ç†è§£å¾ˆåˆ°ä½ï¼`

      // æ ¹æ®ç”¨æˆ·å›ç­”å†…å®¹ç»™å‡ºå…·ä½“åé¦ˆ
      if (userAnswer.includes('çŸ¥è¯†è’¸é¦') || userAnswer.includes('Knowledge Distillation')) {
        response += `æ‚¨å¯¹çŸ¥è¯†è’¸é¦æŠ€æœ¯çš„å®é™…åº”ç”¨ç»éªŒå¾ˆä¸°å¯Œï¼Œä»æ¨¡å‹å‹ç¼©åˆ°æ€§èƒ½ä¼˜åŒ–çš„å®Œæ•´æµç¨‹éƒ½æè¿°å¾—å¾ˆæ¸…æ¥šã€‚`
      } else if (userAnswer.includes('é¡¹ç›®') && userAnswer.includes('ç»éªŒ')) {
        response += `æ‚¨åˆ†äº«çš„é¡¹ç›®ç»éªŒå¾ˆæœ‰ä»·å€¼ï¼Œä»æŠ€æœ¯é€‰å‹åˆ°å®æ–½è½åœ°ï¼Œå±•ç°äº†è‰¯å¥½çš„å·¥ç¨‹å®è·µèƒ½åŠ›ã€‚`
      } else if (hasKeywords) {
        response += `æ‚¨å¯¹${keywords.slice(0, 2).join('ã€')}ç­‰æŠ€æœ¯çš„ç†è§£å¾ˆæ·±å…¥ã€‚`
      }

      response += `\n\nè¿™ä¸ªé—®é¢˜æ‚¨å›ç­”å¾—å¾ˆå¥½ï¼Œæˆ‘å¯¹æ‚¨çš„æŠ€æœ¯èƒ½åŠ›æœ‰äº†æ¸…æ™°çš„è®¤è¯†ã€‚è®©æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚`

      // æ ‡è®°å‡†å¤‡è¿‡æ¸¡åˆ°ä¸‹ä¸€é¢˜
      console.log('ğŸ† ä¼˜ç§€å›ç­”ï¼Œå‡†å¤‡è¿‡æ¸¡åˆ°ä¸‹ä¸€é¢˜ï¼Œåˆ†æ•°:', score)
      interviewState.value.shouldTransitionToNext = true

    } else if (score >= 65) {
      // 65-74åˆ†ï¼šè‰¯å¥½å›ç­”ï¼Œç®€å•ç¡®è®¤åè€ƒè™‘ä¸‹ä¸€é¢˜
      const opening = openingPhrases.good[Math.floor(Math.random() * openingPhrases.good.length)]
      response = `${opening}æ‚¨çš„å›ç­”æ˜¾ç¤ºäº†æ‰å®çš„åŸºç¡€å’Œä¸€å®šçš„å®è·µç»éªŒã€‚`

      // æ ¹æ®ç”¨æˆ·å›ç­”å†…å®¹ç»™å‡ºå…·ä½“åé¦ˆ
      if (userAnswer.includes('é¡¹ç›®') || userAnswer.includes('ç»éªŒ')) {
        response += `æ‚¨æåˆ°çš„é¡¹ç›®ç»éªŒå¾ˆæœ‰å‚è€ƒä»·å€¼ï¼Œèƒ½çœ‹å‡ºæ‚¨æœ‰å®é™…çš„åŠ¨æ‰‹èƒ½åŠ›ã€‚`
      } else if (hasKeywords) {
        response += `æ‚¨å¯¹${keywords[0]}ç­‰æ¦‚å¿µçš„ç†è§£æ˜¯æ­£ç¡®çš„ï¼ŒåŸºç¡€å¾ˆæ‰å®ã€‚`
      }

      response += `\n\nè®©æˆ‘ç®€å•ç¡®è®¤ä¸€ä¸‹ï¼šåœ¨æ‚¨çš„ç†è§£ä¸­ï¼Œè¿™ä¸ªæŠ€æœ¯æœ€å¤§çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿç„¶åæˆ‘ä»¬å¯ä»¥è¿›å…¥ä¸‹ä¸€ä¸ªè¯é¢˜ã€‚`

      // ä¸ç«‹å³è·³é¢˜ï¼Œä½†å‡†å¤‡è·³é¢˜
      interviewState.value.shouldTransitionToNext = false

      response += `\n\nä¸è¿‡æˆ‘è§‰å¾—æ‚¨è¿˜å¯ä»¥å±•å¼€å¾—æ›´æ·±å…¥ä¸€äº›ã€‚æ¯”å¦‚è¯´ï¼Œæ‚¨èƒ½ä¸¾ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜å—ï¼Ÿæˆ–è€…åˆ†äº«ä¸€ä¸‹æ‚¨æ˜¯æ€ä¹ˆå­¦ä¹ è¿™ä¸ªæŠ€æœ¯çš„ï¼Ÿ`

    } else if (score >= 50) {
      // 50-64åˆ†ï¼šåŸºç¡€å›ç­”ï¼Œéœ€è¦å¼•å¯¼æ·±å…¥
      const opening = openingPhrases.basic[Math.floor(Math.random() * openingPhrases.basic.length)]
      response = `${opening}æ‚¨æ˜¾ç¤ºäº†åŸºç¡€çš„ç†è§£ï¼Œä½†æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æ¢è®¨ã€‚`

      if (hasKeywords) {
        response += `æ‚¨æåˆ°çš„${keywords[0]}ç¡®å®æ˜¯ä¸ªç›¸å…³çš„æ¦‚å¿µã€‚`
      }

      response += `\n\nè®©æˆ‘ä»¬æ·±å…¥ä¸€äº›ï¼šæ‚¨èƒ½ç»“åˆå…·ä½“çš„åº”ç”¨åœºæ™¯æ¥è¯´æ˜å—ï¼Ÿæˆ–è€…åˆ†äº«ä¸€ä¸‹æ‚¨åœ¨å­¦ä¹ è¿™ä¸ªæŠ€æœ¯æ—¶çš„æ€è€ƒè¿‡ç¨‹ï¼Ÿè¿™æ ·èƒ½å¸®æˆ‘æ›´å¥½åœ°äº†è§£æ‚¨çš„æŠ€æœ¯æ€ç»´ã€‚`

      // ç»§ç»­å½“å‰è¯é¢˜ï¼Œä¸è·³é¢˜
      interviewState.value.shouldTransitionToNext = false

    } else {
      // ä½äº50åˆ†ï¼šéœ€è¦æ”¹è¿›ï¼Œæä¾›æŒ‡å¯¼
      const opening = openingPhrases.needs_improvement[Math.floor(Math.random() * openingPhrases.needs_improvement.length)]
      response = `${opening}è¿™ä¸ªè¯é¢˜ç¡®å®æœ‰ä¸€å®šçš„å¤æ‚æ€§ã€‚`

      if (hasKeywords) {
        response += `æ‚¨æåˆ°çš„${keywords[0]}æ˜¯ä¸ªèµ·ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå¼€å§‹ã€‚`
      }

      response += `\n\nè®©æˆ‘æ¢ä¸ªè§’åº¦æ¥å¸®åŠ©æ‚¨ï¼šè¿™ä¸ªæŠ€æœ¯å…¶å®åœ¨æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­æœ‰å¾ˆå¤šåº”ç”¨ã€‚æ¯”å¦‚è¯´ï¼Œæ‚¨å¹³æ—¶ä½¿ç”¨çš„æ‰‹æœºAPPã€ç½‘ç«™æ¨èç­‰éƒ½å¯èƒ½ç”¨åˆ°ç›¸å…³æŠ€æœ¯ã€‚ä»è¿™ä¸ªè§’åº¦ï¼Œæ‚¨è§‰å¾—è¿™ç±»æŠ€æœ¯çš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿ`

      // ç»§ç»­å½“å‰è¯é¢˜ï¼Œæä¾›æ›´å¤šæŒ‡å¯¼
      interviewState.value.shouldTransitionToNext = false
    }
  }

  return response
}

// æ‰“å­—æœºæ•ˆæœå‡½æ•°
const typewriterEffect = async (messageIndex, text, type = 'response') => {
  const message = conversationHistory.value[messageIndex]
  if (!message) {
    console.warn('æ¶ˆæ¯ä¸å­˜åœ¨:', messageIndex)
    return
  }

  console.log(`å¼€å§‹æ‰“å­—æœºæ•ˆæœ - ç±»å‹: ${type}, æ–‡æœ¬é•¿åº¦: ${text.length}`)

  // æŒ‰å­—ç¬¦åˆ†å‰²ï¼Œä½†ä¿æŒæ¢è¡Œç¬¦
  const chars = text.split('')
  let displayedText = ''

  for (let i = 0; i < chars.length; i++) {
    displayedText += chars[i]

    if (type === 'thinking') {
      // æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºåœ¨contentä¸­
      message.content = displayedText
    } else {
      // å›å¤å†…å®¹æ˜¾ç¤ºåœ¨displayedContentä¸­
      message.displayedContent = displayedText
      message.isTyping = true
    }

    // è§¦å‘å“åº”å¼æ›´æ–°
    await nextTick()
    // åœ¨æ‰“å­—æœºæ•ˆæœæœŸé—´å¼ºåˆ¶æ»šåŠ¨è·Ÿéšï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æœ€æ–°å†…å®¹
    scrollToBottom(true, false) // å¼ºåˆ¶æ»šåŠ¨ï¼Œä½†ä¸ä½¿ç”¨å¹³æ»‘åŠ¨ç”»ï¼ˆé¿å…å½±å“æ‰“å­—æ•ˆæœï¼‰

    // æ§åˆ¶æ‰“å­—é€Ÿåº¦ï¼šæ ‡ç‚¹ç¬¦å·ç¨æ…¢ï¼Œæ™®é€šå­—ç¬¦è¾ƒå¿«
    const char = chars[i]
    const delay = /[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š]/.test(char) ? 200 :
                  /[,.\!?;:]/.test(char) ? 200 :
                  /[\s\n]/.test(char) ? 30 :
                  50

    await new Promise(resolve => setTimeout(resolve, delay))
  }

  // å®Œæˆæ˜¾ç¤ºåçš„å¤„ç†
  if (type === 'thinking') {
    message.content = text
    message.isThinking = false
  } else {
    message.displayedContent = text
    message.isTyping = false
  }

  console.log(`æ‰“å­—æœºæ•ˆæœå®Œæˆ - ç±»å‹: ${type}`)
}

// ç”ŸæˆAIé¢è¯•å®˜çš„å¯¹è¯å¼å›å¤ï¼ˆåˆå¹¶æ˜¾ç¤ºï¼Œå¯æŠ˜å æ€è€ƒè¿‡ç¨‹ï¼‰
const generateAIInterviewerResponse = async (analysis, userAnswer) => {
  try {
    console.log('ğŸ¤– å¼€å§‹ç”ŸæˆAIé¢è¯•å®˜å›å¤...')
    console.log('ğŸ“Š åˆ†ææ•°æ®:', analysis)
    console.log('ğŸ’¬ ç”¨æˆ·å›ç­”:', userAnswer)

    // ç¬¬ä¸€é˜¶æ®µï¼šæ˜¾ç¤ºAIæ­£åœ¨æ€è€ƒçŠ¶æ€
    const aiMessage = {
      type: 'ai',
      sender: 'AIé¢è¯•å®˜',
      content: 'ğŸ¤” AIé¢è¯•å®˜æ­£åœ¨æ€è€ƒ...',
      timestamp: new Date().toLocaleTimeString(),
      isThinking: true,
      isAnimating: true,
      hasThinkingProcess: true,
      thinkingProcess: '',
      thinkingExpanded: [], // æŠ˜å çŠ¶æ€æ§åˆ¶
      displayedContent: '',
      finalResponse: '', // æœ€ç»ˆå›å¤å†…å®¹
      isTyping: false,
      analysis: {
        type: 'enhanced_response',
        score: analysis.overallScore || 0,
        responseType: (analysis.overallScore || 0) >= 85 ? 'excellent' :
                     (analysis.overallScore || 0) >= 70 ? 'good' : 'needs_improvement'
      }
    }

    conversationHistory.value.push(aiMessage)
    console.log('âœ… AIæ¶ˆæ¯å·²æ·»åŠ ')
    await nextTick()
    scrollToBottom(true, true) // å¼ºåˆ¶æ»šåŠ¨åˆ°AIæ¶ˆæ¯ï¼Œä½¿ç”¨å¹³æ»‘åŠ¨ç”»

    // ç¬¬äºŒé˜¶æ®µï¼šç”Ÿæˆå¹¶é€æ­¥æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
    console.log('â³ å¼€å§‹ç”Ÿæˆæ€è€ƒè¿‡ç¨‹...')
    await new Promise(resolve => setTimeout(resolve, 1000))

    // ç”Ÿæˆäººæ€§åŒ–çš„æ€è€ƒè¿‡ç¨‹ï¼ˆåŸºäºç”¨æˆ·å…·ä½“å›ç­”å†…å®¹ï¼‰
    const thinkingContent = generateHumanizedThinkingProcess(analysis, userAnswer)

    const messageIndex = conversationHistory.value.length - 1

    // å¼€å§‹æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºäººæ€§åŒ–æ€è€ƒè¿‡ç¨‹
    await typewriterEffect(messageIndex, thinkingContent, 'thinking')
    console.log('âœ… äººæ€§åŒ–æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºå®Œæˆ')

    // ç¬¬ä¸‰é˜¶æ®µï¼šè®¾ç½®æ€è€ƒè¿‡ç¨‹å¹¶å‡†å¤‡æŠ˜å 
    await new Promise(resolve => setTimeout(resolve, 800))
    conversationHistory.value[messageIndex].thinkingProcess = thinkingContent
    conversationHistory.value[messageIndex].isThinking = false
    conversationHistory.value[messageIndex].thinkingExpanded = [] // é»˜è®¤æŠ˜å çŠ¶æ€
    console.log('âœ… æ€è€ƒè¿‡ç¨‹å·²è®¾ç½®ï¼Œå‡†å¤‡æ˜¾ç¤ºå›å¤')

    // ç¬¬å››é˜¶æ®µï¼šç”Ÿæˆå¹¶é€æ­¥æ˜¾ç¤ºæœ€ç»ˆå›å¤å†…å®¹
    console.log('ğŸ¯ å¼€å§‹ç”ŸæˆAIå›å¤å†…å®¹...')
    const score = analysis.overallScore || 0
    const keywords = analysis.textAnalysis?.keywords || []
    const recommendations = analysis.recommendations || []

    console.log('ğŸ“ˆ è¯„åˆ†:', score)
    console.log('ğŸ”‘ å…³é”®è¯:', keywords)
    console.log('ğŸ’¡ å»ºè®®:', recommendations)

    // ä½¿ç”¨å¯¹è¯æµç¨‹ç»¼åˆè¯„åˆ†ç³»ç»Ÿ
    const aiResponse = generateHumanizedInterviewerResponse(analysis, userAnswer, score, keywords, recommendations)
    const conversationScore = calculateConversationScore(userAnswer, aiResponse, score)
    console.log('ğŸ“ˆ å¯¹è¯æµç¨‹è¯„åˆ†ç»“æœ:', { å•æ¬¡åˆ†æ•°: score, å¯¹è¯æµç¨‹åˆ†æ•°: conversationScore })

    // åœ¨åŒä¸€æ¶ˆæ¯ä¸­å¼€å§‹æ˜¾ç¤ºæœ€ç»ˆå›å¤ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
    conversationHistory.value[messageIndex].isTyping = true
    await typewriterEffect(messageIndex, aiResponse, 'response')

    // å®Œæˆå›å¤æ˜¾ç¤ºï¼Œä½†ä¸è¦†ç›–contentå­—æ®µï¼ˆä¿ç•™æ€è€ƒè¿‡ç¨‹ï¼‰
    conversationHistory.value[messageIndex].isTyping = false
    conversationHistory.value[messageIndex].isAnimating = false

    // ç¡®ä¿æœ€ç»ˆå›å¤å†…å®¹æ­£ç¡®è®¾ç½®
    conversationHistory.value[messageIndex].finalResponse = aiResponse

    // AIå›å¤å®Œæˆåï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨å¹¶ä½¿ç”¨å¹³æ»‘åŠ¨ç”»
    await nextTick()
    scrollToBottom(true, true)
    console.log('âœ… AIé¢è¯•å®˜å›å¤ç”Ÿæˆå®Œæˆï¼Œå·²æ»šåŠ¨åˆ°åº•éƒ¨')

    // æ™ºèƒ½é¢˜ç›®è¿‡æ¸¡é€»è¾‘ - ç»Ÿä¸€å¤„ç†é¢˜ç›®é€’å¢
    console.log('ğŸ”„ å‡†å¤‡å¤„ç†é¢˜ç›®è¿‡æ¸¡ï¼Œå½“å‰é¢˜ç›®:', currentQuestion.value)

    // å»¶è¿Ÿåå¤„ç†é¢˜ç›®è¿‡æ¸¡ï¼ˆç»Ÿä¸€å…¥å£ï¼Œé¿å…é‡å¤é€’å¢ï¼‰
    setTimeout(async () => {
      if (currentQuestion.value < totalQuestions.value) {
        // æ£€æŸ¥AIé¢è¯•å®˜æ˜¯å¦æ˜ç¡®è¡¨ç¤ºè¦è·³è½¬ä¸‹ä¸€é¢˜
        if (interviewState.value.shouldTransitionToNext) {
          console.log('ğŸ¯ AIé¢è¯•å®˜æ˜ç¡®è¡¨ç¤ºè·³è½¬ä¸‹ä¸€é¢˜ï¼Œç›´æ¥æ‰§è¡Œè·³è½¬')

          // å»¶è¿Ÿ2ç§’åç”Ÿæˆä¸‹ä¸€é¢˜ï¼ˆç»™ç”¨æˆ·æ—¶é—´é˜…è¯»AIå›å¤ï¼‰
          setTimeout(() => {
            console.log('ğŸ“ˆ AIæŒ‡å¯¼è·³è½¬ï¼šä»ç¬¬', currentQuestion.value, 'é¢˜åˆ°ç¬¬', currentQuestion.value + 1, 'é¢˜')
            currentQuestion.value++
            interviewState.value.shouldTransitionToNext = false
            interviewState.value.currentQuestionSatisfied = true
            resetConversationScoring() // é‡ç½®å¯¹è¯æµç¨‹è¯„åˆ†çŠ¶æ€
            generateNextQuestion()
          }, 2000)
        } else {
          // ä½¿ç”¨å¯¹è¯æµç¨‹è¯„åˆ†æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨è¿‡æ¸¡åˆ°ä¸‹ä¸€é¢˜
          const shouldTransition = shouldTransitionToNextQuestion()
          if (shouldTransition) {
            console.log('ğŸ¯ åŸºäºå¯¹è¯æµç¨‹è¯„åˆ†æ£€æµ‹åˆ°æ»¡è¶³è·³é¢˜æ¡ä»¶ï¼Œè‡ªåŠ¨è¿‡æ¸¡åˆ°ä¸‹ä¸€é¢˜')

            // æ·»åŠ è¿‡æ¸¡æç¤ºæ¶ˆæ¯
            const transitionMessage = {
              type: 'ai',
              sender: 'AIé¢è¯•å®˜',
              content: 'å¾ˆå¥½ï¼åŸºäºæ‚¨ä¼˜ç§€çš„å›ç­”ï¼Œæˆ‘ä»¬ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚',
              timestamp: new Date().toLocaleTimeString(),
              isTransition: true
            }

            conversationHistory.value.push(transitionMessage)
            await nextTick()
            scrollToBottom(true, true) // å¼ºåˆ¶æ»šåŠ¨åˆ°è¿‡æ¸¡æ¶ˆæ¯

            // å»¶è¿Ÿ1ç§’åç”Ÿæˆä¸‹ä¸€é¢˜
            setTimeout(() => {
              console.log('ğŸ“ˆ è‡ªåŠ¨è¿‡æ¸¡ï¼šä»ç¬¬', currentQuestion.value, 'é¢˜åˆ°ç¬¬', currentQuestion.value + 1, 'é¢˜')
              currentQuestion.value++
              interviewState.value.shouldTransitionToNext = false
              interviewState.value.currentQuestionSatisfied = true
              resetConversationScoring() // é‡ç½®å¯¹è¯æµç¨‹è¯„åˆ†çŠ¶æ€
              generateNextQuestion()
            }, 1500)
          } else {
            // ä¸æ»¡è¶³è‡ªåŠ¨è¿‡æ¸¡æ¡ä»¶ï¼Œç»§ç»­å½“å‰é—®é¢˜çš„å¯¹è¯
            console.log('ğŸ“ ä¸æ»¡è¶³è·³é¢˜æ¡ä»¶ï¼Œç»§ç»­å½“å‰é—®é¢˜çš„å¯¹è¯')
          }
        }
      } else {
        // é¢è¯•ç»“æŸ
        console.log('ğŸ‰ é¢è¯•å·²å®Œæˆæ‰€æœ‰é¢˜ç›®')
        ElNotification.success({
          title: 'é¢è¯•å®Œæˆ',
          message: 'æ­å–œæ‚¨å®Œæˆäº†æ‰€æœ‰é¢è¯•é—®é¢˜ï¼',
          duration: 5000
        })
      }
    }, 3000)

  } catch (error) {
    console.error('âŒ AIé¢è¯•å®˜å›å¤ç”Ÿæˆå¤±è´¥:', error)

    // æ¸…ç†æ€è€ƒçŠ¶æ€çš„æ¶ˆæ¯
    const lastMessage = conversationHistory.value[conversationHistory.value.length - 1]
    if (lastMessage && lastMessage.isThinking) {
      lastMessage.isThinking = false
      lastMessage.isAnimating = false
    }

    // æ ¹æ®ç”¨æˆ·å›ç­”ç±»å‹ç”Ÿæˆåˆé€‚çš„å¤‡ç”¨å›å¤
    const isUnknownAnswer = userAnswer.includes('ä¸çŸ¥é“') ||
                           userAnswer.includes('ä¸æ¸…æ¥š') ||
                           userAnswer.includes('æ²¡æœ‰ç»éªŒ') ||
                           userAnswer.includes('ä¸ä¼š') ||
                           userAnswer.trim().length < 10

    const fallbackContent = isUnknownAnswer ?
      'æ²¡å…³ç³»ï¼Œè¯šå®åœ°è¡¨è¾¾ä¸äº†è§£æ˜¯å¾ˆå¥½çš„æ€åº¦ã€‚æˆ‘ä»¬å¯ä»¥ä»åŸºç¡€æ¦‚å¿µå¼€å§‹å­¦ä¹ ã€‚è®©æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚' :
      'æ„Ÿè°¢æ‚¨çš„å›ç­”ã€‚æˆ‘çœ‹åˆ°æ‚¨å¯¹è¿™ä¸ªé—®é¢˜æœ‰ä¸€å®šçš„ç†è§£ã€‚è®©æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚'

    // å¦‚æœæœ‰æœªå®Œæˆçš„æ¶ˆæ¯ï¼Œæ›´æ–°å…¶å†…å®¹
    if (lastMessage && lastMessage.hasThinkingProcess) {
      lastMessage.content = fallbackContent
      lastMessage.analysis = { type: 'fallback' }
    } else {
      // å¦åˆ™æ·»åŠ æ–°çš„å¤‡ç”¨å›å¤
      conversationHistory.value.push({
        type: 'ai',
        sender: 'AIé¢è¯•å®˜',
        content: fallbackContent,
        timestamp: new Date().toLocaleTimeString(),
        analysis: { type: 'fallback' },
        isAnimating: true
      })
    }

    // å®‰å…¨åœ°æ»šåŠ¨åˆ°åº•éƒ¨
    try {
      scrollToBottom()
    } catch (scrollError) {
      console.warn('âš ï¸ æ»šåŠ¨å¤±è´¥:', scrollError.message)
    }
  }
}

// è·å–AIæç¤º
const getAiHint = async () => {
  if (aiAssistanceCount.value <= 0) {
    ElMessage.warning('AIæç¤ºæ¬¡æ•°å·²ç”¨å®Œ')
    return
  }

  try {
    const context = {
      question: currentQuestionData.value.text,
      candidateResponse: currentTextInput.value,
      analysisResults: realTimeAnalysis.value,
      questionNumber: currentQuestion.value
    }

    const hint = await enhancedIflytekSparkService.generateRealTimeHint(
      sparkSession.value?.sessionId || 'fallback',
      context
    )

    currentAiHint.value = hint.hint
    showAiHints.value = true
    aiAssistanceCount.value--

    ElMessage.success('AIæç¤ºå·²ç”Ÿæˆ')

  } catch (error) {
    console.error('AIæç¤ºç”Ÿæˆå¤±è´¥:', error)
    ElMessage.error('AIæç¤ºç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
  }
}

// æ¸…ç©ºè¾“å…¥ï¼ˆå¼ºåˆ¶æ¸…ç©ºï¼‰
const clearInput = async () => {
  currentTextInput.value = ''
  showSmartSuggestions.value = false
  smartSuggestions.value = []

  // ç¡®ä¿DOMæ›´æ–°
  await nextTick()

  // åŒé‡ä¿éšœ
  if (currentTextInput.value) {
    currentTextInput.value = ''
  }

  console.log('ğŸ§¹ è¾“å…¥æ¡†å·²å¼ºåˆ¶æ¸…ç©º')
}

// æ’å…¥æ¨¡æ¿å†…å®¹
const insertTemplate = (templateType) => {
  const templates = {
    'é¡¹ç›®ç»éªŒ': `åœ¨æˆ‘å‚ä¸çš„[é¡¹ç›®åç§°]é¡¹ç›®ä¸­ï¼Œæˆ‘ä¸»è¦è´Ÿè´£[å…·ä½“èŒè´£]ã€‚

é¡¹ç›®èƒŒæ™¯ï¼š[é¡¹ç›®èƒŒæ™¯æè¿°]
æŠ€æœ¯æ ˆï¼š[ä½¿ç”¨çš„æŠ€æœ¯æ ˆ]
æˆ‘çš„è´¡çŒ®ï¼š[å…·ä½“è´¡çŒ®å’Œæˆæœ]
é‡åˆ°çš„æŒ‘æˆ˜ï¼š[æŠ€æœ¯éš¾ç‚¹]
è§£å†³æ–¹æ¡ˆï¼š[è§£å†³æ–¹æ¡ˆ]
é¡¹ç›®æˆæœï¼š[é¡¹ç›®æˆæœå’Œå½±å“]`,

    'æŠ€æœ¯æ ˆ': `æˆ‘ç†Ÿç»ƒæŒæ¡ä»¥ä¸‹æŠ€æœ¯æ ˆï¼š

å‰ç«¯æŠ€æœ¯ï¼š[å¦‚ï¼šVue.js, React, JavaScript, TypeScriptç­‰]
åç«¯æŠ€æœ¯ï¼š[å¦‚ï¼šNode.js, Python, Java, Goç­‰]
æ•°æ®åº“ï¼š[å¦‚ï¼šMySQL, MongoDB, Redisç­‰]
å¼€å‘å·¥å…·ï¼š[å¦‚ï¼šGit, Docker, Kubernetesç­‰]
äº‘æœåŠ¡ï¼š[å¦‚ï¼šAWS, é˜¿é‡Œäº‘ç­‰]

å…¶ä¸­æˆ‘æœ€æ“…é•¿çš„æ˜¯[å…·ä½“æŠ€æœ¯]ï¼Œæœ‰[æ—¶é—´]çš„å®è·µç»éªŒã€‚`,

    'è§£å†³æ–¹æ¡ˆ': `é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘çš„è§£å†³æ€è·¯å¦‚ä¸‹ï¼š

1. é—®é¢˜åˆ†æï¼š[é—®é¢˜çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆ]
2. æŠ€æœ¯é€‰å‹ï¼š[é€‰æ‹©ä»€ä¹ˆæŠ€æœ¯æ–¹æ¡ˆï¼Œä¸ºä»€ä¹ˆ]
3. å®æ–½æ­¥éª¤ï¼š[å…·ä½“çš„å®æ–½æ­¥éª¤]
4. é£é™©æ§åˆ¶ï¼š[å¯èƒ½çš„é£é™©å’Œåº”å¯¹æªæ–½]
5. æ•ˆæœè¯„ä¼°ï¼š[å¦‚ä½•è¯„ä¼°è§£å†³æ•ˆæœ]

è¿™ç§æ–¹æ¡ˆçš„ä¼˜åŠ¿æ˜¯[ä¼˜åŠ¿è¯´æ˜]ï¼Œå¯èƒ½çš„ä¸è¶³æ˜¯[ä¸è¶³è¯´æ˜]ã€‚`
  }

  const template = templates[templateType]
  if (template) {
    if (currentTextInput.value.trim()) {
      currentTextInput.value += '\n\n' + template
    } else {
      currentTextInput.value = template
    }
    ElMessage.success(`å·²æ’å…¥${templateType}æ¨¡æ¿`)
  }
}

// å¤„ç†è¾“å…¥å˜åŒ–
const handleInputChange = () => {
  if (currentTextInput.value.length > 50) {
    generateSmartSuggestions()
  } else {
    smartSuggestions.value = []
  }
}

// ç”Ÿæˆæ™ºèƒ½å»ºè®®
const generateSmartSuggestions = () => {
  const input = currentTextInput.value.toLowerCase()
  const suggestions = []

  // åŸºäºè¾“å…¥å†…å®¹ç”Ÿæˆå»ºè®®
  if (input.includes('é¡¹ç›®') && !input.includes('èƒŒæ™¯')) {
    suggestions.push('å¯ä»¥è¯¦ç»†æè¿°é¡¹ç›®èƒŒæ™¯å’Œè§„æ¨¡')
  }
  if (input.includes('æŠ€æœ¯') && !input.includes('é€‰å‹')) {
    suggestions.push('è¯´æ˜æŠ€æœ¯é€‰å‹çš„åŸå› å’Œè€ƒè™‘å› ç´ ')
  }
  if (input.includes('é—®é¢˜') && !input.includes('è§£å†³')) {
    suggestions.push('è¯¦ç»†æè¿°é—®é¢˜çš„è§£å†³è¿‡ç¨‹å’Œæ–¹æ³•')
  }
  if (input.includes('ç»éªŒ') && !input.includes('å­¦åˆ°')) {
    suggestions.push('åˆ†äº«ä»è¿™ä¸ªç»éªŒä¸­å­¦åˆ°çš„çŸ¥è¯†')
  }
  if (input.length > 100 && !input.includes('æ€»ç»“')) {
    suggestions.push('å¯ä»¥æ·»åŠ ä¸€ä¸ªç®€çŸ­çš„æ€»ç»“')
  }

  smartSuggestions.value = suggestions.slice(0, 3)
}

// åˆ‡æ¢æ™ºèƒ½å»ºè®®æ˜¾ç¤º
const toggleSmartSuggestions = () => {
  showSmartSuggestions.value = !showSmartSuggestions.value
  if (showSmartSuggestions.value) {
    generateSmartSuggestions()
  }
}

// åº”ç”¨å»ºè®®
const applySuggestion = (suggestion) => {
  currentTextInput.value += '\n\n' + suggestion
  ElMessage.success('å·²åº”ç”¨å»ºè®®')
}

// ä¿å­˜è‰ç¨¿
const saveAsDraft = () => {
  const questionKey = `question_${currentQuestion.value}`
  draftAnswers.value.set(questionKey, currentTextInput.value)
  ElMessage.success('è‰ç¨¿å·²ä¿å­˜')
}

// è·³è¿‡é—®é¢˜
const nextQuestion = () => {
  if (currentQuestion.value < totalQuestions.value) {
    currentQuestion.value++
    generateNextQuestion()
    ElMessage.info('å·²è·³è¿‡å½“å‰é—®é¢˜')
  }
}

// è·³è½¬åˆ°æŒ‡å®šé—®é¢˜
const jumpToQuestion = (questionNumber) => {
  console.log('ğŸ¯ å°è¯•è·³è½¬åˆ°é—®é¢˜:', questionNumber, 'å½“å‰é—®é¢˜:', currentQuestion.value)

  if (questionNumber < 1 || questionNumber > totalQuestions.value) {
    ElMessage.warning('æ— æ•ˆçš„é—®é¢˜ç¼–å·')
    return
  }

  if (questionNumber > currentQuestion.value + 1) {
    ElMessage.warning('ä¸èƒ½è·³è¿‡æœªè§£é”çš„é—®é¢˜')
    return
  }

  // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰é—®é¢˜ï¼Œä¸éœ€è¦è·³è½¬
  if (questionNumber === currentQuestion.value) {
    ElMessage.info('å½“å‰å·²ç»æ˜¯ç¬¬' + questionNumber + 'é¢˜')
    return
  }

  console.log('âœ… æ‰§è¡Œè·³è½¬ï¼šä»ç¬¬', currentQuestion.value, 'é¢˜åˆ°ç¬¬', questionNumber, 'é¢˜')

  // ç›´æ¥ä»é—®é¢˜åº“ä¸­è·å–é—®é¢˜æ•°æ®
  const questionIndex = questionNumber - 1
  if (questionIndex < questionBank.value.length) {
    currentQuestionData.value = { ...questionBank.value[questionIndex] }
    console.log('ğŸ“ å·²æ›´æ–°é—®é¢˜å†…å®¹:', currentQuestionData.value.text)
  } else {
    // å¦‚æœè¶…å‡ºé—®é¢˜åº“èŒƒå›´ï¼Œç”Ÿæˆæ–°é—®é¢˜
    console.log('ğŸ“ é—®é¢˜è¶…å‡ºé¢„è®¾èŒƒå›´ï¼Œç”Ÿæˆæ–°é—®é¢˜')
    generateNextQuestion()
  }

  currentQuestion.value = questionNumber
  ElMessage.success(`å·²è·³è½¬åˆ°ç¬¬${questionNumber}é¢˜`)
}

// æ’å…¥å¿«æ·å›ç­”
const insertQuickResponse = (response) => {
  if (currentTextInput.value.trim()) {
    currentTextInput.value += '\n\n' + response
  } else {
    currentTextInput.value = response
  }
  ElMessage.success('å·²æ’å…¥å¿«æ·å›ç­”')
}

// æš‚åœé¢è¯•
const pauseInterview = () => {
  interviewState.value.isPaused = true
  ElMessage.info('é¢è¯•å·²æš‚åœ')
}

// ç»§ç»­é¢è¯•
const resumeInterview = () => {
  interviewState.value.isPaused = false
  ElMessage.success('é¢è¯•å·²ç»§ç»­')
}

// ç»“æŸé¢è¯•
const endInterview = () => {
  ElMessageBox.confirm(
    'ç¡®å®šè¦ç»“æŸé¢è¯•å—ï¼Ÿç»“æŸåå°†æ— æ³•ç»§ç»­å›ç­”é—®é¢˜ã€‚',
    'ç¡®è®¤ç»“æŸé¢è¯•',
    {
      confirmButtonText: 'ç¡®å®šç»“æŸ',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning',
    }
  ).then(() => {
    // è·³è½¬åˆ°ç»“æœé¡µé¢æˆ–æ‰§è¡Œç»“æŸé€»è¾‘
    ElNotification.success({
      title: 'é¢è¯•å·²ç»“æŸ',
      message: 'æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œæ­£åœ¨ç”Ÿæˆé¢è¯•æŠ¥å‘Š...',
      duration: 3000
    })
    // è¿™é‡Œå¯ä»¥æ·»åŠ è·³è½¬åˆ°ç»“æœé¡µé¢çš„é€»è¾‘
  }).catch(() => {
    ElMessage.info('å·²å–æ¶ˆç»“æŸé¢è¯•')
  })
}

// è·å–é—®é¢˜éš¾åº¦ç±»å‹
const getQuestionDifficultyType = (difficulty) => {
  switch (difficulty) {
    case 'ç®€å•': return 'success'
    case 'ä¸­ç­‰': return 'warning'
    case 'å›°éš¾': return 'danger'
    default: return 'info'
  }
}

// è·å–åˆ†æ•°ç±»å‹
const getScoreType = (score) => {
  if (score >= 80) return 'success'
  if (score >= 60) return 'warning'
  return 'danger'
}

// è®¡ç®—å¹³å‡åˆ†æ•°ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ä½œä¸ºå¤‡ç”¨ï¼‰
const calculateAverageScore = () => {
  const userMessages = conversationHistory.value.filter(msg => msg.type === 'user' && msg.analysis?.score)
  if (userMessages.length === 0) return 0

  const totalScore = userMessages.reduce((sum, msg) => sum + (msg.analysis.score || 0), 0)
  return Math.round(totalScore / userMessages.length)
}

// å¯¹è¯æµç¨‹ç»¼åˆè¯„åˆ†è®¡ç®— - çœŸæ­£åŸºäºæ•´ä¸ªå¯¹è¯è¿‡ç¨‹çš„è¯„åˆ†ç³»ç»Ÿ
const calculateConversationScore = (userAnswer, aiResponse, singleScore) => {
  console.log('ğŸ§® å¼€å§‹è®¡ç®—å¯¹è¯æµç¨‹ç»¼åˆè¯„åˆ†...')

  const flow = conversationScoring.value.conversationFlow
  const rules = conversationScoring.value.scoringRules

  // æ›´æ–°å¯¹è¯æµç¨‹çŠ¶æ€
  flow.totalTurns++

  // 1. åˆ†æå½“å‰å›ç­”çš„è´¨é‡ç­‰çº§
  const qualityLevel = determineAnswerQuality(userAnswer, singleScore)

  // 2. æ£€æµ‹å¯¹è¯æµç¨‹ç‰¹å¾
  const flowFeatures = analyzeConversationFlow(userAnswer, aiResponse)

  // 3. è®¡ç®—æœ¬è½®å¯¹è¯çš„åˆ†æ•°å¢é‡
  let scoreIncrement = rules.baseIncrement

  // åº”ç”¨è´¨é‡ç³»æ•°
  scoreIncrement *= rules.qualityMultipliers[qualityLevel]

  // åº”ç”¨å¯¹è¯æµç¨‹åŠ æˆ
  if (flowFeatures.topicContinuity) {
    scoreIncrement += rules.flowBonuses.topicContinuity
    flow.buildOnPrevious++
  }

  if (flowFeatures.depthProgression) {
    scoreIncrement += rules.flowBonuses.depthProgression
    flow.topicDepth++
  }

  if (flowFeatures.exampleProvided) {
    scoreIncrement += rules.flowBonuses.exampleProvision
    flow.examplesProvided++
  }

  if (flowFeatures.activeEngagement) {
    scoreIncrement += rules.flowBonuses.activeEngagement
  }

  if (flowFeatures.conceptIntegration) {
    scoreIncrement += rules.flowBonuses.conceptIntegration
    flowFeatures.newConcepts.forEach(concept => flow.conceptsCovered.add(concept))
  }

  // 4. ç´¯ç§¯åˆ°æ€»åˆ†
  conversationScoring.value.currentQuestionScore += Math.round(scoreIncrement)

  // 5. ç¡®ä¿åˆ†æ•°åœ¨åˆç†èŒƒå›´å†…
  conversationScoring.value.currentQuestionScore = Math.min(100, Math.max(0, conversationScoring.value.currentQuestionScore))

  // 6. åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ„ä¹‰çš„å¯¹è¯è½®æ¬¡
  if (scoreIncrement > rules.baseIncrement * 0.8) {
    flow.meaningfulTurns++
  }

  console.log('ğŸ“Š å¯¹è¯æµç¨‹è¯„åˆ†è¯¦æƒ…:', {
    è´¨é‡ç­‰çº§: qualityLevel,
    åŸºç¡€å¢é‡: rules.baseIncrement,
    è´¨é‡ç³»æ•°: rules.qualityMultipliers[qualityLevel],
    æµç¨‹åŠ æˆ: scoreIncrement - (rules.baseIncrement * rules.qualityMultipliers[qualityLevel]),
    æœ¬è½®å¢é‡: Math.round(scoreIncrement),
    ç´¯ç§¯æ€»åˆ†: conversationScoring.value.currentQuestionScore,
    å¯¹è¯è½®æ¬¡: flow.totalTurns,
    æœ‰æ„ä¹‰è½®æ¬¡: flow.meaningfulTurns,
    æ¦‚å¿µè¦†ç›–: flow.conceptsCovered.size
  })

  return conversationScoring.value.currentQuestionScore
}

// ç¡®å®šå›ç­”è´¨é‡ç­‰çº§
const determineAnswerQuality = (userAnswer, singleScore) => {
  // ç»¼åˆè€ƒè™‘å•æ¬¡è¯„åˆ†å’Œå›ç­”ç‰¹å¾
  const length = userAnswer.length
  const hasExamples = /ä¾‹å¦‚|æ¯”å¦‚|ä¸¾ä¾‹|æ¡ˆä¾‹|å®é™…|é¡¹ç›®ä¸­/.test(userAnswer)
  const hasTechnicalTerms = /ç®—æ³•|æ¨¡å‹|æ¶æ„|æ¡†æ¶|æŠ€æœ¯|ç³»ç»Ÿ|æ•°æ®|ä¼˜åŒ–/.test(userAnswer)
  const hasPersonalExperience = /æˆ‘åœ¨|æˆ‘çš„|æˆ‘ä»¬|æˆ‘æ›¾ç»|æˆ‘è®¤ä¸º|æˆ‘è§‰å¾—/.test(userAnswer)

  // åŸºäºå•æ¬¡è¯„åˆ†çš„åŸºç¡€ç­‰çº§
  let qualityLevel = 'average'
  if (singleScore >= 85) qualityLevel = 'excellent'
  else if (singleScore >= 70) qualityLevel = 'good'
  else if (singleScore >= 50) qualityLevel = 'average'
  else if (singleScore >= 30) qualityLevel = 'poor'
  else qualityLevel = 'veryPoor'

  // æ ¹æ®å›ç­”ç‰¹å¾è¿›è¡Œè°ƒæ•´
  let adjustmentFactor = 0

  if (length > 100) adjustmentFactor += 0.2 // è¯¦ç»†å›ç­”åŠ æˆ
  if (hasExamples) adjustmentFactor += 0.3 // æœ‰å®ä¾‹åŠ æˆ
  if (hasTechnicalTerms) adjustmentFactor += 0.2 // æŠ€æœ¯æœ¯è¯­åŠ æˆ
  if (hasPersonalExperience) adjustmentFactor += 0.2 // ä¸ªäººç»éªŒåŠ æˆ

  // åº”ç”¨è°ƒæ•´
  if (adjustmentFactor >= 0.6 && qualityLevel !== 'excellent') {
    // å‡çº§è´¨é‡ç­‰çº§
    const levels = ['veryPoor', 'poor', 'average', 'good', 'excellent']
    const currentIndex = levels.indexOf(qualityLevel)
    qualityLevel = levels[Math.min(currentIndex + 1, levels.length - 1)]
  }

  return qualityLevel
}

// åˆ†æå¯¹è¯æµç¨‹ç‰¹å¾
const analyzeConversationFlow = (userAnswer, aiResponse) => {
  const previousMessages = conversationHistory.value.slice(-4) // æœ€è¿‘4æ¡æ¶ˆæ¯
  const lastAiMessage = previousMessages.filter(msg => msg.type === 'ai').slice(-1)[0]

  const features = {
    topicContinuity: false,
    depthProgression: false,
    exampleProvided: false,
    activeEngagement: false,
    conceptIntegration: false,
    newConcepts: []
  }

  // 1. è¯é¢˜è¿ç»­æ€§æ£€æµ‹
  if (lastAiMessage && lastAiMessage.content) {
    const aiKeywords = extractKeywords(lastAiMessage.content)
    const userKeywords = extractKeywords(userAnswer)
    const overlap = aiKeywords.filter(keyword => userKeywords.includes(keyword))

    if (overlap.length > 0 ||
        userAnswer.includes('æ‚¨æåˆ°') ||
        userAnswer.includes('åˆšæ‰') ||
        userAnswer.includes('åŸºäºæ‚¨çš„é—®é¢˜')) {
      features.topicContinuity = true
    }
  }

  // 2. æ·±åº¦é€’è¿›æ£€æµ‹
  const depthIndicators = [
    'å…·ä½“æ¥è¯´', 'è¯¦ç»†åœ°è¯´', 'è¿›ä¸€æ­¥', 'æ·±å…¥', 'æ›´å…·ä½“',
    'ä»æŠ€æœ¯è§’åº¦', 'ä»å®ç°è§’åº¦', 'ä»æ¶æ„è§’åº¦', 'åº•å±‚åŸç†'
  ]
  if (depthIndicators.some(indicator => userAnswer.includes(indicator))) {
    features.depthProgression = true
  }

  // 3. å®ä¾‹æä¾›æ£€æµ‹
  const exampleIndicators = [
    'ä¾‹å¦‚', 'æ¯”å¦‚', 'ä¸¾ä¾‹', 'æ¡ˆä¾‹', 'å®é™…é¡¹ç›®', 'æˆ‘åœ¨é¡¹ç›®ä¸­',
    'å…·ä½“çš„ä¾‹å­', 'å®é™…åº”ç”¨', 'å®è·µä¸­'
  ]
  if (exampleIndicators.some(indicator => userAnswer.includes(indicator))) {
    features.exampleProvided = true
  }

  // 4. ä¸»åŠ¨å‚ä¸æ£€æµ‹
  const engagementIndicators = [
    'æˆ‘æƒ³è¡¥å……', 'æˆ‘è¿˜æƒ³è¯´', 'å¦å¤–', 'è¿˜æœ‰ä¸€ç‚¹', 'æˆ‘è®¤ä¸º',
    'æˆ‘çš„ç†è§£æ˜¯', 'æˆ‘è§‰å¾—', 'ä»æˆ‘çš„ç»éªŒ'
  ]
  if (engagementIndicators.some(indicator => userAnswer.includes(indicator))) {
    features.activeEngagement = true
  }

  // 5. æ¦‚å¿µæ•´åˆæ£€æµ‹
  const technicalConcepts = extractTechnicalConcepts(userAnswer)
  if (technicalConcepts.length > 1) {
    features.conceptIntegration = true
    features.newConcepts = technicalConcepts
  }

  return features
}

// æå–å…³é”®è¯
const extractKeywords = (text) => {
  const keywords = text.match(/[\u4e00-\u9fa5]{2,}|[a-zA-Z]{3,}/g) || []
  return keywords.filter(word => word.length >= 2).slice(0, 10)
}

// æå–æŠ€æœ¯æ¦‚å¿µ
const extractTechnicalConcepts = (text) => {
  const technicalTerms = [
    'ç®—æ³•', 'æ¨¡å‹', 'æ¶æ„', 'æ¡†æ¶', 'ç³»ç»Ÿ', 'æ•°æ®åº“', 'ç¼“å­˜', 'è´Ÿè½½å‡è¡¡',
    'å¾®æœåŠ¡', 'å®¹å™¨', 'äº‘è®¡ç®—', 'å¤§æ•°æ®', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'ç¥ç»ç½‘ç»œ',
    'API', 'REST', 'GraphQL', 'Docker', 'Kubernetes', 'Redis', 'MySQL',
    'MongoDB', 'Elasticsearch', 'Kafka', 'RabbitMQ', 'Nginx', 'Apache'
  ]

  return technicalTerms.filter(term => text.includes(term))
}

// è®¡ç®—å¯¹è¯æµç•…åº¦åˆ†æ•°
const calculateConversationFluency = (answerRecord) => {
  const fluencyMetrics = conversationScoring.value.fluencyMetrics

  // 1. å“åº”æ—¶é—´è¯„ä¼°ï¼ˆç†æƒ³å“åº”æ—¶é—´ï¼š30ç§’-2åˆ†é’Ÿï¼‰
  const responseTime = answerRecord.responseTime / 1000 // è½¬æ¢ä¸ºç§’
  fluencyMetrics.responseTime.push(responseTime)

  let timeScore = 100
  if (responseTime < 10) timeScore = 60 // å¤ªå¿«å¯èƒ½æ€è€ƒä¸å……åˆ†
  else if (responseTime <= 30) timeScore = 80
  else if (responseTime <= 120) timeScore = 100 // ç†æƒ³æ—¶é—´
  else if (responseTime <= 300) timeScore = 85
  else timeScore = 70 // è¶…è¿‡5åˆ†é’Ÿæ‰£åˆ†

  // 2. è¯é¢˜è¿ç»­æ€§è¯„ä¼°
  const conversationRounds = interviewState.value.conversationRounds
  if (conversationRounds > 1) {
    // æ£€æŸ¥æ˜¯å¦ä¸å‰ä¸€è½®å¯¹è¯æœ‰è‰¯å¥½çš„è¿æ¥
    const lastAiMessage = conversationHistory.value
      .filter(msg => msg.type === 'ai')
      .slice(-1)[0]

    if (lastAiMessage && lastAiMessage.content) {
      // ç®€å•çš„è¯é¢˜è¿ç»­æ€§æ£€æµ‹
      const hasGoodTransition =
        answerRecord.content.includes('æ‚¨æåˆ°') ||
        answerRecord.content.includes('åˆšæ‰') ||
        answerRecord.content.includes('åŸºäº') ||
        answerRecord.content.includes('è¡¥å……') ||
        answerRecord.content.length > 50 // è¯¦ç»†å›ç­”é€šå¸¸è¿ç»­æ€§æ›´å¥½

      fluencyMetrics.topicContinuity += hasGoodTransition ? 10 : 0
    }
  }

  // 3. äº’åŠ¨è´¨é‡è¯„ä¼°
  const interactionQuality = Math.min(100,
    timeScore * 0.4 +
    Math.min(100, fluencyMetrics.topicContinuity) * 0.3 +
    (answerRecord.content.length > 30 ? 80 : 50) * 0.3
  )

  fluencyMetrics.interactionQuality = interactionQuality

  return Math.round(interactionQuality)
}

// è®¡ç®—æ¸è¿›æ”¹å–„åˆ†æ•°
const calculateProgressiveImprovement = () => {
  const history = conversationScoring.value.answerHistory
  if (history.length < 2) return 70 // é¦–æ¬¡å›ç­”ç»™åŸºç¡€åˆ†

  // åˆ†ææœ€è¿‘3æ¬¡å›ç­”çš„è¶‹åŠ¿
  const recentAnswers = history.slice(-3)
  const scores = recentAnswers.map(a => a.singleScore)

  // è®¡ç®—æ”¹å–„è¶‹åŠ¿
  let improvementTrend = 0
  for (let i = 1; i < scores.length; i++) {
    const improvement = scores[i] - scores[i-1]
    improvementTrend += improvement
  }

  // åŸºç¡€æ”¹å–„åˆ†æ•°
  let improvementScore = 70

  if (improvementTrend > 10) improvementScore = 90 // æ˜¾è‘—æ”¹å–„
  else if (improvementTrend > 0) improvementScore = 80 // æœ‰æ”¹å–„
  else if (improvementTrend === 0) improvementScore = 75 // ä¿æŒç¨³å®š
  else if (improvementTrend > -10) improvementScore = 65 // è½»å¾®ä¸‹é™
  else improvementScore = 50 // æ˜æ˜¾ä¸‹é™

  // è€ƒè™‘å›ç­”é•¿åº¦çš„æ”¹å–„
  const lengths = recentAnswers.map(a => a.content.length)
  const avgLength = lengths.reduce((sum, len) => sum + len, 0) / lengths.length
  if (avgLength > 100) improvementScore += 5 // è¯¦ç»†å›ç­”åŠ åˆ†

  return Math.min(100, improvementScore)
}

// è®¡ç®—ä¸€è‡´æ€§åˆ†æ•°
const calculateConsistency = () => {
  const history = conversationScoring.value.answerHistory
  if (history.length < 2) return 80 // é¦–æ¬¡å›ç­”ç»™è¾ƒé«˜åŸºç¡€åˆ†

  // åˆ†æå›ç­”è´¨é‡çš„ä¸€è‡´æ€§
  const scores = history.map(a => a.singleScore)
  const avgScore = scores.reduce((sum, score) => sum + score, 0) / scores.length

  // è®¡ç®—æ ‡å‡†å·®
  const variance = scores.reduce((sum, score) => sum + Math.pow(score - avgScore, 2), 0) / scores.length
  const standardDeviation = Math.sqrt(variance)

  // ä¸€è‡´æ€§åˆ†æ•°ï¼šæ ‡å‡†å·®è¶Šå°ï¼Œä¸€è‡´æ€§è¶Šé«˜
  let consistencyScore = 100 - (standardDeviation * 2)
  consistencyScore = Math.max(50, Math.min(100, consistencyScore))

  return Math.round(consistencyScore)
}

// åŸºäºå¯¹è¯æµç¨‹çš„æ™ºèƒ½è·³é¢˜åˆ¤æ–­
const shouldTransitionToNextQuestion = () => {
  const flow = conversationScoring.value.conversationFlow
  const conditions = conversationScoring.value.transitionConditions
  const currentScore = conversationScoring.value.currentQuestionScore

  console.log('ğŸ¤” è¯„ä¼°å¯¹è¯æµç¨‹è·³é¢˜æ¡ä»¶:', {
    å½“å‰åˆ†æ•°: currentScore,
    æ€»å¯¹è¯è½®æ¬¡: flow.totalTurns,
    æœ‰æ„ä¹‰è½®æ¬¡: flow.meaningfulTurns,
    æ¦‚å¿µè¦†ç›–æ•°: flow.conceptsCovered.size,
    è¯é¢˜æ·±åº¦: flow.topicDepth,
    å®ä¾‹æ•°é‡: flow.examplesProvided
  })

  // 1. åˆ†æ•°è¾¾æ ‡æ£€æŸ¥
  const scoreReached = currentScore >= conditions.scoreThreshold

  // 2. æœ€å°‘è½®æ¬¡æ£€æŸ¥
  const minTurnsReached = flow.totalTurns >= conditions.minTurns

  // 3. æ¦‚å¿µè¦†ç›–æ£€æŸ¥
  const conceptsCovered = flow.conceptsCovered.size >= conditions.conceptCoverage

  // 4. æ·±åº¦è¦æ±‚æ£€æŸ¥
  const depthReached = flow.topicDepth >= conditions.depthRequirement

  // 5. å¼ºåˆ¶è·³é¢˜æ£€æŸ¥ï¼ˆé¿å…è¿‡é•¿å¯¹è¯ï¼‰
  const forceTransition = flow.totalTurns >= conditions.maxTurns

  // 6. é«˜è´¨é‡å¿«é€Ÿé€šè¿‡æ£€æŸ¥
  const excellentPerformance = currentScore >= 85 &&
                              flow.meaningfulTurns >= 2 &&
                              flow.examplesProvided >= 1

  // 7. ç»¼åˆåˆ¤æ–­
  if (forceTransition) {
    console.log('âœ… è¾¾åˆ°æœ€å¤§å¯¹è¯è½®æ¬¡ï¼Œå¼ºåˆ¶è·³é¢˜')
    return true
  }

  if (excellentPerformance) {
    console.log('âœ… è¡¨ç°ä¼˜ç§€ï¼Œå¿«é€Ÿé€šè¿‡')
    return true
  }

  if (scoreReached && minTurnsReached && (conceptsCovered || depthReached)) {
    console.log('âœ… æ»¡è¶³ç»¼åˆè·³é¢˜æ¡ä»¶')
    return true
  }

  // 8. ç‰¹æ®Šæƒ…å†µï¼šåˆ†æ•°å¾ˆé«˜ä½†å…¶ä»–æ¡ä»¶ä¸è¶³
  if (currentScore >= 90 && flow.totalTurns >= 2) {
    console.log('âœ… åˆ†æ•°æé«˜ï¼Œå…è®¸è·³é¢˜')
    return true
  }

  console.log('âŒ æœªæ»¡è¶³è·³é¢˜æ¡ä»¶ï¼Œç»§ç»­å½“å‰é—®é¢˜')
  return false
}

// é‡ç½®å¯¹è¯æµç¨‹è¯„åˆ†çŠ¶æ€ï¼ˆåˆ‡æ¢åˆ°æ–°é—®é¢˜æ—¶è°ƒç”¨ï¼‰
const resetConversationScoring = () => {
  console.log('ğŸ”„ é‡ç½®å¯¹è¯æµç¨‹è¯„åˆ†çŠ¶æ€')

  // é‡ç½®å½“å‰é—®é¢˜çš„å¯¹è¯æµç¨‹çŠ¶æ€
  conversationScoring.value.currentQuestionScore = 0
  conversationScoring.value.conversationFlow = {
    totalTurns: 0,
    meaningfulTurns: 0,
    topicDepth: 0,
    conceptsCovered: new Set(),
    examplesProvided: 0,
    clarificationsAsked: 0,
    buildOnPrevious: 0
  }

  // æ ¹æ®å†å²è¡¨ç°åŠ¨æ€è°ƒæ•´è·³é¢˜é˜ˆå€¼
  const previousQuestions = Math.max(1, currentQuestion.value - 1)
  const avgPerformance = conversationScoring.value.currentQuestionScore / Math.max(1, conversationScoring.value.conversationFlow.totalTurns)

  if (avgPerformance >= 15) {
    // é«˜æ°´å¹³å€™é€‰äººï¼šé™ä½é˜ˆå€¼ï¼ŒåŠ å¿«è¿›åº¦
    conversationScoring.value.transitionConditions.scoreThreshold = 70
    conversationScoring.value.transitionConditions.minTurns = 2
  } else if (avgPerformance >= 10) {
    // ä¸­ç­‰æ°´å¹³å€™é€‰äººï¼šæ ‡å‡†é˜ˆå€¼
    conversationScoring.value.transitionConditions.scoreThreshold = 75
    conversationScoring.value.transitionConditions.minTurns = 2
  } else {
    // è¾ƒä½æ°´å¹³å€™é€‰äººï¼šæé«˜é˜ˆå€¼ï¼Œç»™æ›´å¤šæœºä¼š
    conversationScoring.value.transitionConditions.scoreThreshold = 80
    conversationScoring.value.transitionConditions.minTurns = 3
  }

  console.log('ğŸ“Š æ–°é—®é¢˜è·³é¢˜æ¡ä»¶:', {
    åˆ†æ•°é˜ˆå€¼: conversationScoring.value.transitionConditions.scoreThreshold,
    æœ€å°‘è½®æ¬¡: conversationScoring.value.transitionConditions.minTurns,
    æœ€å¤šè½®æ¬¡: conversationScoring.value.transitionConditions.maxTurns
  })
}

// å®æ—¶æ›´æ–°åˆ†ææ•°æ®
const updateRealTimeAnalysis = (analysis) => {
  if (!analysis) return

  // æ›´æ–°å®æ—¶åˆ†ææ•°æ®
  realTimeAnalysis.value = {
    overallScore: analysis.overallScore || realTimeAnalysis.value.overallScore,
    technicalCompetency: analysis.technicalCompetency || realTimeAnalysis.value.technicalCompetency,
    communicationSkills: analysis.communicationSkills || realTimeAnalysis.value.communicationSkills,
    contentQuality: analysis.contentQuality || realTimeAnalysis.value.contentQuality,
    lastUpdated: new Date().toLocaleTimeString()
  }

  // æ›´æ–°SparkæŒ‡æ ‡
  sparkMetrics.value.responseTime = Math.floor(Math.random() * 200) + 100 // æ¨¡æ‹Ÿå“åº”æ—¶é—´
  sparkMetrics.value.accuracy = Math.min(95, sparkMetrics.value.accuracy + Math.random() * 2)
  sparkMetrics.value.processedTokens += Math.floor(Math.random() * 50) + 20

  // æ›´æ–°æœ€ååˆ†ææ—¶é—´
  lastAnalysisTime.value = Math.floor(Math.random() * 500) + 200

  console.log('ğŸ“Š å®æ—¶åˆ†ææ•°æ®å·²æ›´æ–°:', realTimeAnalysis.value)
}

// æ™ºèƒ½æ»šåŠ¨æ§åˆ¶ç³»ç»Ÿ
const scrollState = ref({
  userScrolledUp: false,        // ç”¨æˆ·æ˜¯å¦ä¸»åŠ¨å‘ä¸Šæ»šåŠ¨
  lastScrollTop: 0,             // ä¸Šæ¬¡æ»šåŠ¨ä½ç½®
  autoScrollEnabled: true,      // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
  scrollThreshold: 100,         // æ»šåŠ¨é˜ˆå€¼ï¼ˆè·ç¦»åº•éƒ¨å¤šå°‘åƒç´ è®¤ä¸ºç”¨æˆ·åœ¨æŸ¥çœ‹å†å²ï¼‰
  userInteractionTime: 0,       // ç”¨æˆ·æœ€åäº¤äº’æ—¶é—´
  showScrollToBottomHint: false // æ˜¯å¦æ˜¾ç¤º"å›åˆ°æœ€æ–°"æç¤º
})

// å¢å¼ºçš„ç”¨æˆ·æ»šåŠ¨è¡Œä¸ºæ£€æµ‹
const handleUserScroll = () => {
  const container = messagesContainer.value
  if (!container) return

  const currentScrollTop = container.scrollTop
  const scrollHeight = container.scrollHeight
  const clientHeight = container.clientHeight
  const distanceFromBottom = scrollHeight - clientHeight - currentScrollTop
  const scrollDelta = Math.abs(currentScrollTop - scrollState.value.lastScrollTop)

  // æ£€æµ‹ç”¨æˆ·æ˜¯å¦ä¸»åŠ¨å‘ä¸Šæ»šåŠ¨ï¼ˆå¢åŠ æœ€å°æ»šåŠ¨è·ç¦»é˜ˆå€¼ï¼‰
  if (currentScrollTop < scrollState.value.lastScrollTop && scrollDelta > 10) {
    // ç”¨æˆ·å‘ä¸Šæ»šåŠ¨
    scrollState.value.userScrolledUp = true
    scrollState.value.userInteractionTime = Date.now()

    // å¦‚æœè·ç¦»åº•éƒ¨è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤º"å›åˆ°æœ€æ–°"æç¤º
    if (distanceFromBottom > scrollState.value.scrollThreshold) {
      scrollState.value.showScrollToBottomHint = true
    }
  } else if (distanceFromBottom <= 30) {
    // ç”¨æˆ·æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘ï¼Œé‡æ–°å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
    scrollState.value.userScrolledUp = false
    scrollState.value.showScrollToBottomHint = false
    scrollState.value.autoScrollEnabled = true
  }

  scrollState.value.lastScrollTop = currentScrollTop
}

// æ·»åŠ é”®ç›˜æ»šåŠ¨æ”¯æŒ
const handleKeyboardScroll = (event) => {
  const container = messagesContainer.value
  if (!container) return

  const scrollStep = 120 // å¢åŠ æ»šåŠ¨æ­¥é•¿

  switch (event.key) {
    case 'ArrowUp':
      event.preventDefault()
      container.scrollBy({ top: -scrollStep, behavior: 'smooth' })
      break
    case 'ArrowDown':
      event.preventDefault()
      container.scrollBy({ top: scrollStep, behavior: 'smooth' })
      break
    case 'PageUp':
      event.preventDefault()
      container.scrollBy({ top: -container.clientHeight * 0.8, behavior: 'smooth' })
      break
    case 'PageDown':
      event.preventDefault()
      container.scrollBy({ top: container.clientHeight * 0.8, behavior: 'smooth' })
      break
    case 'Home':
      if (event.ctrlKey) {
        event.preventDefault()
        container.scrollTo({ top: 0, behavior: 'smooth' })
      }
      break
    case 'End':
      if (event.ctrlKey) {
        event.preventDefault()
        scrollToBottom(true, true)
      }
      break
  }
}

// å¢å¼ºçš„æ™ºèƒ½æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ”¯æŒå¹³æ»‘æ»šåŠ¨å’Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼‰
const scrollToBottom = (force = false, smooth = true) => {
  nextTick(() => {
    try {
      const container = messagesContainer.value
      if (!container) {
        console.warn('âš ï¸ messagesContainerå¼•ç”¨æœªæ‰¾åˆ°')
        return
      }

      // å¦‚æœç”¨æˆ·ä¸»åŠ¨å‘ä¸Šæ»šåŠ¨ä¸”ä¸æ˜¯å¼ºåˆ¶æ»šåŠ¨ï¼Œåˆ™ä¸è‡ªåŠ¨æ»šåŠ¨
      if (scrollState.value.userScrolledUp && !force) {
        console.log('ğŸ“œ ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹å†å²æ¶ˆæ¯ï¼Œè·³è¿‡è‡ªåŠ¨æ»šåŠ¨')
        return
      }

      // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ»šåŠ¨ï¼ˆç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘ï¼‰
      const scrollHeight = container.scrollHeight
      const clientHeight = container.clientHeight
      const currentScrollTop = container.scrollTop
      const distanceFromBottom = scrollHeight - clientHeight - currentScrollTop

      if (force || distanceFromBottom <= scrollState.value.scrollThreshold) {
        // ä½¿ç”¨å¹³æ»‘æ»šåŠ¨æˆ–ç«‹å³æ»šåŠ¨
        if (smooth && container.scrollTo) {
          container.scrollTo({
            top: scrollHeight,
            behavior: 'smooth'
          })
        } else {
          container.scrollTop = scrollHeight
        }

        scrollState.value.lastScrollTop = scrollHeight
        scrollState.value.userScrolledUp = false
        scrollState.value.showScrollToBottomHint = false
        console.log('ğŸ“œ æ™ºèƒ½æ»šåŠ¨åˆ°åº•éƒ¨å®Œæˆ (å¹³æ»‘:', smooth, ')')
      } else {
        console.log('ğŸ“œ ç”¨æˆ·ä¸åœ¨åº•éƒ¨é™„è¿‘ï¼Œè·³è¿‡è‡ªåŠ¨æ»šåŠ¨')
      }
    } catch (error) {
      console.error('âŒ æ»šåŠ¨åˆ°åº•éƒ¨å¤±è´¥:', error)
    }
  })
}

// å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆç”¨æˆ·ç‚¹å‡»"å›åˆ°æœ€æ–°"æŒ‰é’®æ—¶ï¼‰
const forceScrollToBottom = () => {
  scrollToBottom(true)
  ElMessage.success('å·²å›åˆ°æœ€æ–°æ¶ˆæ¯')
}

// é‡ç½®æ»šåŠ¨çŠ¶æ€ï¼ˆæäº¤å›ç­”æ—¶è°ƒç”¨ï¼‰
const resetScrollStateForNewMessage = () => {
  scrollState.value.userScrolledUp = false
  scrollState.value.autoScrollEnabled = true
  scrollState.value.showScrollToBottomHint = false
  console.log('ğŸ“œ æ»šåŠ¨çŠ¶æ€å·²é‡ç½®ï¼Œå‡†å¤‡è·Ÿéšæ–°æ¶ˆæ¯')
}

// å®šæ—¶å™¨
let timer = null
let responseTimeChecker = null

// æ£€æŸ¥å›ç­”æ—¶é—´çš„å®šæ—¶å™¨
const startResponseTimeChecker = () => {
  if (responseTimeChecker) {
    clearInterval(responseTimeChecker)
  }

  responseTimeChecker = setInterval(() => {
    if (interviewState.value.responseTimeStart) {
      const elapsed = Date.now() - interviewState.value.responseTimeStart

      // 30ç§’æé†’
      if (elapsed > 30000 && elapsed < 35000 && !interviewState.value.timeoutWarningShown) {
        ElMessage.warning('å»ºè®®åœ¨é¢è¯•ä¸­åŠæ—¶å›ç­”ï¼Œå¯ä»¥å…ˆè¯´å‡ºæ‚¨çŸ¥é“çš„éƒ¨åˆ†')
      }

      // 45ç§’å¼ºæé†’
      if (elapsed > 45000 && !interviewState.value.timeoutWarningShown) {
        ElMessage.error('å›ç­”æ—¶é—´è¾ƒé•¿ï¼Œå»ºè®®å…ˆè¡¨è¾¾æ‚¨çš„æƒ³æ³•ï¼Œç„¶åé€æ­¥å®Œå–„')
        interviewState.value.timeoutWarningShown = true
      }
    }
  }, 5000) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(async () => {
  // å¯åŠ¨è®¡æ—¶å™¨
  timer = setInterval(() => {
    elapsedTime.value++
  }, 1000)

  // å¯åŠ¨å›ç­”æ—¶é—´æ£€æŸ¥å™¨
  startResponseTimeChecker()

  // åˆå§‹åŒ–æ»šåŠ¨çŠ¶æ€
  nextTick(() => {
    const container = messagesContainer.value
    if (container) {
      scrollState.value.lastScrollTop = container.scrollTop
      console.log('ğŸ“œ æ»šåŠ¨çŠ¶æ€å·²åˆå§‹åŒ–')
    }
  })

  // åˆå§‹åŒ–è®¯é£æ˜Ÿç«æœåŠ¡
  await initializeSparkService()
})

onUnmounted(() => {
  if (timer) {
    clearInterval(timer)
  }
  if (responseTimeChecker) {
    clearInterval(responseTimeChecker)
  }
})
</script>

<style scoped>
.text-primary-interview-page {
  min-height: 100vh;
  background:
    radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
    linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  background-attachment: fixed;
  display: flex;
  flex-direction: column;
  position: relative;
}

.text-primary-interview-page::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background:
    url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.05)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.03)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.04)"/><circle cx="10" cy="60" r="0.8" fill="rgba(255,255,255,0.02)"/><circle cx="90" cy="40" r="0.6" fill="rgba(255,255,255,0.03)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
  pointer-events: none;
  z-index: 0;
}

.interview-header {
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(24, 144, 255, 0.1);
  padding: 20px 32px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  position: relative;
  z-index: 10;
}

.interview-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #1890ff 0%, #40a9ff 50%, #1890ff 100%);
  background-size: 200% 100%;
  animation: headerGlow 3s ease-in-out infinite;
}

@keyframes headerGlow {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1400px;
  margin: 0 auto;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo-icon {
  color: #1890ff;
  font-size: 24px;
}

.header-left h1 {
  margin: 0;
  color: #262626;
  font-size: 20px;
  font-weight: 600;
}

.interview-mode {
  padding: 4px 12px;
  background: #e6f7ff;
  color: #1890ff;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 24px;
}

.interview-progress {
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 150px;
}

.interview-timer {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  color: #262626;
}

.interview-main {
  flex: 1;
  padding: 24px;
}

.interview-layout {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 24px;
  max-width: 1400px;
  margin: 0 auto;
  min-height: calc(100vh - 120px);
  align-items: start;
}

.conversation-section {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 36px;
  display: flex;
  flex-direction: column;
  box-shadow:
    0 8px 32px rgba(0, 0, 0, 0.12),
    0 2px 8px rgba(0, 0, 0, 0.08),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.3);
  height: calc(60vh - 60px); /* å‡å°‘é«˜åº¦ï¼Œä¸ºä¸‹æ–¹åˆ†æé¢æ¿ç•™å‡ºç©ºé—´ */
  min-height: 500px;
  max-width: 1400px;
  width: 100%;
  margin: 0 auto;
  overflow: hidden;
  position: relative;
  z-index: 5;
}

.conversation-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  gap: 12px; /* å‡å°‘é—´è· */
}

.conversation-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 20px;
  background: linear-gradient(135deg, rgba(24, 144, 255, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%);
  pointer-events: none;
  z-index: -1;
}

.conversation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 16px;
  border-bottom: 1px solid #f0f0f0;
}

.header-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-info h3 {
  margin: 0;
  color: #262626;
  font-size: 18px;
}

.mode-indicator {
  padding: 2px 8px;
  background: #f6ffed;
  color: #52c41a;
  border-radius: 4px;
  font-size: 12px;
}

.conversation-history {
  flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
  display: flex;
  flex-direction: column;
  min-height: 0; /* å…è®¸flexå­é¡¹æ”¶ç¼© */
  overflow: hidden; /* æ¢å¤overflowæ§åˆ¶ï¼Œé˜²æ­¢å†…å®¹æº¢å‡ºåˆ°å…¶ä»–åŒºåŸŸ */
  margin: 8px 0; /* å¢åŠ ä¸Šä¸‹è¾¹è· */
}

.messages-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px 0; /* å¢åŠ ä¸Šä¸‹å†…è¾¹è· */
  display: flex;
  flex-direction: column;
  gap: 20px; /* å¢åŠ æ¶ˆæ¯é—´è· */
  min-height: 200px; /* å‡å°‘æœ€å°é«˜åº¦ï¼Œé¿å…å ç”¨è¿‡å¤šç©ºé—´ */
  max-height: calc(100vh - 400px); /* é‡æ–°è®¾ç½®åˆç†çš„æœ€å¤§é«˜åº¦ï¼Œä¸ºé—®é¢˜æ å’Œè¾“å…¥æ ç•™å‡ºç©ºé—´ */
  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
  scrollbar-width: thin;
  scrollbar-color: #d9d9d9 transparent;
}

.message-item {
  display: flex;
  gap: 12px;
}

.message-item.ai {
  flex-direction: row;
}

.message-item.user {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #f0f0f0;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.message-item.ai .message-avatar {
  background: var(--info-bg-wcag);
  color: var(--info-wcag-aa);
}

.message-item.user .message-avatar {
  background: var(--success-bg-wcag);
  color: var(--success-wcag-aa);
}

.message-content {
  flex: 1;
  max-width: 80%; /* å¢åŠ æ¶ˆæ¯å†…å®¹æœ€å¤§å®½åº¦ */
  min-width: 0; /* å…è®¸å†…å®¹æ”¶ç¼© */
  word-wrap: break-word; /* é•¿å•è¯æ¢è¡Œ */
  overflow-wrap: break-word; /* ç°ä»£æµè§ˆå™¨æ”¯æŒ */
  overflow: visible; /* ç¡®ä¿å†…å®¹å®Œæ•´æ˜¾ç¤º */
}

.message-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.message-sender {
  font-weight: 500;
  color: var(--text-primary-aaa);
  font-size: 14px;
}

.message-time {
  font-size: 12px;
  color: var(--text-tertiary-aa);
}

.message-text {
  background: var(--bg-tertiary-wcag);
  padding: 16px 20px; /* å¢åŠ å†…è¾¹è· */
  border-radius: 12px;
  line-height: 1.6; /* å¢åŠ è¡Œé«˜ */
  color: var(--text-primary-aaa);
  word-wrap: break-word;
  overflow-wrap: break-word;
  white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œç¬¦å’Œç©ºæ ¼ */
  max-width: 100%;
  font-size: 15px; /* å¢åŠ å­—ä½“å¤§å° */
  min-height: 24px; /* è®¾ç½®æœ€å°é«˜åº¦ */
}

.message-item.ai .message-text {
  background: #e6f7ff;
}

.message-item.user .message-text {
  background: #f6ffed;
}

.message-analysis {
  margin-top: 8px;
}

.analysis-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.score-tag, .keywords-tag {
  padding: 2px 8px;
  background: #fff7e6;
  color: #fa8c16;
  border-radius: 4px;
  font-size: 12px;
}

.current-question-panel {
  background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
  border-radius: 12px;
  padding: 16px; /* å‡å°‘å†…è¾¹è· */
  border: 2px solid #1890ff;
  box-shadow: 0 4px 12px rgba(24, 144, 255, 0.1);
  margin-bottom: 12px; /* å‡å°‘ä¸‹è¾¹è· */
  flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
  max-height: 180px; /* é™åˆ¶é—®é¢˜é¢æ¿æœ€å¤§é«˜åº¦ */
  overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶å¯æ»šåŠ¨ */
  z-index: 10; /* ç¡®ä¿é—®é¢˜æ åœ¨ä¸Šå±‚æ˜¾ç¤º */
}

.question-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.question-icon {
  color: #1890ff;
  font-size: 18px;
}

.question-title {
  font-weight: 600;
  color: #1890ff;
  font-size: 16px;
}

.question-text-container {
  background: white;
  border-radius: 8px;
  padding: 12px; /* å‡å°‘å†…è¾¹è· */
  margin-bottom: 8px; /* å‡å°‘ä¸‹è¾¹è· */
  border: 1px solid #d9d9d9;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
}

.question-text {
  font-size: 15px; /* ç¨å¾®å‡å°å­—ä½“ */
  line-height: 1.5; /* å‡å°‘è¡Œé«˜ */
  color: #262626;
  margin: 0;
  font-weight: 500;
  letter-spacing: 0.3px;
}

.question-meta {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}

.question-meta .el-tag {
  display: flex;
  align-items: center;
  gap: 4px;
  font-weight: 500;
  padding: 4px 8px;
}

.answer-input-panel {
  border: 1px solid #d9d9d9;
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
  max-height: 200px; /* é™åˆ¶è¾“å…¥é¢æ¿æœ€å¤§é«˜åº¦ */
  z-index: 10; /* ç¡®ä¿è¾“å…¥æ åœ¨ä¸Šå±‚æ˜¾ç¤º */
  margin-top: 12px; /* ä¸æ¶ˆæ¯åŒºåŸŸä¿æŒé—´è· */
}

.input-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px; /* å‡å°‘å†…è¾¹è· */
  background: #fafafa;
  border-bottom: 1px solid #f0f0f0;
}

.input-label {
  font-weight: 500;
  color: #262626;
}

.input-tools {
  display: flex;
  gap: 8px;
}

.answer-textarea {
  border: none;
}

.answer-textarea :deep(.el-textarea__inner) {
  border: none;
  box-shadow: none;
  resize: none;
  font-size: 14px;
  line-height: 1.5;
}

/* å¢å¼ºçš„è¾“å…¥åŒºåŸŸæ ·å¼ */
.input-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 1px solid #dee2e6;
  border-radius: 12px 12px 0 0;
}

.input-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.input-label {
  font-weight: 600;
  color: #495057;
  font-size: 16px;
}

.input-container {
  position: relative;
}

.textarea-wrapper {
  position: relative;
}

.corner-submit-btn {
  position: absolute;
  bottom: 8px;
  right: 8px;
  z-index: 10;
  border-radius: 6px;
  padding: 6px 8px;
  min-width: 36px;
  height: 28px;
  box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3);
  transition: all 0.3s ease;
}

.corner-submit-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
}

.corner-submit-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.answer-textarea {
  border-radius: 0;
  border-left: none;
  border-right: none;
}

/* æ™ºèƒ½å»ºè®®é¢æ¿ */
.smart-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(24, 144, 255, 0.2);
  border-radius: 0 0 12px 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  z-index: 10;
  max-height: 200px;
  overflow-y: auto;
}

.suggestions-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%);
  border-bottom: 1px solid rgba(24, 144, 255, 0.1);
  font-weight: 500;
  color: #1890ff;
  font-size: 14px;
}

.suggestions-list {
  padding: 8px 0;
}

.suggestion-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  color: #495057;
}

.suggestion-item:hover {
  background: rgba(24, 144, 255, 0.05);
  color: #1890ff;
}

.input-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-top: 1px solid #dee2e6;
  border-radius: 0 0 12px 12px;
}

.input-footer-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.input-hint {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: #8c8c8c;
}

.input-actions {
  display: flex;
  gap: 8px;
}

/* AIæ™ºèƒ½æç¤ºæµ®å±‚é¢æ¿æ ·å¼ */
.ai-hints-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(4px);
}

.ai-hints-floating-panel {
  background: white;
  border-radius: 16px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow: hidden;
  animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.hints-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px 16px 24px;
  border-bottom: 1px solid #f0f0f0;
  background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
}

.hints-title {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  font-size: 18px;
  color: #1890ff;
}

.close-btn {
  color: #8c8c8c;
  transition: color 0.2s;
}

.close-btn:hover {
  color: #1890ff;
}

.hints-content {
  padding: 24px;
}

.hint-text-container {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border-left: 4px solid #1890ff;
}

.hint-text {
  color: #262626;
  line-height: 1.6;
  margin: 0;
  font-size: 15px;
}

.hint-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* å“åº”å¼è®¾è®¡ - AIæç¤ºæµ®å±‚ */
@media (max-width: 768px) {
  .ai-hints-floating-panel {
    width: 95%;
    max-height: 85vh;
  }

  .hints-header {
    padding: 16px 20px 12px 20px;
  }

  .hints-title {
    font-size: 16px;
  }

  .hints-content {
    padding: 20px;
  }

  .hint-text-container {
    padding: 16px;
  }

  .hint-text {
    font-size: 14px;
  }

  .hint-actions {
    flex-direction: column;
    gap: 8px;
  }

  .hint-actions .el-button {
    width: 100%;
  }
}

@media (max-width: 480px) {
  .ai-hints-floating-panel {
    width: 98%;
    max-height: 90vh;
  }

  .hints-header {
    padding: 12px 16px 8px 16px;
  }

  .hints-title {
    font-size: 15px;
    gap: 8px;
  }

  .hints-content {
    padding: 16px;
  }

  .hint-text-container {
    padding: 12px;
  }

  .hint-text {
    font-size: 13px;
  }
}

.analysis-section {
  display: flex;
  flex-direction: column;
  gap: 16px;
  height: calc(100vh - 120px); /* ä¸å¯¹è¯æ¡†é«˜åº¦ä¸€è‡´ */
  overflow-y: auto; /* å…è®¸æ»šåŠ¨ */
}

.spark-advantages-panel,
.spark-status-panel,
.text-analysis-panel,
.candidate-info-panel {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 20px;
  box-shadow:
    0 8px 32px rgba(0, 0, 0, 0.08),
    0 2px 8px rgba(0, 0, 0, 0.06),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.3);
  position: relative;
  transition: all 0.3s ease;
  margin-bottom: 16px;
}

.spark-advantages-panel:hover,
.spark-status-panel:hover,
.text-analysis-panel:hover,
.candidate-info-panel:hover {
  transform: translateY(-2px);
  box-shadow:
    0 12px 40px rgba(0, 0, 0, 0.12),
    0 4px 12px rgba(0, 0, 0, 0.08),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

/* iFlytek SparkæŠ€æœ¯ä¼˜åŠ¿é¢æ¿ */
.spark-advantages-panel {
  background: linear-gradient(135deg, rgba(24, 144, 255, 0.02) 0%, rgba(64, 169, 255, 0.02) 100%);
  border: 1px solid rgba(24, 144, 255, 0.15);
}

.advantages-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(24, 144, 255, 0.1);
}

.advantages-header h3 {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  color: #1890ff;
  font-size: 16px;
  font-weight: 600;
}

.tech-metrics {
  display: grid;
  gap: 12px;
  margin-bottom: 20px;
}

.metric-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 8px;
  border: 1px solid rgba(24, 144, 255, 0.1);
  transition: all 0.3s ease;
}

.metric-item:hover {
  background: rgba(24, 144, 255, 0.05);
  border-color: rgba(24, 144, 255, 0.2);
}

.metric-icon {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
}

.metric-info {
  flex: 1;
}

.metric-value {
  font-size: 18px;
  font-weight: 700;
  color: #1890ff;
  line-height: 1;
}

.metric-label {
  font-size: 12px;
  color: #666;
  margin-top: 2px;
}

.metric-status .status-icon {
  font-size: 16px;
}

.metric-status .status-icon.success {
  color: #52c41a;
}

.ai-capabilities {
  display: grid;
  gap: 12px;
}

.capability-item {
  padding: 12px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 8px;
  border: 1px solid rgba(24, 144, 255, 0.08);
}

.capability-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.capability-header span {
  font-weight: 500;
  color: #333;
  flex: 1;
}

.capability-desc {
  font-size: 12px;
  color: #666;
  line-height: 1.4;
}

.processing-stats {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid rgba(24, 144, 255, 0.1);
}

.stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  font-size: 13px;
}

.stat-label {
  color: #666;
}

.stat-value {
  font-weight: 600;
  color: #1890ff;
}

.status-header,
.panel-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px; /* å‡å°‘åº•éƒ¨é—´è· */
}

.status-header h3,
.panel-header h4 {
  margin: 0;
  color: #262626;
  font-size: 16px;
}

.spark-icon {
  color: #1890ff;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #8c8c8c;
}

.status-indicator.active {
  color: #52c41a;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #d9d9d9;
  transition: all 0.3s;
}

.status-indicator.active .status-dot {
  background: #52c41a;
  box-shadow: 0 0 8px rgba(82, 196, 26, 0.5);
}

.score-overview {
  display: flex;
  gap: 16px;
}

.overall-score {
  text-align: center;
  min-width: 80px;
}

.score-number {
  font-size: 32px;
  font-weight: bold;
  color: #1890ff;
  line-height: 1;
}

.score-label {
  font-size: 12px;
  color: #8c8c8c;
  margin-top: 4px;
}

.score-breakdown {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.score-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.score-name {
  width: 60px;
  font-size: 12px;
  color: #262626;
}

.score-bar {
  flex: 1;
  height: 6px;
  background: #f5f5f5;
  border-radius: 3px;
  overflow: hidden;
}

.score-fill {
  height: 100%;
  background: linear-gradient(90deg, #1890ff, #40a9ff);
  border-radius: 3px;
  transition: width 0.3s;
}

.score-value {
  width: 30px;
  text-align: right;
  font-size: 12px;
  color: #262626;
}

/* å¢å¼ºçš„è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
.messages-container {
  scroll-behavior: smooth; /* æ·»åŠ å¹³æ»‘æ»šåŠ¨ */
}

.messages-container::-webkit-scrollbar {
  width: 8px; /* å¢åŠ æ»šåŠ¨æ¡å®½åº¦ */
}

.messages-container::-webkit-scrollbar-track {
  background: #f5f5f5;
  border-radius: 4px;
  margin: 4px 0; /* æ·»åŠ ä¸Šä¸‹è¾¹è· */
}

.messages-container::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #d9d9d9 0%, #bfbfbf 100%);
  border-radius: 4px;
  transition: all 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
}

.messages-container::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #bfbfbf 0%, #8c8c8c 100%);
  transform: scaleX(1.2); /* æ‚¬åœæ—¶ç¨å¾®æ”¾å¤§ */
}

.messages-container::-webkit-scrollbar-thumb:active {
  background: linear-gradient(135deg, #8c8c8c 0%, #595959 100%);
}

/* å›åˆ°æœ€æ–°æ¶ˆæ¯æŒ‰é’® */
.scroll-to-bottom-hint {
  position: absolute;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  animation: fadeInUp 0.3s ease-out;
  cursor: pointer;
}

.scroll-to-bottom-hint .el-button {
  box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
  border: none;
  background: linear-gradient(135deg, #1890ff 0%, #0066cc 100%);
  color: white;
  font-weight: 500;
  padding: 8px 16px;
  transition: all 0.3s ease;
}

.scroll-to-bottom-hint .el-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(24, 144, 255, 0.4);
  background: linear-gradient(135deg, #40a9ff 0%, #1890ff 100%);
}

.scroll-to-bottom-hint .el-button .el-icon {
  margin-right: 4px;
  transform: rotate(90deg); /* å‘ä¸‹ç®­å¤´ */
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ç¡®ä¿è¾“å…¥åŒºåŸŸå§‹ç»ˆå¯è§ */
.answer-input-panel {
  margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
}

/* å¯¹è¯åŒºåŸŸä¼˜åŒ– */
.conversation-history {
  /* ç¡®ä¿å¯¹è¯åŒºåŸŸèƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¯ç”¨ç©ºé—´ */
  flex-grow: 1;
  flex-basis: 0;
}

/* æ¶ˆæ¯åŠ¨ç”»æ•ˆæœ */
.message-animating {
  animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* æ€è€ƒçŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
.thinking-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: #fff7e6;
  border: 1px solid #ffd591;
  border-radius: 8px;
  color: #fa8c16;
  font-style: italic;
  margin-bottom: 12px;
}

/* å¢å¼ºçš„å¯æŠ˜å æ€è€ƒè¿‡ç¨‹æ ·å¼ */
.thinking-process-container {
  margin-bottom: 16px;
  position: relative; /* ç¡®ä¿å®šä½ä¸Šä¸‹æ–‡ */
  z-index: 20; /* è®¾ç½®è¾ƒé«˜çš„z-indexï¼Œç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
}

.enhanced-thinking {
  border-radius: 12px;
  overflow: visible; /* å…è®¸æŠ˜å å†…å®¹å®Œæ•´æ˜¾ç¤º */
  box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1);
  position: relative; /* ç¡®ä¿å®šä½ä¸Šä¸‹æ–‡ */
  z-index: 15; /* è®¾ç½®z-indexå±‚çº§ */
}

.thinking-collapse {
  border: none;
  background: transparent;
  position: relative; /* ç¡®ä¿å®šä½ä¸Šä¸‹æ–‡ */
  z-index: 25; /* è®¾ç½®æœ€é«˜çš„z-index */
}

/* ç¡®ä¿Element PlusæŠ˜å ç»„ä»¶æ­£å¸¸å·¥ä½œ */
.thinking-collapse .el-collapse-item__wrap {
  overflow: visible !important;
  border-bottom: none;
  position: relative !important;
  z-index: 25 !important;
}

.thinking-collapse .el-collapse-item__content {
  padding-bottom: 0;
  overflow: visible !important;
  position: relative !important;
  z-index: 20 !important;
}

/* ç¡®ä¿æŠ˜å ç»„ä»¶çš„ç®­å¤´å›¾æ ‡æ­£å¸¸æ˜¾ç¤ºå’Œç‚¹å‡» */
.thinking-collapse .el-collapse-item__arrow {
  position: relative !important;
  z-index: 40 !important;
  pointer-events: auto !important;
}

/* ç¡®ä¿æ•´ä¸ªæŠ˜å é¡¹å¯ä»¥æ­£å¸¸ç‚¹å‡» */
.thinking-collapse .el-collapse-item {
  position: relative !important;
  z-index: 25 !important;
}

.thinking-collapse .el-collapse-item__header {
  background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
  border: 2px solid #91d5ff;
  border-radius: 12px;
  padding: 16px 20px;
  font-size: 15px;
  color: #1890ff;
  transition: all 0.3s ease;
  min-height: 50px; /* å‡å°æœ€å°é«˜åº¦ï¼Œé€‚åº”åªæ˜¾ç¤ºæ ‡é¢˜çš„æƒ…å†µ */
  position: relative; /* ç¡®ä¿å®šä½ä¸Šä¸‹æ–‡ */
  z-index: 30; /* è®¾ç½®æœ€é«˜çš„z-indexï¼Œç¡®ä¿å¯ç‚¹å‡» */
  cursor: pointer; /* æ˜ç¡®æŒ‡ç¤ºå¯ç‚¹å‡» */
}

.thinking-collapse .el-collapse-item__header:hover {
  background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%);
  border-color: #40a9ff;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(24, 144, 255, 0.15);
}

.thinking-summary {
  display: flex;
  align-items: center;
  gap: 16px;
  width: 100%;
  position: relative; /* ç¡®ä¿å®šä½ä¸Šä¸‹æ–‡ */
  z-index: 35; /* è®¾ç½®æœ€é«˜çš„z-index */
  pointer-events: auto; /* ç¡®ä¿å¯ä»¥æ¥æ”¶ç‚¹å‡»äº‹ä»¶ */
  overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
}

.thinking-icon-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
  border-radius: 50%;
  color: white;
  flex-shrink: 0;
}

.thinking-main-icon {
  font-size: 18px;
}

.thinking-title-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 0; /* å…è®¸å†…å®¹æ”¶ç¼© */
  overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
  max-width: calc(100% - 120px); /* ä¸ºçŠ¶æ€æ ‡ç­¾å’Œå›¾æ ‡ç•™å‡ºç©ºé—´ */
}

.thinking-title {
  font-weight: 600;
  font-size: 16px;
  color: #1890ff;
  white-space: nowrap; /* é˜²æ­¢æ ‡é¢˜æ¢è¡Œ */
  overflow: hidden; /* é˜²æ­¢æ ‡é¢˜æº¢å‡º */
  text-overflow: ellipsis; /* å¦‚æœæ ‡é¢˜è¿‡é•¿åˆ™æ˜¾ç¤ºçœç•¥å· */
  max-width: 100%; /* ç¡®ä¿æ ‡é¢˜ä¸è¶…å‡ºå®¹å™¨ */
}

.thinking-subtitle {
  font-size: 13px;
  color: #8c8c8c;
  font-weight: normal;
  white-space: nowrap; /* é˜²æ­¢å‰¯æ ‡é¢˜æ¢è¡Œ */
  overflow: hidden; /* é˜²æ­¢å‰¯æ ‡é¢˜æº¢å‡º */
  text-overflow: ellipsis; /* å¦‚æœå‰¯æ ‡é¢˜è¿‡é•¿åˆ™æ˜¾ç¤ºçœç•¥å· */
  max-width: 100%; /* ç¡®ä¿å‰¯æ ‡é¢˜ä¸è¶…å‡ºå®¹å™¨ */
  transition: all 0.3s ease; /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
}

.thinking-status {
  flex-shrink: 0;
}

.thinking-content {
  background: #f0f9ff;
  border: 2px solid #91d5ff;
  border-top: none;
  border-radius: 0 0 12px 12px;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #1890ff;
  overflow: visible; /* ç¡®ä¿æ€è€ƒå†…å®¹å®Œæ•´æ˜¾ç¤º */
  max-height: none; /* ç§»é™¤é«˜åº¦é™åˆ¶ */
  position: relative; /* ç¡®ä¿å®šä½ä¸Šä¸‹æ–‡ */
  z-index: 20; /* è®¾ç½®z-indexå±‚çº§ */
}

.enhanced-content {
  padding: 20px;
  overflow: visible; /* ç¡®ä¿å¢å¼ºå†…å®¹å®Œæ•´æ˜¾ç¤º */
  max-height: none; /* ç§»é™¤é«˜åº¦é™åˆ¶ */
}

.thinking-steps {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.thinking-step {
  background: white;
  border-radius: 8px;
  padding: 16px;
  border-left: 4px solid #1890ff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
}

.thinking-step:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transform: translateX(2px);
}

.step-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.step-number {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  background: #1890ff;
  color: white;
  border-radius: 50%;
  font-size: 12px;
  font-weight: bold;
  flex-shrink: 0;
}

.step-title {
  font-weight: 600;
  color: #1890ff;
  font-size: 15px;
}

.step-content {
  color: #262626;
  line-height: 1.6;
  white-space: pre-wrap;
  margin-left: 36px;
  overflow: visible; /* ç¡®ä¿æ­¥éª¤å†…å®¹å®Œæ•´æ˜¾ç¤º */
  word-wrap: break-word; /* é•¿æ–‡æœ¬è‡ªåŠ¨æ¢è¡Œ */
  overflow-wrap: break-word; /* ç°ä»£æµè§ˆå™¨æ”¯æŒ */
}

/* æ‰“å­—æœºæ•ˆæœæ ·å¼ */
.typing-text {
  position: relative;
  line-height: 1.6;
  white-space: pre-wrap;
}

.typing-cursor {
  animation: blink 1s infinite;
  color: #1890ff;
  font-weight: bold;
  display: inline-block;
  width: 2px;
  height: 1.2em;
  background-color: #1890ff;
  margin-left: 2px;
  vertical-align: text-bottom;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

/* å›å¤å†…å®¹æ ·å¼ */
.final-response, .displayed-content, .default-content {
  line-height: 1.6;
  color: var(--iflytek-text-primary);
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* è¿‡æ¸¡æ¶ˆæ¯æ ·å¼ */
.message-item[data-transition="true"] .message-content {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0ea5e9;
  border-radius: 12px;
  padding: 16px;
  margin: 8px 0;
}

.message-item[data-transition="true"] .message-text {
  color: #0369a1;
  font-weight: 500;
  text-align: center;
}

/* å¢å¼ºæ¶ˆæ¯æ ·å¼ */
.message-enhanced .message-text {
  background: #e6f7ff;
  border-left: 3px solid #1890ff;
  border-radius: 8px;
  padding: 12px 16px;
}

/* å“åº”å¼è®¾è®¡ - å¹³æ¿è®¾å¤‡ */
@media (max-width: 1024px) {
  .conversation-section {
    padding: 24px;
    height: calc(100vh - 120px);
    max-width: 100%;
  }

  .messages-container {
    max-height: calc(100vh - 350px); /* ä¸ºå¹³æ¿è®¾å¤‡è®¾ç½®åˆç†çš„æœ€å¤§é«˜åº¦ */
    min-height: 300px; /* å‡å°‘æœ€å°é«˜åº¦ */
  }

  .message-content {
    max-width: 85%;
  }

  .thinking-summary {
    gap: 12px;
  }

  .thinking-title {
    font-size: 15px;
  }

  .thinking-subtitle {
    font-size: 12px;
  }
}

/* å“åº”å¼è®¾è®¡ - ç§»åŠ¨è®¾å¤‡ */
@media (max-width: 768px) {
  .conversation-section {
    padding: 16px;
    height: calc(100vh - 100px);
    border-radius: 8px;
  }

  .messages-container {
    padding: 16px 0;
    gap: 16px;
    max-height: calc(100vh - 280px); /* ä¸ºæ‰‹æœºè®¾å¤‡è®¾ç½®åˆç†çš„æœ€å¤§é«˜åº¦ */
    min-height: 250px; /* å‡å°‘æœ€å°é«˜åº¦ */
  }

  .message-item {
    gap: 8px;
  }

  .message-avatar {
    width: 32px;
    height: 32px;
  }

  .message-content {
    max-width: 90%;
  }

  .message-text {
    padding: 12px 14px;
    font-size: 14px;
    line-height: 1.5;
  }

  .thinking-process-container {
    margin-bottom: 12px;
    z-index: 25 !important; /* ç§»åŠ¨ç«¯ç¡®ä¿æ›´é«˜çš„z-index */
  }

  .thinking-collapse .el-collapse-item__header {
    padding: 12px 16px;
    font-size: 14px;
    min-height: 45px; /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥å‡å°é«˜åº¦ */
    z-index: 35 !important; /* ç§»åŠ¨ç«¯ç¡®ä¿å¯ç‚¹å‡» */
  }

  .thinking-title {
    font-size: 14px; /* ç§»åŠ¨ç«¯å‡å°æ ‡é¢˜å­—ä½“ */
  }

  .thinking-subtitle {
    font-size: 12px; /* ç§»åŠ¨ç«¯å‡å°å‰¯æ ‡é¢˜å­—ä½“ */
  }

  .thinking-summary {
    gap: 10px;
  }

  .thinking-title-content {
    max-width: calc(100% - 100px); /* ç§»åŠ¨ç«¯ä¸ºçŠ¶æ€æ ‡ç­¾ç•™å‡ºæ›´å¤šç©ºé—´ */
  }

  .thinking-icon-wrapper {
    width: 32px;
    height: 32px;
  }

  .thinking-main-icon {
    font-size: 16px;
  }

  .thinking-title {
    font-size: 14px;
  }

  .thinking-subtitle {
    font-size: 11px;
  }

  .thinking-steps {
    gap: 12px;
  }

  .thinking-step {
    padding: 12px;
  }

  .step-number {
    width: 20px;
    height: 20px;
    font-size: 11px;
  }

  .step-title {
    font-size: 14px;
  }

  .step-content {
    margin-left: 28px;
    font-size: 13px;
  }

  .scroll-to-bottom-hint {
    bottom: 16px;
    right: 16px;
  }

  .scroll-to-bottom-hint .el-button {
    padding: 6px 12px;
    font-size: 12px;
  }
}

/* å“åº”å¼è®¾è®¡ - å°å±å¹•ç§»åŠ¨è®¾å¤‡ */
@media (max-width: 480px) {
  .conversation-section {
    padding: 12px;
    height: calc(100vh - 80px);
  }

  .messages-container {
    padding: 12px 0;
    gap: 12px;
    max-height: calc(100vh - 220px); /* ä¸ºå°å±æ‰‹æœºè®¾ç½®åˆç†çš„æœ€å¤§é«˜åº¦ */
    min-height: 200px; /* å‡å°‘æœ€å°é«˜åº¦ */
  }

  .message-content {
    max-width: 95%;
  }

  .message-text {
    padding: 10px 12px;
    font-size: 13px;
  }

  .thinking-collapse .el-collapse-item__header {
    padding: 10px 12px;
    font-size: 13px;
    min-height: 40px; /* å°å±æ‰‹æœºè¿›ä¸€æ­¥å‡å°é«˜åº¦ */
    z-index: 40 !important; /* å°å±æ‰‹æœºç¡®ä¿æœ€é«˜z-index */
  }

  .thinking-title {
    font-size: 13px; /* å°å±æ‰‹æœºè¿›ä¸€æ­¥å‡å°æ ‡é¢˜å­—ä½“ */
  }

  .thinking-subtitle {
    font-size: 11px; /* å°å±æ‰‹æœºè¿›ä¸€æ­¥å‡å°å‰¯æ ‡é¢˜å­—ä½“ */
  }

  .thinking-title-content {
    max-width: calc(100% - 80px); /* å°å±æ‰‹æœºä¸ºçŠ¶æ€æ ‡ç­¾ç•™å‡ºæ›´å¤šç©ºé—´ */
  }

  .thinking-summary {
    gap: 8px; /* å°å±æ‰‹æœºå‡å°é—´è· */
  }

  .thinking-icon-wrapper {
    width: 28px;
    height: 28px;
  }

  .thinking-main-icon {
    font-size: 14px;
  }

  .thinking-title {
    font-size: 13px;
  }

  .thinking-subtitle {
    display: none; /* åœ¨å°å±å¹•ä¸Šéšè—å‰¯æ ‡é¢˜ */
  }

  .enhanced-content {
    padding: 16px;
  }

  .thinking-step {
    padding: 10px;
  }

  .step-content {
    margin-left: 24px;
    font-size: 12px;
  }
}

.thinking-icon {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* æ€è€ƒæ–‡æœ¬ç‰¹æ®Šæ ·å¼ */
.thinking-text {
  position: relative;
  overflow: hidden;
}

.thinking-text::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}

/* æ”¹è¿›æ¶ˆæ¯æ–‡æœ¬æ ·å¼ */
.message-text {
  position: relative;
  transition: all 0.3s ease;
}

.message-item.ai .message-text {
  background: #e6f7ff;
  border-left: 3px solid #1890ff;
}

.message-item.user .message-text {
  background: #f6ffed;
  border-left: 3px solid #52c41a;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .interview-layout {
    flex-direction: column;
    gap: 16px;
  }

  .analysis-panels-container {
    flex-direction: column;
    height: auto;
    min-height: 300px;
  }

  .conversation-section {
    min-height: calc(100vh - 180px);
    max-height: calc(100vh - 180px);
    padding: 16px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
  }

  .messages-container {
    min-height: 250px; /* ç§»åŠ¨ç«¯å‡å°‘æœ€å°é«˜åº¦ */
    max-height: calc(100vh - 300px); /* ç§»åŠ¨ç«¯è®¾ç½®åˆç†çš„æœ€å¤§é«˜åº¦ */
  }

  .current-question-panel {
    padding: 12px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
    max-height: 160px; /* ç§»åŠ¨ç«¯å‡å°‘æœ€å¤§é«˜åº¦ */
  }

  .answer-input-panel {
    max-height: 180px; /* ç§»åŠ¨ç«¯å‡å°‘æœ€å¤§é«˜åº¦ */
  }

  .message-content {
    max-width: 85%;
  }
}



.status-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: #f5f5f5;
  border-radius: 6px;
  font-size: 12px;
  color: #8c8c8c;
}

.status-item.active {
  background: #e6f7ff;
  color: #1890ff;
}



.metric-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
}

.metric-label {
  color: #8c8c8c;
}

.metric-value {
  color: #262626;
  font-weight: 500;
}

.candidate-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.candidate-basic {
  text-align: center;
}

.candidate-name {
  font-size: 16px;
  font-weight: 600;
  color: #262626;
  margin-bottom: 4px;
}

.candidate-position {
  font-size: 14px;
  color: #8c8c8c;
}

.skills-label {
  font-size: 12px;
  color: #8c8c8c;
  margin-bottom: 8px;
}

.skills-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

/* å³ä¾§é—®é¢˜æ§åˆ¶é¢æ¿æ ·å¼ */
.question-control-section {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 0;
}

.current-question-panel {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 16px;
  padding: 20px;
  color: white;
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.question-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.question-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.question-content {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 16px;
  backdrop-filter: blur(10px);
}

.question-text {
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 12px;
}

.question-meta {
  display: flex;
  gap: 12px;
  font-size: 14px;
  opacity: 0.9;
}

.quick-actions-panel {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  border: 1px solid #f0f0f0;
}

.actions-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
  color: #262626;
}

.actions-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.actions-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.question-navigation,
.interview-controls {
  padding: 16px;
  background: #fafafa;
  border-radius: 12px;
}

.nav-title,
.controls-title {
  font-size: 14px;
  font-weight: 600;
  color: #262626;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.question-buttons {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  max-width: 280px;
  align-items: center;
  justify-items: center;
}

.question-nav-btn {
  width: 40px;
  height: 32px;
  min-width: 40px;
  max-width: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  font-size: 14px;
  font-weight: 500;
}

.control-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* å³ä¾§å€™é€‰äººä¿¡æ¯é¢æ¿æ ·å¼ */
.candidate-info-panel {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  border: 1px solid #f0f0f0;
}

.candidate-info-panel .panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f0f0f0;
}

.candidate-info-panel .panel-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #262626;
  display: flex;
  align-items: center;
  gap: 8px;
}

.candidate-info-panel .candidate-info {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.candidate-info-panel .candidate-basic {
  text-align: center;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
}

.candidate-info-panel .candidate-name {
  font-size: 18px;
  font-weight: 600;
  color: #262626;
  margin-bottom: 8px;
}

.candidate-info-panel .candidate-stats {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #8c8c8c;
  margin-top: 8px;
}

.candidate-info-panel .candidate-skills .skills-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
}

/* åº•éƒ¨åˆ†æé¢æ¿æ ·å¼ - é‡æ–°è®¾è®¡ */
.bottom-analysis-section {
  margin-top: 8px;
  padding: 16px;
  background: #f8f9fa;
  border-top: 1px solid #e9ecef;
  width: 100%;
  overflow-x: auto;
}

/* å…¨å®½åˆ†æå®¹å™¨ */
.full-width-analysis-container {
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

/* å…¨å®½é¢æ¿æ ·å¼ */
.full-width-panel {
  width: 100%;
}

.full-width-panel .panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #f0f0f0;
}

.full-width-panel .header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.full-width-panel .header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* å¢å¼ºçš„è¯„åˆ†å¸ƒå±€ */
.enhanced-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
}

.score-column {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* å³ä¾§é¢æ¿æ ·å¼ */
.right-side-panel {
  margin-top: 16px;
  background: white;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid #e9ecef;
  transition: all 0.3s ease;
}

.right-side-panel:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
}

.right-side-panel .panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f0f0f0;
}

.right-side-panel .panel-header h4 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: #262626;
  display: flex;
  align-items: center;
  gap: 8px;
}

.right-side-panel .spark-icon {
  color: #1890ff;
  font-size: 16px;
}

.right-side-panel .processing-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.right-side-panel .stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
  text-align: center;
}

.right-side-panel .stat-label {
  font-size: 11px;
  color: #8c8c8c;
  margin-bottom: 4px;
}

.right-side-panel .stat-value {
  font-size: 14px;
  font-weight: 600;
  color: #1890ff;
}

.analysis-panels-container {
  display: flex;
  flex-direction: row;
  gap: 16px;
  max-width: 1400px;
  margin: 0 auto;
  align-items: stretch;
  width: 100%;
  height: calc(40vh - 60px); /* å ç”¨å‰©ä½™ç©ºé—´ */
  min-height: 200px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 20px;
  box-shadow:
    0 8px 32px rgba(0, 0, 0, 0.12),
    0 2px 8px rgba(0, 0, 0, 0.08),
    inset 0 1px 0 rgba(255, 255, 255, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.analysis-panel {
  background: white;
  border-radius: 12px;
  padding: 16px; /* å‡å°‘å†…è¾¹è· */
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  border: 1px solid #e9ecef;
  transition: all 0.3s ease;
  min-height: 160px; /* å‡å°‘æœ€å°é«˜åº¦ */
  flex: 1; /* è®©é¢æ¿è‡ªé€‚åº”é«˜åº¦ */
}

.analysis-panel:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
}

/* å·¦ä¾§å®æ—¶åˆ†æçŠ¶æ€é¢æ¿ - è¾ƒçª„ */
.status-panel {
  flex: 0 0 280px;
  min-width: 280px;
}

/* å³ä¾§æ–‡æœ¬åˆ†æç»“æœé¢æ¿ - è¾ƒå®½ */
.results-panel {
  flex: 1;
  min-width: 350px;
}

.analysis-panel .panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px; /* å‡å°‘åº•éƒ¨é—´è· */
  padding-bottom: 12px; /* å‡å°‘å†…è¾¹è· */
  border-bottom: 2px solid #f0f0f0;
}

.analysis-panel .panel-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #262626;
  display: flex;
  align-items: center;
  gap: 8px;
}

.analysis-panel .panel-header .el-icon {
  color: #1890ff;
  font-size: 18px;
}

.status-panel .status-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #52c41a;
  animation: pulse 2s infinite;
}

.processing-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 8px;
}

.stat-label {
  font-size: 12px;
  color: #8c8c8c;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 16px;
  font-weight: 600;
  color: #1890ff;
}

.results-panel .score-breakdown {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.score-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

.score-name {
  font-size: 12px;
  color: #8c8c8c;
  min-width: 60px;
}

.score-bar {
  flex: 1;
  height: 6px;
  background: #f0f0f0;
  border-radius: 3px;
  overflow: hidden;
}

.score-fill {
  height: 100%;
  background: linear-gradient(90deg, #1890ff, #52c41a);
  transition: width 0.3s ease;
}

.score-value {
  font-size: 12px;
  font-weight: 600;
  color: #262626;
  min-width: 30px;
  text-align: right;
}



@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* å“åº”å¼è®¾è®¡ - æ–°å¸ƒå±€é€‚é… */
@media (max-width: 1200px) {
  .enhanced-layout {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .question-control-section {
    width: 100%;
    padding: 0 10px;
  }
}

@media (max-width: 768px) {
  .full-width-analysis-container {
    padding: 0 8px;
  }

  .full-width-panel {
    padding: 12px;
  }

  .full-width-panel .panel-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .right-side-panel .processing-stats {
    grid-template-columns: 1fr;
    gap: 8px;
  }

  .right-side-panel .stat-item {
    padding: 12px 8px;
  }

  .enhanced-layout {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .score-column {
    gap: 12px;
  }
}
</style>
